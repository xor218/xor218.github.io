---
layout: post
author: "大西瓜"
title: "traceroute"
date:   2024-05-05 10:47:23 +0800
categories: [update,LinuxCommand] 
---
```
TRACEROUTE(8) 系统管理员手册 TRACEROUTE(8)

姓名
     traceroute - 打印数据包到网络主机的路径

说明
     traceroute [-adeEFISdNnrvx] [-A as_server] [-f first_ttl] [-g gateway] [-i iface] [-M first_ttl] [-m max_ttl］
                [-P proto] [-p port] [-q nqueries] [-s src_addr] [-t tos] [-w waittime] [-z pausemsecs] host
                [数据包大小]

说明
     互联网是一个庞大而复杂的网络硬件集合体，通过网关连接在一起。  跟踪
     或找到丢弃你的数据包的不法网关）可以
     traceroute利用IP协议的 "生存时间 "字段，并试图诱发ICMP TIME_EXCEEDED。
     从沿路径的每个网关到某个主机的响应。

     唯一的必选参数是目标主机名或 IP 号。  默认探测数据报长度为 40
     字节，但可以通过在目标主机名后指定数据包大小（以字节为单位）来增加数据包大小。

     其他选项包括

     -a 为遇到的每一跳开启 AS# 查找。-A as_server
             打开 AS# 查找，使用指定服务器而不是默认服务器。

     -d 启用套接字级调试。

     -D 当收到对探测数据报的 ICMP 响应时，打印所传输的数据报与探测数据报之间的差值。
             数据包和 ICMP 响应所引用的数据包。  显示字段在
             传输的数据包会被打印出来，然后是以十六进制表示的原始数据包，接着是以十六进制表示的引用数据包。
             十六进制。  引用数据包中不变的字节用下划线表示。  注意，IP 校验和与
             的 TTL 不匹配。  默认情况下，每跳只发送一个探针，并使用
             此选项。

     -E 检测 ECN 漂白。  设置 IPTOS_ECN_ECT1 位，并报告该值是否被漂白或篡改。

     -e 防火墙规避模式。  为 UDP 和 TCP 探测使用固定的目标端口。  目标端口不
             不随每个数据包的发送而递增。

     -f first_ttl
             设置第一个传出探测数据包中使用的初始生存时间。

     -F 设置 "不分片 "位。

     -g 网关
             指定一个松散的源路由网关（最多 8 个）。

     -i iface
             指定一个网络接口，用于获取传出探测数据包的源 IP 地址。这通常是
             仅在多主机上有用。(另一种方法请参见 -s 标志）。

     -I 使用 ICMP ECHO 代替 UDP 数据报。  (与"-P icmp "同义）。-M first_ttl
             设置传出探测数据包中使用的初始生存时间值。  默认值为 1，即从
             第一跳。

     -m max_ttl
             设置传出探测数据包中使用的最大生存时间（最大跳数）。  默认值为
             net.inet.ip.ttl 跳数（与 TCP 连接使用的默认值相同）。

     -n 以数字方式而不是符号和数字方式打印跳转地址（保存一个名称服务器地址到
             路径上找到的每个网关的名称查询）。

     -P 原型
             发送指定 IP 协议的数据包。目前支持的协议有UDP 、TCP 、GRE 和 ICMP
             也可指定其他协议（通过名称或编号），但 traceroute 并不实现
             对其数据包格式有任何特殊了解。该选项有助于确定沿
             路径可能会根据 IP 协议号阻止数据包。但请参阅下面的 BUGS。

     -p 端口
             特定协议。对于 UDP 和 TCP，设置探测中使用的基本端口号（默认为 33434）。
             traceroute 希望目标主机的 UDP 端口 base 至 base+nhops-1 之间没有任何监听（因此
             将返回 ICMP PORT_UNREACHABLE 消息以终止路由跟踪）。  如果出现
             该选项可用于选择一个未使用的端口范围。

     -q nqueries
             将每个 ``ttl'' 的探测次数设为 nqueries（默认为三个探测次数）。

     -绕过正常路由表，直接发送到连接网络上的主机。  如果主机不是
             则会返回错误信息。  该选项可用于 ping 本地主机
             通过一个没有路由的接口（例如，被 routed(8) 掉线的接口）。-src_addr
             使用以下 IP 地址（必须是 IP 号，而不是主机名）作为源地址
             在传出的探测数据包中。  在有多个 IP 地址的主机上，该选项可用于强制
             源地址，而不是探测数据包发送接口的 IP 地址。
             如果 IP 地址不是本机的接口地址，则会返回错误信息，并且不会执行任何操作。
             发送。  (另一种方法见 -i 标志）。

     -S 打印每次跳转未应答的探测次数汇总。

     -t tos 将探测数据包中的服务类型设置为以下值（默认为零）。  该值必须是
             范围在 0 至 255 之间的十进制整数。  该选项可用于查看不同的服务类型是否有差异。
             会导致路径不同。  (如果您运行的不是 4.4BSD 或更高版本的系统，这可能是个学术问题，因为
             正常的网络服务（如 telnet 和 ftp）不允许你控制 TOS）。  并非所有的 TOS 值都能
             是合法的还是有意义的--参见 IP 规范中的定义。  有用的值可能是"-t 16"（低
             延迟）和"-t 8"（高吞吐量）。

     -v 冗余输出。  会列出除 TIME_EXCEEDED 和 UNREACHABLE 之外的接收到的 ICMP 数据包。

     -w 设置等待探针响应的时间（秒）（默认为 5 秒）。

     -x 切换 IP 校验和。通常，这会阻止 traceroute 计算 IP 校验和。在某些情况下
             操作系统可以覆盖传出数据包的部分内容，但不能重新计算校验和（所以在某些情况下
             默认情况下不计算校验和，使用 -x 会导致计算校验和）。请注意
             在使用 ICMP ECHO 探测 ( -I ) 时，最后一跳通常需要校验和。因此，它们总是
             在使用 ICMP 时计算。-z pausemsecs
             设置两次探测之间的暂停时间（以毫秒为单位）（默认为 0）。  某些系统，如 Solaris 和
             路由器（如 Ciscos）的 ICMP 报文速率限制。一个好的值是 500（例如 1/2 秒）。

     该程序通过启动 UDP 探测器，尝试追踪 IP 数据包到达某个互联网主机的路径。
     然后监听网关的 ICMP "超时 "回复。  我们
     开始探测时的 ttl 为 1，然后逐次增加，直到收到 ICMP "端口不可达"（这表示我们
     为 "host"）或达到最大值（默认为 net.inet.ip.ttl 跳数，可使用 -m 标志更改）。  三个
     探针（使用 -q 标志更改）在每个 ttl 设置下发送，并打印一行，显示 ttl 和
     每个探针的网关和往返时间。  如果探测应答来自不同的网关，则会显示
     将打印每个响应的系统。  如果在 5 秒的超时时间间隔内（用
     标志），该探针将被打印为 "*"。

     我们不希望目的主机处理 UDP 探测数据包，因此将目的端口设置为不可能处理的端口。
     值（如果目的地的某些模块正在使用该值，则可以使用 -p 标志进行更改）。

     使用和输出示例如下

     [yak 71]% traceroute nis.nsf.net.
     traceroute 至 nis.nsf.net (35.1.1.48)，最大 64 跳，38 字节数据包
     1 helios.ee.lbl.gov (128.3.112.1) 19 ms 19 ms 0 ms
     2 lilac-dmc.Berkeley.EDU (128.32.216.1) 39 ms 39 ms 19 ms
     3 lilac-dmc.Berkeley.EDU (128.32.216.1) 39 ms 39 ms 19 ms
     4 ccngw-ner-cc.Berkeley.EDU (128.32.136.23) 39 ms 40 ms 39 ms
     5 ccn-nerif22.Berkeley.EDU (128.32.168.22) 39 ms 39 ms 39 ms
     6 128.32.197.4 (128.32.197.4) 40 ms 59 ms 59 ms
     7 131.119.2.5 (131.119.2.5) 59 ms 59 ms 59 ms
     8 129.140.70.13 (129.140.70.13) 99 ms 99 ms 80 ms
     9 129.140.71.6 (129.140.71.6) 139 ms 239 ms 319 ms
     10 129.140.81.7 (129.140.81.7) 220 ms 199 ms 199 ms
     11 nic.merit.edu (35.1.1.48) 239 ms 239 ms 239 ms

     请注意，第 2 行和第 3 行是相同的。  这是由于第 2 跳系统 - lbl-csam.arpa - 的内核存在错误，导致出现以下情况
     转发 0 ttl 的数据包（4.3 BSD 分布式版本中的一个错误）。  请注意，您必须猜测
     由于 NSFNet (129.140) 不提供地址到名称的转换，因此数据包走的是跨国路径
     为其国家统计系统。一个更有趣的例子是

     [yak 72]% traceroute allspice.lcs.mit.edu.
     traceroute 至 allspice.lcs.mit.edu (18.26.0.115)，最大 64 跳
     1 helios.ee.lbl.gov (128.3.112.1) 0 ms 0 ms 0 ms
     2 lilac-dmc.Berkeley.EDU (128.32.216.1) 19 ms 19 ms 19 ms
     3 lilac-dmc.Berkeley.EDU (128.32.216.1) 39 ms 19 ms 19 ms
     4 ccngw-ner-cc.Berkeley.EDU (128.32.136.23) 19 ms 39 ms 39 ms
     5 ccn-nerif22.Berkeley.EDU (128.32.168.22) 20 ms 39 ms 39 ms
     6 128.32.197.4 (128.32.197.4) 59 ms 119 ms 39 ms
     7 131.119.2.5 (131.119.2.5) 59 ms 59 ms 39 ms
     8 129.140.70.13 (129.140.70.13) 80 ms 79 ms 99 ms
     9 129.140.71.6 (129.140.71.6) 139 ms 139 ms 159 ms
     10 129.140.81.7 (129.140.81.7) 199 ms 180 ms 300 ms
     11 129.140.72.17 (129.140.72.17) 300 ms 239 ms 239 ms
     12 * * *
     13 128.121.54.72 (128.121.54.72) 259 ms 499 ms 279 ms
     14 * * *
     15 * * *
     16 * * *
     17 * * *
     18 ALLSPICE.LCS.MIT.EDU (18.26.0.115) 339 ms 279 ms 279 ms

     请注意，距离 12、14、15、16 和 17 跳的网关要么不发送 ICMP "超时 "信息，要么发送它们
     由于 ttl 太小而无法到达我们。  14 - 17 正在运行麻省理工学院的 C 网关代码，它不会发送 "超时 "信息。
     天知道 12 号发生了什么。
上述中的无声网关 12 可能是 4.BSD 网络代码（及其
     导数）：  4.x (x <= 3) 使用原始数据报中剩余的任何 ttl 发送不可达信息。
     由于网关的剩余 ttl 为零，因此 ICMP "超过时间 "保证不会返回给我们。
     当这一错误出现在目标系统上时，其行为会稍微有趣一些：

     1 helios.ee.lbl.gov (128.3.112.1) 0 ms 0 ms 0 ms
     2 lilac-dmc.Berkeley.EDU (128.32.216.1) 39 ms 19 ms 39 ms
     3 lilac-dmc.Berkeley.EDU (128.32.216.1) 19 ms 39 ms 19 ms
     4 ccngw-ner-cc.Berkeley.EDU (128.32.136.23) 39 ms 40 ms 19 ms
     5 ccn-nerif35.Berkeley.EDU (128.32.168.35) 39 ms 39 ms 39 ms
     6 csgw.Berkeley.EDU (128.32.133.254) 39 ms 59 ms 39 ms
     7 * * *
     8 * * *
     9 * * *
     10 * * *
     11 * * *
     12 * * *
     13 rip.Berkeley.EDU (128.32.131.22) 59 ms ！  39 ms ！  39 ms ！

     请注意，这里有 12 个 "网关"（13 个是最终目的地），而其中的后一半正好是
     "丢失"。  实际情况是，rip（运行 Sun OS3.5 的 Sun-3）正在使用我们到达的ttl
     数据报作为其 ICMP 回复中的 ttl。  因此，回复将在返回路径上超时（没有向
     因为 ICMP 不会为 ICMP 发送），直到我们使用至少是路径长度两倍的 ttl 进行探测。
     也就是说，rip 其实只有 7 个跳。  如果回复的 ttl 为 1，就说明存在这个问题。
     如果 ttl <= 1，traceroute 会在时间后打印"！"。  由于供应商出货了大量过时的产品（DEC 的 Ultrix.NX 和 DEC 的 Ultrix.NX），traceroute 会在时间之后打印"!
     Sun 3.x）或非标准（HPUX）软件，可能会经常出现此问题，和/或在出现此问题时采取以下措施
     探测的目标主机。

     时间后可能出现的其他注释包括 !H、 !N 或 !P（主机、网络或协议不可达）、 !S（源代码
     路由失败）、（需要分片 - 显示 RFC1191 路径 MTU 发现值）、 !U 或 !W（目的地
     网络/主机未知）、 !I（源主机已被隔离）、 !A（与目标网络的通信以管理方式进行
     禁止）、 !Z（行政上禁止与目的主机通信）、 !Q（对于该 ToS
     目的网络不可达）、 !T（对于此 ToS，目的主机不可达）、 !X（通信
     行政禁止）、 !V（违反主机优先级）、 !C（生效的优先级截止）或 !<num>（ICMP
     不可到达代码 <num>）。  这些代码由 RFC1812（取代 RFC1716）定义。  如果几乎所有探测
     结果是无法到达，traceroute 就会放弃并退出。该程序用于网络测试、测量和管理。  它主要用于
     手动故障隔离。  由于可能对网络造成负荷，使用 traceroute 是不明智的。
     在正常运行期间或通过自动脚本进行。

作者
     由 Van Jacobson 根据 Steve Deering 的建议实现。  由数以千计的
     菲利普-伍德（C. Philip Wood）、蒂姆-西弗（Tim Seaver）和肯-阿德尔曼（Ken Adelman）提出了特别有说服力的建议或修正意见。

另见
     netstat(1)、ping(8)、traceroute6(8)

BUGS
     在使用 UDP 以外的协议时，功能会有所降低。  特别是，最后一个数据包通常会出现
     会丢失，因为即使它到达了目的主机，也无法知道，因为没有 ICMP
     信息被发回。  在 TCP 情况下，traceroute 应侦听来自目标主机的 RST（或一个
     过滤数据包的中间路由器），但目前尚未实现。

     AS 编号功能报告的信息有时可能不准确，原因是 AS 和 AS 编号之间存在差异。
     路由数据库服务器的内容和互联网的当前状态。

BSD 4.3 2008 年 5 月 29 日 BSD 4.3

```