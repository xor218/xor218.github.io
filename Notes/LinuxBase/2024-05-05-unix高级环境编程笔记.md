---
layout: post
author: "å¤§è¥¿ç“œ"
title: "unixé«˜çº§ç¯å¢ƒç¼–ç¨‹ç¬”è®°"
date:   2024-05-05 16:00:13 +0800
categories: [update,LinuxBase] 
---
##  UCçš„èµ·æ­¥

![](allPic/Macdo2023-04-04 09.17.28.jpg)



![](allPic/Macdo2023-04-04 09.49.58.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-04 09.54.34.jpg)

unixé«˜çº§ç¼–ç¨‹

### ç¨‹åºçš„ç¼–è¯‘è¿‡ç¨‹

```bash
gcc -E main.c -o main.i  #é¢„å¤„ç†
```

```bash
gcc -S hello.i -o hello.s  # ç¼–è¯‘ ç”Ÿæˆæ±‡ç¼–è¯­è¨€ è¯­æ³•é”™è¯¯æ£€æŸ¥
```

```
gcc -c hello.s -o hello.o  #
```

```
gcc hello.o       #é“¾æ¥
```



### é¢„å¤„ç†æŒ‡ä»¤

 å¸¦#çš„é¢„å¤„ç†æŒ‡ä»¤

å®å®šä¹‰

æ¡ä»¶ç¼–è¯‘

æ–‡ä»¶çš„åŒ…å«



## å¤šæ¨¡å—å¼€å‘

#### æŠŠå¤§å‹é¡¹ç›®åˆ†å‰²ä¸ºå¤šä¸ªæ¨¡å—

```yaml
å¤´æ–‡ä»¶åº”è¯¥åŒ…å«çš„å†…å®¹
  å¤´æ–‡ä»¶å«å£«  #ifndef é¿å…æ–‡ä»¶çš„é‡å¤åŒ…å«
  ç±»å‹çš„å®šä¹‰	 #ç»“æ„çš„å®šä¹‰  typedef
  æ–‡ä»¶çš„åŒ…å«		#å¤´æ–‡ä»¶çš„åŒ…å« 
  å®å®šä¹‰			#
  æ¡ä»¶ç¼–è¯‘		#ifdnef
  å‡½æ•°å£°æ˜		# ç±»ä¼¼äº
  å˜é‡çš„å£°æ˜  #å˜é‡çš„å£°æ˜å’Œå®šä¹‰æ˜¯ä¸¤ä¸ªæ¦‚å¿µ å£°æ˜ä¸åˆ†é…ç©ºé—´(ä½œç”¨äºçš„æ‰©å……) å˜é‡çš„å®šä¹‰æ˜¯éœ€è¦åˆ†é…ç©ºé—´çš„
```



å•ä¸ªæ¨¡å—æ£€æŸ¥è‡ªå·±,ä¼šç”Ÿæˆ.oæ–‡ä»¶ã€‚æœºå™¨ç 

```bash
gcc -c add.c
```

```bash
file main.o #å¯ä»¥é‡å®šä½çš„
main.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), not stripped
```

```bash
file a.out #å¯ä»¥æ‰§è¡Œçš„
ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=25c6dc8b5f98f80410210f35e84c5d56bd2d4a0b, for GNU/Linux 3.2.0, not stripped
```

#### nm å‘½ä»¤æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶çš„ç¬¦å·è¡¨

ç¬¦å·è¡¨: `å‡½æ•°çš„åå­—`,` å…¨å±€å˜é‡çš„åå­—`,` é™æ€å˜é‡çš„åå­—`

- Tï¼šè¯¥ç¬¦å·ä¸ºå‡½æ•°ç¬¦å·ï¼Œå³å¯æ‰§è¡Œä»£ç ã€‚åœ¨ä»£ç æ®µï¼›
- tï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°å‡½æ•°ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„å‡½æ•°ã€‚
- Dï¼šè¯¥ç¬¦å·ä¸ºæ•°æ®ç¬¦å·ï¼Œå³å¯è¯»å†™æ•°æ®ã€‚
- dï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°æ•°æ®ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„æ•°æ®ã€‚
- Bï¼šè¯¥ç¬¦å·ä¸ºæœªåˆå§‹åŒ–æ•°æ®ç¬¦å·ï¼Œå³å¯è¯»å†™çš„æ•°æ®æ®µçš„ä¸€éƒ¨åˆ†ã€‚
- bï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°æœªåˆå§‹åŒ–æ•°æ®ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„æœªåˆå§‹åŒ–æ•°æ®ã€‚
- Uï¼šè¯¥ç¬¦å·ä¸ºæœªå®šä¹‰ç¬¦å·ï¼Œå³éœ€è¦åœ¨é“¾æ¥æ—¶ä»å…¶ä»–æ¨¡å—ä¸­è§£æå¾—åˆ°çš„ç¬¦å·ã€‚
- S ï¼šç¬¦å·è¡¨ç¤ºè¢«æ ‡è®°ä¸ºé™æ€çš„ç¬¦å·
- C ï¼šç¬¦å·è¡¨ç¤ºè¢«æ ‡è®°ä¸ºå¸¸è§„ï¼ˆå…¨å±€ï¼‰çš„ç¬¦å·
- `w`ï¼šè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå…¨å±€å¼±ç¬¦å·ã€‚
- `W`ï¼šè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå¼±ç¬¦å·ï¼Œä½†æ˜¯è¯¥ç¬¦å·å®šä¹‰åœ¨å¦ä¸€ä¸ªå¯é‡å®šä½æ–‡ä»¶ä¸­ã€‚
- `v`ï¼šè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå±€éƒ¨å¼±ç¬¦å·ï¼Œå³åªåœ¨æ–‡ä»¶å†…éƒ¨å¯è§

`Tä»£è¡¨æœ‰å®šä¹‰`

```bash
loc_Ubuntu:nm add.o		T ä»£è¡¨æœ‰å®šä¹‰
0000000000000000 T t_add
0000000000000018 T t_sub
```

`Uä»£è¡¨ä¸ºå®šä¹‰çš„`

```bash
loc_Ubuntu:nm main.o
0000000000000000 T main
                 U printf
                 U t_add
                 U t_mul
```

``

U ç¬¦å·æ²¡æœ‰åœ°å€ è¯´æ˜åœ¨é“¾æ¥è¿‡ç¨‹ä¸­éœ€è¦ä»å…¶ä»–å¯¹è±¡æ–‡ä»¶ä¸­è§£æ

```bash
#: gcc -c main.c -o main.o
#: nm main.o
                 U _arr     		//æ²¡æœ‰åœ°å€ è¯´æ˜éœ€è¦é“¾æ¥çš„æ—¶å€™éœ€è¦ä»å…¶ä»–æ–‡ä»¶ä¸­æˆ–è€…åº“æ–‡ä»¶ä¸­è§£æ                     
0000000000000000 T _func2      
0000000000000050 T _main
                 U _printf                       
                 U _showarr_2o
00000000000000b0 s l_.str
0000000000000000 t ltmp0
00000000000000b0 s ltmp1  
00000000000000c0 s ltmp2
#: 
```



```bash
loc_Ubuntu:nm a.out 
000000000000038c r __abi_tag
0000000000004010 B __bss_start
0000000000004010 b completed.0
                 w __cxa_finalize@GLIBC_2.2.5
0000000000004000 D __data_start
0000000000004000 W data_start
0000000000001090 t deregister_tm_clones
0000000000001100 t __do_global_dtors_aux
0000000000003dc0 d __do_global_dtors_aux_fini_array_entry
0000000000004008 D __dso_handle
0000000000003dc8 d _DYNAMIC
0000000000004010 D _edata
0000000000004018 B _end
0000000000001220 T _fini
0000000000001140 t frame_dummy
0000000000003db8 d __frame_dummy_init_array_entry
00000000000021a0 r __FRAME_END__
0000000000003fb8 d _GLOBAL_OFFSET_TABLE_
                 w __gmon_start__
0000000000002024 r __GNU_EH_FRAME_HDR
0000000000001000 T _init
0000000000002000 R _IO_stdin_used
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 U __libc_start_main@GLIBC_2.34
0000000000001177 T main
                 U printf@GLIBC_2.2.5
00000000000010c0 t register_tm_clones
0000000000001060 T _start
0000000000001149 T t_add
0000000000001209 T t_div
0000000000004010 D __TMC_END__
00000000000011f2 T t_mul
0000000000001161 T t_sub
```

æµ‹è¯•ç”¨

```c
//file delete.c
int a=4;
static float b=5.;

int fuck(){
    static int temp=10;
    return 1;
}

static int sayhello(){
    return 3;
}

//loc_Ubuntu:	gcc -c delete.c 
//loc_Ubuntu:	nm delete.o

/*
0000000000000000 D a					//è¯¥ç¬¦å·ä¸ºæ•°æ®ç¬¦å·ï¼Œå³å¯è¯»å†™æ•°æ®ã€‚
0000000000000004 d b					//dï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°æ•°æ®ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„æ•°æ®ã€‚
0000000000000000 T fuck				//Tï¼šè¯¥ç¬¦å·ä¸ºå‡½æ•°ç¬¦å·ï¼Œå³å¯æ‰§è¡Œä»£ç ã€‚
0000000000000008 d temp.0	  	//å‡½æ•°å†…çš„é™æ€å˜é‡
000000000000000f t sayhello	 	//tï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°å‡½æ•°ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„å‡½æ•°ã€‚
*/

é™æ€é“¾æ¥

```



#### include <> å’Œ ""åŒºåˆ«

åœ¨è¿›è¡Œé¢„å¤„ç†çš„æ—¶å€™

`gcc -E main.c -o main.i -v`  è¦é¢„å¤„ç†çš„æ—¶å€™ å‚æ•°vå¯ä»¥æ˜¾ç¤ºå¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶å¯»æ‰¾çš„è¿‡ç¨‹



#### GDBè°ƒè¯•å™¨çš„ä½¿ç”¨

åœ¨gcc ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Šå‚æ•°-g

`gcc main.c add.c sub.c -g` å¯ä»¥ç”Ÿæˆå¸¦æœ‰è°ƒè¯•ä¿¡æ¯çš„ç”Ÿæˆæ–‡ä»¶

`ggdb  a.out`

```bash
loc_Ubuntu:file a.out 
a.out: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=eabd4e116754f8650739045c5f27a9340be4cc05, for GNU/Linux 3.2.0, with debug_info, not stripped 

//with debug_info

```

```
l æ‰“å°ä»£ç 
2 break è¡Œå·ç  æˆ–è€…å‡½æ•°
3 run è¿è¡Œä»£ç 
4 n  xiaä¸€æ­¥
5 set x= 6 è®¾ç½®å˜é‡
6 s ç»§ç»­æ‰§è¡Œ
7 p å˜é‡  print å˜é‡
8 é€€å‡º



```



`GDBæ˜¯ä¸€æ¬¾å¼ºå¤§çš„å‘½ä»¤è¡Œè°ƒè¯•å·¥å…·ï¼Œå…¶å‘½ä»¤ä¼—å¤šï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„GDBå‘½ä»¤ï¼š`

1. å¯åŠ¨ç¨‹åºï¼š`gdb <executable>`æˆ–`gdb --args <executable> <arguments>`
2. è®¾ç½®æ–­ç‚¹ï¼š`break`æˆ–`b`å‘½ä»¤ï¼Œä¾‹å¦‚`break function_name`æˆ–`b *address`
3. æŸ¥çœ‹æ–­ç‚¹ï¼š`info breakpoints`å‘½ä»¤
4. åˆ é™¤æ–­ç‚¹ï¼š`delete`æˆ–`d`å‘½ä»¤ï¼Œä¾‹å¦‚`delete breakpoint_number`æˆ–`d *address`
5. å•æ­¥æ‰§è¡Œï¼š`next`æˆ–`n`å‘½ä»¤
6. é€è¿‡ç¨‹æ‰§è¡Œï¼š`step`æˆ–`s`å‘½ä»¤     è¿›å…¥å‡½æ•°é‡Œé¢
7. ç»§ç»­æ‰§è¡Œï¼š`continue`æˆ–`c`å‘½ä»¤
8. æŸ¥çœ‹ç¨‹åºçŠ¶æ€ï¼š`info program`å‘½ä»¤
9. æŸ¥çœ‹æ ˆå¸§ä¿¡æ¯ï¼š`info frame`å‘½ä»¤
10. æŸ¥çœ‹å±€éƒ¨å˜é‡å€¼ï¼š`print`æˆ–`p`å‘½ä»¤ï¼Œä¾‹å¦‚`print var_name`
11. æŸ¥çœ‹å¯„å­˜å™¨å€¼ï¼š`info registers`å‘½ä»¤
12. ä¿®æ”¹å˜é‡å€¼ï¼š`set`å‘½ä»¤ï¼Œä¾‹å¦‚`set var_name = new_value`
13. æŸ¥çœ‹å†…å­˜å†…å®¹ï¼š`x`å‘½ä»¤ï¼Œä¾‹å¦‚`x/nfu address`ï¼Œå…¶ä¸­nä¸ºæ˜¾ç¤ºçš„å­—èŠ‚æ•°ï¼Œfä¸ºæ˜¾ç¤ºæ ¼å¼ï¼Œuä¸ºå•å…ƒé•¿åº¦ï¼ˆå­—èŠ‚ã€å­—æˆ–åŒå­—ï¼‰
14. æŸ¥çœ‹æºä»£ç ï¼š`list`æˆ–`l`å‘½ä»¤ï¼Œä¾‹å¦‚`list line_number`æˆ–`l function_name`
15. è¿è¡Œæ—¶è°ƒè¯•ï¼š`attach`å‘½ä»¤ï¼Œä¾‹å¦‚`attach <pid>`
16. æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€ï¼š`info threads`å‘½ä»¤
17. åˆ‡æ¢çº¿ç¨‹ï¼š`thread`æˆ–`t`å‘½ä»¤ï¼Œä¾‹å¦‚`thread thread_number`æˆ–`t thread_number`
18. æŸ¥çœ‹å¸®åŠ©ï¼š`help`æˆ–`h`å‘½ä»¤ï¼Œä¾‹å¦‚`help break`æˆ–`h break`



#### ç¯å¢ƒå˜é‡

ç¯å¢ƒå˜é‡ å¯ä»¥è¢«å­è¿›ç¨‹ç»§æ‰¿çš„å˜é‡

`bashè¿›ç¨‹å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œè„šæœ¬æ–‡ä»¶  ~/.bashrc`

è‡ªå®šä¹‰å˜é‡

1. envæŸ¥çœ‹bashè¿›ç¨‹çš„ç¯å¢ƒå˜é‡

2. $name å¯ä»¥è·å–ç¯å¢ƒå˜é‡çš„å€¼

3. name=value å¦‚æœnameæ˜¯ç¯å¢ƒå˜é‡ï¼Œå°†ç¯å¢ƒå˜é‡çš„å€¼æ›´æ”¹ä¸ºvalueï¼Œå¦‚æœnameä¸æ˜¯ç¯å¢ƒå˜é‡ï¼Œä¸ºbashè¿›ç¨‹æ·»åŠ è‡ªå®šä¹‰å˜é‡
4. export name å°†nameè¾“å‡ºä¸ºç¯å¢ƒå˜é‡
5. unset name åˆ é™¤å˜é‡name

`å¦‚æœ env ï½œgrep å˜é‡`æ‰¾ä¸åˆ°å€¼ï¼Œ`echo $å˜é‡`é‚£å°±æ˜¯è‡ªå®šä¹‰å˜é‡

`set`å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰çš„è‡ªå®šä¹‰å˜é‡å’Œç¯å¢ƒå˜é‡

#### pstree æŸ¥çœ‹è¿›ç¨‹

`pstree -p` æŸ¥çœ‹å¸¦è¿›ç¨‹æ•°

`pstree -p $$` æŸ¥çœ‹å½“å‰çš„è¿›ç¨‹ID



## åº“æ–‡ä»¶

**åº“å‡½æ•°çš„å‘½åè§„åˆ™**

â€‹	åŠ¨æ€åº“çš„å‘½åè§„åˆ™ `libåº“å.so`

â€‹	é™æ€åº“çš„å‘½åè§„åˆ™ `libåº“å.a`

### é™æ€åº“çš„åˆ¶ä½œå’Œä½¿ç”¨ 

â€‹	**åŠ¨æ€åº“çš„ä½œç”¨:åªæŠŠä»£ç é‡Œé¢éœ€è¦çš„å‡½æ•°æˆ–è€…ç¬¦å·åŒ…å«åˆ°å¯æ‰§è¡Œæ–‡ä»¶å½“ä¸­,ä½†æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå¤åˆ¶ä¸€ä»½**

â€‹	**å‘½ä»¤ ar**

â€‹	å°†æ‰€æœ‰è¦åŠ å…¥åº“çš„æºæ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶

```bash
gcc -c *.c   							# æ‰€æœ‰çš„æ–‡ä»¶ä¼šç”Ÿæˆ.oæ–‡ä»¶ äºŒè¿›åˆ¶å¯ä»¥é‡å®šä½çš„
```

â€‹	å°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„æ‰€æœ‰ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆé™æ€åº“æ–‡ä»¶

```bash
ar -r lib+åº“å.a sub.o add.o   # ç”¨ sub.o add.o  ç”Ÿæˆ libåº“å.a æ–‡ä»¶

ar -t libåº“å.a  //æŸ¥çœ‹åº“ä¸­åŒ…å«ä»€ä¹ˆäºŒè¿›åˆ¶æ–‡ä»¶
```

â€‹	ä½¿ç”¨é™æ€å“­æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€€

```bash
gcc -c main.c -o main.o

gcc main.o -L. -låº“å  #å‘Šè¯‰gcc å»å½“å‰æ–‡ä»¶å¤¹ä¸‹é¢æ‰¾ libåº“å.c æ–‡ä»¶  å‚æ•°-I å¤´æ–‡ä»¶è·¯å¾„

#ä¹Ÿå¯ä»¥
gcc main.c -L. -låº“å  #å‘Šè¯‰gcc å»å½“å‰æ–‡ä»¶å¤¹ä¸‹é¢æ‰¾ libåº“å.c æ–‡ä»¶ 
```

<img src="allPic/Macdo2023-04-04 13.37.11.jpg" style="zoom:50%;" />

```bash
#:ls -l *.out
-rwxrwxr-x 1 min122218 min122218 16048  4æœˆ  4 13:51 a2.out			//é™æ€åº“ä¼šæ¯”ç›´æ¥ç”Ÿæˆçš„å° å¤§å°æ˜¯16048 å­—èŠ‚
-rwxrwxr-x 1 min122218 min122218 16144  4æœˆ  4 13:44 a.out				//ä¸è¦åŠ¨æ€åº“ æˆ–è€…ç›´æ¥ç¼–è¯‘çš„ä¼šæ¯”è¾ƒå¤§
-rwxrwxr-x 1 min122218 min122218 15992  4æœˆ  4 14:34 a.out					//åŠ¨æ€åº“çš„å…‹åˆ¶ä¹ æƒ¯æ–‡ä»¶ ï¼Œæ›´å°äº†
```



### åŠ¨æ€åº“çš„åˆ¶ä½œå’Œä½¿ç”¨ 



â€‹	å°†æ‰€æœ‰è¦åŠ å…¥åº“çš„æºæ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶ï¼Œä¸ä½ç½®æ— å…³çš„ç›®æ ‡æ–‡ä»¶ 

```bash
//ä¸ä½ç½®æ— å…³çš„ç›®æ ‡æ–‡ä»¶ æ·»åŠ å‚æ•° -fPIC ä¹Ÿå°±æ˜¯ç¼–è¯‘æˆåŠ¨æ€åº“çš„æ—¶å€™è¦åŠ å‚æ•° -fPIC
gcc -c -fPIC *.c  				
```

â€‹	å°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶æ‰“åŒ…æˆåŠ¨æ€åº“æ–‡ä»¶ä¸­

```
gcc -shared -o libåº“å.so  *.o  
```

â€‹	ä½¿ç”¨åŠ¨æ€è¿æ¥åº“ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

```bash
gcc -c main.c -o main.o		
gcc main.c -o a.out

./a.out ä¼šæ‰¾ä¸åˆ°è‡ªå·±ç¼–è¯‘çš„åŠ¨æ€åº“
å¯ä»¥ç”¨ldd å‘½ä»¤æŸ¥çœ‹ä¾èµ–çš„åº“
ldd a.out 
        linux-vdso.so.1 (0x00007ffd71fe3000)
        libmymath.so => not found   #æ²¡æ‰¾åˆ°
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007f056ec00000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f056eea5000)
        
è§£å†³çš„åŠæ³• LD_LIBRART_PATH ç¯å¢ƒå˜é‡åŠ å…¥è‡ªå·±åˆ¶ä½œåº“æ–‡ä»¶çš„è·¯å¾„
è¿æ¥å™¨é»˜è®¤çš„è·¯å¾„æ˜¯ /lib å’Œ /usr/lib 
export LD_LIBRART_PATH=$LD_LIBRART_PATH:your_path
echo 	$LD_LIBRARY_PATH

æˆ–è€…æŠŠè‡ªå·±åšçš„åŠ¨æ€åº“ç§»åŠ¨ LD_LIBRARY_PATHé‡Œé¢æ‰€åœ¨çš„è·¯å¾„é‡Œé¢

```

â€‹		

**lddå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¾èµ–çš„åº“ åªèƒ½æŸ¥çœ‹åŠ¨æ€åº“  **

**å¦‚æœç¨‹åºä¾èµ–çš„æ˜¯é™æ€åº“ï¼Œå¯ä»¥ä½¿ç”¨ `nm` å‘½ä»¤æŸ¥çœ‹é™æ€åº“ä¸­çš„ç¬¦å·ã€‚å¦‚æœç¨‹åºé“¾æ¥çš„æ˜¯é™æ€åº“ï¼Œå¯ä»¥ä½¿ç”¨ `objdump` å‘½ä»¤æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç¬¦å·**



```
åˆ©ç”¨åŠ¨æ€åº“ç¼–è¯‘çš„æ—¶å€™éœ€è¦æŒ‡å®šäº†ä»€ä¹ˆåº“ 
ä¸€åŠç”¨åˆ°äº† /lib/libmath.so 
è¦åœ¨ç¼–è¯‘çš„æ—¶å€™ æŒ‡å®šä½¿ç”¨äº†math

gcc main.c -lmath 	# ç³»ç»ŸæŒ‡å®šäº†ä¸€äº›åŠ¨æ€åº“æŸ¥æ‰¾çš„è·¯å¾„ ç¼–è¯‘çš„æ—¶å€™å°±ä¸ç”¨æŒ‡å®šäº†\


0000000000001157 T add
0000000000004028 b completed.0
                 w __cxa_finalize@GLIBC_2.2.5
0000000000001060 t deregister_tm_clones
00000000000010d0 t __do_global_dtors_aux
0000000000003e18 d __do_global_dtors_aux_fini_array_entry
0000000000004020 d __dso_handle
0000000000003e20 d _DYNAMIC
0000000000001218 t _fini
0000000000001110 t frame_dummy
0000000000003e10 d __frame_dummy_init_array_entry
00000000000021e0 r __FRAME_END__
0000000000004000 d _GLOBAL_OFFSET_TABLE_
                 w __gmon_start__
000000000000205c r __GNU_EH_FRAME_HDR
0000000000001000 t _init
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
00000000000011d6 T minruiadd
00000000000011b7 T minruisayname
0000000000001198 T minruishowpasswd
                 U printf@GLIBC_2.2.5
0000000000001090 t register_tm_clones
0000000000001138 T sayname
0000000000001119 T showpasswd
0000000000004028 d __TMC_END__


libfamily.so

```





### ä¸ç”¨åº“ åŠ¨æ€åº“ é™æ€åº“çš„ä¼˜ç¼ºç‚¹

`ä¸ç”¨åº“`:	ä¼šå§æ‰€æœ‰éœ€è¦çš„å‡½æ•°ç¬¦å·å…¨éƒ¨åŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­

`é™æ€åº“`ï¼šåªåŒ…å«ä½¿ç”¨çš„å‡½æ•°æˆ–è€…ç¬¦å·ï¼Œè¢«æ‰€æœ‰ç¨‹åºåŠ¨æ€é“¾æ¥ã€‚

`åŠ¨æ€åº“`:	ä¸åŒ…å«ä½¿ç”¨çš„å‡½æ•°å’Œç¬¦å·,åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªå¤‡ä»½ï¼Œè¢«æ‰€æœ‰è¿›ç¨‹å…±äº«èŠ‚çº¦å†…å­˜ç©ºé—´





## åŠ¨æ€åŠ è½½

<img src="/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-05 23.17.08.jpg" style="zoom:50%;" />

`è‡ªåŠ¨åŠ è½½`ï¼š

â€‹		

`åŠ¨æ€åŠ è½½`:

â€‹	åŠ¨æ€è¿æ¥å™¨çš„APIéƒ½éœ€è¦ä½¿ç”¨åˆ°dlåŠ¨æ€åº“æ–‡ä»¶ï¼Œæ‰€ä»¥é“¾æ¥çš„æ—¶å€™è¦ç”¨`-ldl` 

â€‹	æˆåŠŸè¿”å›å‡½æ•°çš„æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›null

### å››ä¸ªå‡½æ•°

```c
åŠ¨æ€åŠ è½½ 
#include <difcn.h>
  void *dlopen(const char *filename,int flags);
åŠŸèƒ½:æŠŠåŠ¨æ€åº“åŠ è½½å…¥åˆ°å†…å­˜
  å‚æ•°
  filename:å…±äº«åº“çš„è·¯å¾„ï¼Œå¦‚æœåªç»™æ–‡ä»¶çš„åå­—ï¼Œä¼šæŒ‰ç…§åŠ¨æ€è¿æ¥å™¨çš„æœç´¢è·¯å¾„æ‰¾åˆ°åŠ¨æ€åº“æ–‡ä»¶
  LD_LIBRARY_PATH æŒ‡å®šçš„è·¯å¾„æˆ–è€…é»˜è®¤è·¯å¾„ä¸‹é¢æ‰¾
  flags:
			åŠ è½½æ–¹å¼ï¼Œå¯ä»¥å–ä¸€ä¸‹å€¼
      RTLD_LAZY -å»¶è¿ŸåŠ è½½ï¼Œä½¿ç”¨ä½¿ç”¨å…±äº«åº“ä¸­çš„ç¬¦å·æ‰åŠ è½½
      RTLD_NOW -ç«‹å³åŠ è½½ï¼Œå‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå·²ç»åŠ è½½åˆ°å†…å­˜äº†
        
```



```c
#include <difcn.h>
  int dlclose(void *handle);  //å…³é—­åŠ¨æ€åº“åŠ è½½çš„å‡½æ•°ï¼Œåªæ˜¯è®¡æ•°å™¨å‡1 
	å‚æ•°ï¼š
    	åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜çš„åœ°å€ dlopen()çš„è¿”å›å€¼
  æˆåŠŸè¿”å›0
    å¤±è´¥è¿”å›é0ï¼› å¯ä»¥ç”¨dlerror è¯Šæ–­é”™è¯¯
```

â€‹	

```c
 #include <dlfcn.h>

char *dlerror(void);  //è¿”å›æœ€è¿‘é”™è¯¯çš„åŸå› 

 Link with -ldl.
```



```c
#include <dlfcn.h>

void *dlsym(void *handle, const char *symbol); //ä»åŠ¨æ€åº“é‡Œé¢æ‰¾å‡ºæ¥å‡½æ•°

åº”è¯¥æå‰å®šä¹‰ä¸€ä¸ª æŒ‡é’ˆç±»å‹ 
  typedef int (*pfunc)(int,int); pfunc ä¸ºæ¥å—ä¸¤ä¸ªint ç±»å‹ å¹¶ä¸”è¿”å› ä¸€ä¸ªint çš„å‡½æ•°æŒ‡é’ˆ
  pfunc func = (pfunc ) dlsym(handle,"åº“é‡Œé¢çš„å‡½æ•°")
```



###  è°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åº“çš„ç¤ºèŒƒä»£ç  

```c
ç¤ºèŒƒä»£ç  å·²ç»è®²t_addï¼Œt_subï¼Œt_mulï¼Œt_divåšæˆåŠ¨æ€åº“æˆ¿åˆ° LD_LIBRARY_PATHä¸­

/**
 *          ç¼–è¯‘çš„æ—¶å€™ gcc dynamic.c -ldl
 *          ./a.out libåŠ¨æ€åº“.so  ä¼šä»LD_LIBRARY_PATH é‡Œé¢æ‰¾
 *          ç”¨nm å’Œ ldd å‘½ä»¤éƒ½çœ‹ä¸åˆ° åŠ è½½çš„åº“çš„ç¬¦å· æˆ–è€… åŠ¨æ€åº“åç§° 
 *          ./a.out ä¾èµ–çš„æ˜¯libdl.so.2
 *          #include "p_math.h"  //ä¸éœ€è¦ä½¿ç”¨å¤´æ–‡ä»¶å•Š
*/



#include <dlfcn.h>   //åŠ¨æ€åŠ è½½æ‰€ç”¨åˆ°çš„åº“
#include <stdio.h>

//TODO:: è¿™å¥æŒºé‡è¦çš„ å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆçš„ç±»å‹ï¼Œåªæ˜¯æŒ‡é’ˆçš„ç±»å‹ï¼Œä¸æ˜¯å…·ä½“çš„æŒ‡é’ˆ
typedef int(* g_fun)(int ,int);   //å®šä¹‰ä¸€ä¸ªå…¨å±€çš„å‡½æ•°æŒ‡é’ˆç±»å‹ï¼Œä¸æ˜¯å…·ä½“çš„æŒ‡é’ˆå“ˆï¼Œåªæ˜¯ç±»å‹ ç±»ä¼¼äº int *

int main(int argc,char *argv[]){

    if(!argv[1]){       //éœ€è¦åˆ¤æ–­ä¸€ä¸‹å‚æ•°åœ¨ä¸åœ¨ è¦ä¸ç„¶è¿”å›çš„æ˜¯ mainå‡½æ•°ï¼Œä¸å›æŠ¥é”™å•¥çš„
        printf("Usage: EROR\n");
        printf("[1]faild reason:%s\n",dlerror());
        return -1;
    }

void *handle=dlopen(argv[1], RTLD_NOW);
    if(handle == NULL){
        printf("loading failure...\n");
        printf("[1]faild reason:%s\n",dlerror());   //dlerror()  å‡½æ•°æ‰“å°é”™è¯¯åŸå› 
        return -1;                                  //[1]faild reason:/lib/libmymath.so1: cannot open shared 		object file: No such file or directory
    }else{
        printf("loading success...\n");
    }

    //ä½¿ç”¨å‡½æ•°
    void * func =dlsym(handle, "t_mul");    //ä»å¥æŸ„ä¸­æ‰¾éœ€è¦çš„ç¬¦å·ï¼ˆå‡½æ•°ï¼‰å­—ç¬¦ä¸²
    
    if(func == NULL){
        printf("dlsym Error:%s\n",dlerror());
        return -1;
    }

    g_fun fn= (g_fun)func;  //è½¬æ¢  void * ç±»å‹çš„æŒ‡é’ˆ è½¬æ¢æˆéœ€è¦çš„å‡½æ•°æŒ‡é’ˆ 

    printf("fn(5,8)=%d\n\n",fn(5,8));



    dlclose(handle);

    return 0;
}

```



## é”™è¯¯å¤„ç†

### error é”™è¯¯çš„ä»£ç ç¼–å·

```c
ä»£ç è¿è¡Œé”™è¯¯çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªå® errno 

éœ€è¦åŒ…å«å¤´æ–‡ä»¶ <error.h> 

errno - number of last error,æœ€åä¸€æ¬¡é”™è¯¯çš„ä»£ç  
```



### strerror æ‰“å°é”™è¯¯ç¼–å·

```c
 #include <string.h>
 char *strerror(int errnum);
è¿”å›string çš„æŒ‡é’ˆ é”™è¯¯çš„åŸå› 
  
```



### perror æ˜¾ç¤ºæœ€åä¸€æ¬¡å‡½æ•°è°ƒç”¨çš„ä¿¡æ¯

```c
 #include <stdio.h>

 void perror(const char *s);



#include <stdio.h>
int main(){
  	FILE *fp=fopen("filename","r");
  	if(fp == NULL){
      perror("fopen");  //å‚æ•°ä¸ºä½¿ç”¨çš„å‡½æ•°åç§° 
      										//å¯èƒ½å‡ºç°çš„é”™è¯¯ fopen: Bad address
      										//fopen: No such file or directory
      return -1;
    }
	
  	
    return 0;
}

ubantu: ./a.out 
helo,kitty: Success
```



### perror å°è£…æˆå®

```c
å¦‚æœå‡½æ•°å‡ºé”™ï¼Œå°±è¿”å›-1 é€€å‡º
  å¯ä»¥ç§»åŠ¨åˆ°ç³»ç»ŸæŒ‡å®šçš„ç³»ç»Ÿåº“ä¸‹é¢ /usr/include 

  //filename :t_stdio.h
#ifndef T_STDIO_H
#define T_STDIO_H

#include <stdio.h>
#define E_MSG(MESSAGE,NUM) do{perror(MESSAGE);return (NUM);}while(0)

#endif
```







## å†…å­˜ç®¡ç†

æ“ä½œç³»ç»Ÿçš„MMUå°†å†…å­˜çš„ç‰©ç†åœ°å€ æ˜ å°„æˆ è™šæ‹Ÿåœ°å€ 

ç¨‹åºå‘˜çœ‹åˆ°çš„å†…å­˜åœ°å€éƒ½æ˜¯æ“ä½œçš„è™šæ‹Ÿåœ°å€ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿè‡ªå·±æ“ä½œçš„ä¹Ÿæ˜¯è™šæ‹Ÿåœ°å€



`MMUæ˜¯ä»€ä¹ˆ`

```c
MMUæ˜¯Memory Management Unitçš„ç¼©å†™ï¼Œå³å†…å­˜ç®¡ç†å•å…ƒã€‚MMUæ˜¯è®¡ç®—æœºç³»ç»Ÿä¸­çš„ä¸€ä¸ªç¡¬ä»¶æ¨¡å—ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è´Ÿè´£è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ä¹‹é—´çš„æ˜ å°„å’Œç®¡ç†ã€‚

åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œè¿™äº›åœ°å€ç©ºé—´ä¸­çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†å’Œä¿æŠ¤ï¼Œæ“ä½œç³»ç»Ÿå°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸Šã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦é€šè¿‡MMUæ¥å®Œæˆã€‚

MMUçš„ä¸»è¦å·¥ä½œåŒ…æ‹¬ï¼š
è™šæ‹Ÿåœ°å€è½¬æ¢ï¼šå°†è¿›ç¨‹ä¸­äº§ç”Ÿçš„è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚
åœ°å€ä¿æŠ¤ï¼šæ ¹æ®è¿›ç¨‹çš„è®¿é—®æƒé™ï¼Œæ§åˆ¶è¿›ç¨‹å¯¹å†…å­˜çš„è®¿é—®ã€‚
è™šæ‹Ÿå†…å­˜ç®¡ç†ï¼šå°†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€è¿›è¡Œæ˜ å°„ï¼Œæ”¯æŒé¡µé¢æ¢å…¥å’Œæ¢å‡ºï¼Œæé«˜å†…å­˜åˆ©ç”¨ç‡å’Œæ•ˆç‡ã€‚
é«˜é€Ÿç¼“å­˜ç®¡ç†ï¼šç®¡ç†CPUä¸å†…å­˜ä¹‹é—´çš„é«˜é€Ÿç¼“å­˜ï¼Œæé«˜CPUè®¿é—®å†…å­˜çš„é€Ÿåº¦ã€‚
  
é€šè¿‡MMUçš„ç®¡ç†ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä¿æŠ¤è¿›ç¨‹é—´çš„å†…å­˜ä¸äº’ç›¸å¹²æ‰°ã€‚åŒæ—¶ï¼ŒMMUè¿˜å¯ä»¥é€šè¿‡è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œå…è®¸è¿›ç¨‹ä½¿ç”¨æ¯”å®é™…ç‰©ç†å†…å­˜æ›´å¤§çš„å†…å­˜ç©ºé—´ï¼Œæé«˜å†…å­˜çš„åˆ©ç”¨ç‡ã€‚
```

`å®æ—¶æ¨¡å¼`

â€‹	ç›´æ¥è®¿é—®çš„æ˜¯å†…å­˜çš„ç‰©ç†åœ°å€

`ä¿æŠ¤æ¨¡å¼`

1. é€»è¾‘åœ°å€

2. è™šæ‹Ÿåœ°å€

3. çº¿æ€§åœ°å€

4. ç‰©ç†åœ°å€

5. ```
   ç¨‹åºå‘˜çœ‹åˆ°çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œç”±é€»è¾‘åœ°å€æ¨å¯¼å‡ºæ¥çš„
   é€»è¾‘åœ°å€åœ°å€åˆ†ä¸ºä¸¤éƒ¨åˆ† æ®µé€‰æ‹© å’Œ åç§»é‡  
   ç¨‹åºå‘˜é€šå¸¸åªéœ€è¦æŒ‡æ˜æ®µå†…çš„åç§»é‡ï¼Œåˆ†æ®µç®¡ç†æœºæ„ ä¼šæŠŠè¿™ä¸ªé€»è¾‘åœ°å€è½¬æ¢ä¸ºçº¿æ€§åœ°å€
   å¦‚æœæ²¡æœ‰åˆ†é¡µæœºåˆ¶ æ­¤æ—¶çš„çº¿æ€§åœ°å€å°±æ˜¯æœ€åçš„ä¸»å­˜ç‰©ç†åœ°å€
   å¦‚æœæœºå™¨è¿˜æœ‰åˆ†é¡µè®¾å¤‡çš„è¯ï¼Œåˆ†é¡µæœºæ„æŠŠè¿™ä¸ªçº¿æ€§åœ°å€è½¬æ¢ä¸ºæœ€ç»ˆçš„çœŸå®ç‰©ç†åœ°å€
   ```



### è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„è¯´æ˜	

```
Cè¯­è¨€ä¸­çœ‹åˆ°çš„åœ°å€é€šå¸¸æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè€Œä¸æ˜¯ç‰©ç†å†…å­˜çš„çœŸå®åœ°å€ã€‚åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯ç”±æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ï¼ˆåŒ…æ‹¬CPUå’ŒMMUç­‰ï¼‰å…±åŒç®¡ç†çš„ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå…¶ä¸­çš„åœ°å€ä¸ç‰©ç†å†…å­˜ä¸­çš„åœ°å€å¹¶ä¸ç›´æ¥å¯¹åº”ï¼Œè€Œæ˜¯é€šè¿‡åœ°å€æ˜ å°„æœºåˆ¶è¿›è¡Œæ˜ å°„ã€‚

å…·ä½“æ¥è¯´ï¼Œå½“ç¨‹åºè®¿é—®æŸä¸ªè™šæ‹Ÿåœ°å€æ—¶ï¼Œä¼šå…ˆé€šè¿‡MMUè¿›è¡Œåœ°å€è½¬æ¢ï¼Œå°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±ç¡¬ä»¶è‡ªåŠ¨å®Œæˆçš„ï¼Œç¨‹åºå‘˜é€šå¸¸æ— éœ€å…³å¿ƒã€‚å› æ­¤ï¼Œç¨‹åºä¸­çœ‹åˆ°çš„åœ°å€éƒ½æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè€Œä¸æ˜¯ç‰©ç†åœ°å€ã€‚

å¦‚æœéœ€è¦å°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºç¨‹åºå‘˜çœ‹åˆ°çš„è™šæ‹Ÿåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„è°ƒè¯•å·¥å…·ï¼ˆå¦‚GDBï¼‰ï¼Œé€šè¿‡æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„å…³ç³»æ¥ç¡®å®šè™šæ‹Ÿåœ°å€ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨/procæ–‡ä»¶ç³»ç»Ÿä¸­çš„/proc/<PID>/mapsæ–‡ä»¶æ¥æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜æ˜ å°„å…³ç³»ã€‚åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€èŒƒå›´å’Œç‰©ç†åœ°å€èŒƒå›´çš„å¯¹åº”å…³ç³»ï¼Œä»è€Œç¡®å®šè™šæ‹Ÿåœ°å€ã€‚
```



### å¦‚ä½•æŸ¥çœ‹è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜

`/proc/$$/maps` $$ä¸ºè¿›ç¨‹çš„id

```c
start_address-end_address  permissions  offset  device  inode  pathname
æ®µåœ°å€ 	æƒé™		åç§»é‡		æ˜ å°„æ–‡ä»¶çš„è®¾å¤‡		èŠ‚ç‚¹		è·¯å¾„

 
----------------------------------------------------------------------------
55e417bf8000-55e417c27000 r--p 00000000 08:03 2228319      /usr/bin/bash	//åªè¯»æ•°æ®æ®µ ç¼–è¯‘çš„æ—¶å€™åœ°å€å°±å›ºå®šï¼Œåªè¯»
55e417c27000-55e417d06000 r-xp 0002f000 08:03 2228319      /usr/bin/bash  //å¯è¯»å¯æ‰§è¡Œçš„ä»£ç æ®µ
55e417d06000-55e417d40000 r--p 0010e000 08:03 2228319      /usr/bin/bash
55e417d41000-55e417d45000 r--p 00148000 08:03 2228319      /usr/bin/bash
55e417d45000-55e417d4e000 rw-p 0014c000 08:03 2228319      /usr/bin/bash//å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡ç­‰ï¼Œ
55e419574000-55e4196df000 rw-p 00000000 00:00 0            [heap]  						//å †æ®µ
7ffe5f5d0000-7ffe5f5f1000 rw-p 00000000 00:00 0            [stack]						//æ ˆæ®µ
7ffe5f5f2000-7ffe5f5f6000 r--p 00000000 00:00 0            [vvar]
7ffe5f5f6000-7ffe5f5f8000 r-xp 00000000 00:00 0            [vdso]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0    [vsyscall]

----------------------------------------------------------------------------
  
stack æ˜¯çº¿ç¨‹æ ˆåŒºåŸŸï¼Œé€šå¸¸ç”¨äºå­˜æ”¾å‡½æ•°è°ƒç”¨çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ç­‰ï¼›
vvar æ˜¯ä¸€ä¸ªLinuxå†…æ ¸çš„å®‰å…¨ç‰¹æ€§ï¼Œç”¨äºé˜²æ­¢ä¸€äº›æ”»å‡»ï¼Œå­˜æ”¾ä¸€äº›è¿›ç¨‹ç›¸å…³çš„å˜é‡ï¼›
vdso æ˜¯ä¸€ç§ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ï¼Œç”¨äºåœ¨ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´ä¼ é€’æ•°æ®ï¼›
[vsyscall] æ˜¯ä¸€ç§å¿«é€Ÿç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ï¼Œç”¨äºæé«˜ç³»ç»Ÿè°ƒç”¨çš„æ€§èƒ½ã€‚
```

<img src="/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-07 11.32.38.jpg" style="zoom:50%;" />



è™šæ‹Ÿåœ°å€

 <img src="/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-07 11.39.32.jpg" style="zoom:50%;" />

 

### çœ‹ç¨‹åºçš„å†…å­˜åˆ†å¸ƒæƒ…å†µ



ç¨‹åº

```c

#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdlib.h>

int global_a =5;																// rw-p

int func(){
    static int func_a =6;												rw-p
    int noStatic =5;														[stack]
    printf("func_a :%p\n",&func_a);
    printf("noStatic :%p\n",&noStatic);
}


int main(){
  char *name="minlang";												r--p åªè¯»ä¸å¯ä»¥ä¿®æ”¹ å› ä¸ºä¿®æ”¹ä¹‹å é•¿åº¦ä¸ä¸€æ ·
    int main_a=4;															 	[stack]
    int *heap_a=(int *)malloc(sizeof(int));			[heap]
    printf("global_a :%p\n",&global_a);						
    printf("main_a addr:%p\n",&main_a);					  
    func();
    printf("h_a addr:%p\n",heap_a);
    printf("å½“å‰è¿›ç¨‹ %d\n",getpid());
    getchar();
    return 0;
}
```

 

è¾“å‡º

```bash
global_a :0x55e57ab75010         rw-p
main_a addr:0x7fff9526caac         [stack]
func_a :0x55e57ab75014							rw-p
noStatic :0x7fff9526ca84					[stack]
h_a addr:0x55e57b7b62a0							 [heap]
å½“å‰è¿›ç¨‹ 65574
```

  

 cat  /proc/65379/maps

```bash
55e57ab71000-55e57ab72000 r--p 00000000 08:03 1980403                    /home/min122218/1.Unixé«˜çº§ç¼–ç¨‹/7.å†…å­˜/a.out
55e57ab72000-55e57ab73000 r-xp 00001000 08:03 1980403                    /home/min122218/1.Unixé«˜çº§ç¼–ç¨‹/7.å†…å­˜/a.out
55e57ab73000-55e57ab74000 r--p 00002000 08:03 1980403                    /home/min122218/1.Unixé«˜çº§ç¼–ç¨‹/7.å†…å­˜/a.out
55e57ab74000-55e57ab75000 r--p 00002000 08:03 1980403                    /home/min122218/1.Unixé«˜çº§ç¼–ç¨‹/7.å†…å­˜/a.out
55e57ab75000-55e57ab76000 rw-p 00003000 08:03 1980403                    /home/min122218/1.Unixé«˜çº§ç¼–ç¨‹/7.å†…å­˜/a.out
55e57b7b6000-55e57b7d7000 rw-p 00000000 00:00 0                          [heap]
7f75fe600000-7f75fe628000 r--p 00000000 08:03 2234718                    /usr/lib/x86_64-linux-gnu/libc.so.6
7f75fe628000-7f75fe7bd000 r-xp 00028000 08:03 2234718                    /usr/lib/x86_64-linux-gnu/libc.so.6
7f75fe7bd000-7f75fe815000 r--p 001bd000 08:03 2234718                    /usr/lib/x86_64-linux-gnu/libc.so.6
7f75fe815000-7f75fe819000 r--p 00214000 08:03 2234718                    /usr/lib/x86_64-linux-gnu/libc.so.6
7f75fe819000-7f75fe81b000 rw-p 00218000 08:03 2234718                    /usr/lib/x86_64-linux-gnu/libc.so.6
7f75fe81b000-7f75fe828000 rw-p 00000000 00:00 0 
7f75fe89f000-7f75fe8a2000 rw-p 00000000 00:00 0 
7f75fe8b1000-7f75fe8b3000 rw-p 00000000 00:00 0 
7f75fe8b3000-7f75fe8b5000 r--p 00000000 08:03 2234381                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7f75fe8b5000-7f75fe8df000 r-xp 00002000 08:03 2234381                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7f75fe8df000-7f75fe8ea000 r--p 0002c000 08:03 2234381                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7f75fe8eb000-7f75fe8ed000 r--p 00037000 08:03 2234381                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7f75fe8ed000-7f75fe8ef000 rw-p 00039000 08:03 2234381                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7fff9524d000-7fff9526e000 rw-p 00000000 00:00 0                          [stack]
7fff952a3000-7fff952a7000 r--p 00000000 00:00 0                          [vvar]
7fff952a7000-7fff952a9000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]
```

 



### æ®µçš„å½¢æˆ



![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-07 12.20.23.jpg)





### å­—ç¬¦ä¸²çš„è¯´æ˜

```c
int main(){
    
   
    printf("å½“å‰è¿›ç¨‹ %d\n",getpid());
    char *str1="hello,beijing";
    char *str2="hello,beijing";
  	char buff[32]="hello,beijing";
  
  // char buff[32];			åˆ†é…äº†32ä¸ªå­—èŠ‚çš„ç©ºé—´ buffæ˜¯ä¸€ä¸ªåœ°å€
  // buff ="hello,beijing";		æ”¹å˜å¸¸é‡çš„åœ°å€

    printf("str1 pointer addr:%p,value addr:%p\n",&str1,str1);
    printf("str2 pointer addr:%p,value addr:%p\n",&str2,str2);
		printf("&buff  :%p\n",&buff);
  	printf("buff  format(p) :%p\n",buff);
  	printf("buff:%s\n",buff)
    getchar();

    return 0;
}

å½“å‰è¿›ç¨‹ 66398
str1 pointer addr:0x7fffe6ba7168,value addr:0x562e9441b019
str2 pointer addr:0x7fffe6ba7170,value addr:0x562e9441b019
&buff  :0x7ffe387c9bd0
buff  format(p) :0x7ffe387c9bd0
buff:hello,beijing
  
ä¸¤ä¸ªå­—ç¬¦ä¸²çš„æŒ‡é’ˆåœ°å€ä¸ä¸€æ ·ï¼Œéƒ½åœ¨æ ˆç©ºé—´     				[stack]
ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹éƒ½åœ¨æ•°æ®   æ•°æ®æ®µçš„åªè¯»åŒºåŸŸ 				r--p
```



<img src="/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-07 12.47.21.jpg" style="zoom:50%;" />

### æŸ¥çœ‹ä»£ç æ˜¯å¦ä¸ºå˜é‡æå‰åˆ†é…å¥½å†…å­˜

**ç”¨nm å‘½ä»¤æŸ¥çœ‹ç¬¦å·è¡¨æ˜¯å¦ä¸ºå…¨å±€å˜é‡ä¹‹ç±»çš„**

```
nm a.out |grep value

//å¦‚æœæ²¡æœ‰æå‰åˆ†é…å†…å­˜ æ˜¯æ”¾åœ¨æ ˆé‡Œé¢ æå‰åˆ†é…å†…å­˜çš„åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°±åˆ†é…å¥½å†…å­˜äº† 

0000000000004014 D å·²ç»åˆå§‹åŒ–çš„å…¨å±€å˜é‡
0000000000004024 B ä¸ºåˆå§‹åŒ–çš„å…¨å±€å˜é‡
0000000000004020 B å¤´æ–‡ä»¶é‡Œé¢æœªåˆå§‹åŒ–çš„å˜é‡
0000000000004010 D å¤´æ–‡ä»¶å·²ç»åˆå§‹åŒ–çš„å˜é‡
0000000000004018 d å‡½æ•°å†…çš„é™æ€å˜é‡
0000000000004028 b å‡½æ•°å†…æœªåˆå§‹åŒ–çš„å˜é‡

- Dï¼šè¯¥ç¬¦å·ä¸ºæ•°æ®ç¬¦å·ï¼Œå³å¯è¯»å†™æ•°æ®ã€‚
- dï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°æ•°æ®ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„æ•°æ®ã€‚
- Bï¼šè¯¥ç¬¦å·ä¸ºæœªåˆå§‹åŒ–æ•°æ®ç¬¦å·ï¼Œå³å¯è¯»å†™çš„æ•°æ®æ®µçš„ä¸€éƒ¨åˆ†ã€‚
- bï¼šè¯¥ç¬¦å·ä¸ºæœ¬åœ°æœªåˆå§‹åŒ–æ•°æ®ç¬¦å·ï¼Œå³ä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§çš„æœªåˆå§‹åŒ–æ•°æ®ã€‚

```



### å †çš„å†…å­˜è§£æ:malloc



```
int main(){
    printf("pid:%d\n",getpid());
    char *p=(char *)malloc(1024);  

    printf("&p=%p\n",&p);           //pçš„åœ°å€å­˜åœ¨æ ˆé‡Œé¢
    printf("p=%p\n",p);              //Pçš„å†…å®¹åœ¨å †é‡Œé¢  mallocåˆ†é…çš„
    strcpy(p,"hello,kitty\n");
    printf("Free before p:%s\n",p);
    free(p);                        //é‡Šæ”¾æ ˆé‡Œé¢çš„ç©ºé—´            
    p=NULL;                         //é‡Šæ”¾ç©ºé—´ä¹‹å,pä¸åº”è¯¥åœ¨æŒ‡å‘åŸæ¥çš„åœ°å€ï¼Œåº”è¯¥æŒ‡å‘ç©º
    //strcpy(p,"hello,world");       //pä¸æŒ‡å‘NULL è¿™æ®µä»£ç è¿˜å¯ä»¥å®ç°
    printf("Free later p:%s\n",p);      //é‡Šæ”¾ä¹‹åæ‰“å°éšæœºå€¼ï¼Œ
    getchar();
    return 0;
}


```



### æ–‡ä»¶çš„æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ä¸­

æ–‡ä»¶æ˜ å°„ï¼ˆFile Mappingï¼‰æŒ‡çš„æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æˆ–ä¸€ä¸ªæ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ˜ å°„åˆ°å†…å­˜ä¸­ï¼Œä½¿å¾—è¿™ä¸ªæ–‡ä»¶æˆ–è€…æ–‡ä»¶çš„ä¸€éƒ¨åˆ†å¯ä»¥è¢«å½“æˆå†…å­˜æ¥è®¿é—®ã€‚åœ¨Linux/Unixä¸­ï¼Œæ–‡ä»¶æ˜ å°„å¯ä»¥ä½¿ç”¨`mmap`å‡½æ•°æ¥å®ç°ã€‚

`mmap`å‡½æ•°çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªæ–‡ä»¶æˆ–ä¸€ä¸ªæ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ã€‚é€šè¿‡å¯¹è™šæ‹Ÿå†…å­˜çš„è®¿é—®ï¼Œå°±å¯ä»¥è¯»å†™æ–‡ä»¶çš„å†…å®¹ã€‚`mmap`å‡½æ•°çš„å‚æ•°å¦‚ä¸‹ï¼š

c

```c
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset); 
int munmap(void *addr, size_t length);		//é‡Šæ”¾æ˜ å°„
```

*   `addr`ï¼šæ˜ å°„åŒºçš„å¼€å§‹åœ°å€ï¼Œé€šå¸¸è®¾ç½®ä¸º`NULL`ï¼Œè¡¨ç¤ºè®©ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æ˜ å°„åŒºçš„åœ°å€ã€‚
*   `length`ï¼šæ˜ å°„åŒºçš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚
*   `prot`ï¼šæ˜ å°„åŒºçš„ä¿æŠ¤æ–¹å¼ï¼Œå¯ä»¥å–ä¸‹é¢çš„å€¼ä¹‹ä¸€ï¼š
   *   `PROT_NONE`ï¼šæ˜ å°„åŒºä¸èƒ½è¢«è®¿é—®ã€‚
   *   `PROT_READ`ï¼šæ˜ å°„åŒºå¯è¢«è¯»å–ã€‚
   *   `PROT_WRITE`ï¼šæ˜ å°„åŒºå¯è¢«å†™å…¥ã€‚
   *   `PROT_EXEC`ï¼šæ˜ å°„åŒºå¯è¢«æ‰§è¡Œã€‚
   *   `PROT_READ|PROT_WRITE`ï¼šæ˜ å°„åŒºå¯è¢«è¯»å–å’Œå†™å…¥ã€‚
   *   `PROT_READ|PROT_EXEC`ï¼šæ˜ å°„åŒºå¯è¢«è¯»å–å’Œæ‰§è¡Œã€‚
   *   `PROT_READ|PROT_WRITE|PROT_EXEC`ï¼šæ˜ å°„åŒºå¯è¢«è¯»å–ã€å†™å…¥å’Œæ‰§è¡Œã€‚
*   `flags`ï¼šæ ‡å¿—å‚æ•°ï¼Œå¯ä»¥å–ä¸‹é¢çš„å€¼ä¹‹ä¸€æˆ–å®ƒä»¬çš„ç»„åˆï¼š
   *   `MAP_SHARED`ï¼šä¸å…¶ä»–æ˜ å°„è¿™ä¸ªæ–‡ä»¶çš„è¿›ç¨‹å…±äº«æ˜ å°„åŒºã€‚
   *   `MAP_PRIVATE`ï¼šå»ºç«‹ä¸€ä¸ªç§æœ‰æ˜ å°„åŒºï¼Œå¯¹è¯¥æ˜ å°„åŒºçš„å†™æ“ä½œä¸å½±å“åŸæ–‡ä»¶ã€‚
   *   `MAP_FIXED`ï¼šå°†æ˜ å°„åŒºæ”¾åˆ°æŒ‡å®šçš„åœ°å€ã€‚
   *   `MAP_ANON`ï¼šåŒ¿åæ˜ å°„åŒºï¼Œæ˜ å°„åŒºä¸ä¸ä»»ä½•æ–‡ä»¶å…³è”ã€‚
*   `fd`ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œè¡¨ç¤ºæ˜ å°„çš„æ–‡ä»¶ã€‚
*   `offset`ï¼šæ–‡ä»¶æ˜ å°„çš„åç§»é‡ã€‚

`mmap`å‡½æ•°è¿”å›æ˜ å°„åŒºçš„èµ·å§‹åœ°å€ï¼Œå¦‚æœå‡ºé”™åˆ™è¿”å›`MAP_FAILED`ã€‚æ˜ å°„åŒºå»ºç«‹åï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€è®¿é—®æ–‡ä»¶çš„å†…å®¹ã€‚å¯ä»¥é€šè¿‡`munmap`å‡½æ•°æ¥è§£é™¤æ˜ å°„ã€‚





![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-10 10.23.56.jpg)

```

```

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-10 10.26.43.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-10 10.30.38.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-10 10.38.33.jpg)



## æ–‡ä»¶çš„æ“ä½œ



**ä»¥ä¸‹çš„åº“å‡½æ•°éƒ½æ˜¯å¯¹ç³»ç»Ÿè°ƒç”¨çš„å°è£…**

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-07 18.14.45.jpg)

```c

 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>

 int open(const char *pathname, int flags);
 int open(const char *pathname, int flags, mode_t mode);

 int creat(const char *pathname, mode_t mode);

 int openat(int dirfd, const char *pathname, int flags);
 int openat(int dirfd, const char *pathname, int flags, mode_t mode);

 /* Documented separately, in openat2(2): */
 int openat2(int dirfd, const char *pathname,
             const struct open_how *how, size_t size);
```



```
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <fcntl.h>

 int open(const char *pathname, int flags);
 int open(const char *pathname, int flags, mode_t mode);
 flag:
 	O_RDONLY, O_WRONLY, or O_RDWR (read only ,wirte only,??)
 	å¯ä»¥æŒ‰ä½æˆ–ä»¥ä¸‹
	O_CREATE 	//å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨å°±éœ€è¦åˆ›å»º å¹¶ä¸”éœ€è¦æŒ‡å®šæƒé™
	æœ€ç»ˆçš„æƒé™ä¼šè¢«umask ä¿®æ”¹ .mode & ~umask
	
	O_EXCL :å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œä¼šæŠ¥é”™
	O_TRUNCï¼šæ–‡ä»¶å­˜åœ¨æ¸…ç©ºæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¼šåˆ›å»ºæ–‡ä»¶
	O_APPENDï¼š è¿½åŠ çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œæ–‡ä»¶çš„è¯»å†™æ–‡ä»¶è¢«å®šä½åœ¨æ–‡ä»¶çš„æœ«å°¾
	
	
	è¿”å›ä¸€ä¸ªéè´Ÿçš„æ–‡ä»¶æè¿°ç¬¦
	é”™è¯¯ -1 errorä¼šè®¾ç½®ä¸ºç›¸åº”çš„å€¼
	
 	
```

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-09 14.12.37.jpg)

 

#

```
bash ä¸‹é¢ ä¸€ä¸‹æ–‡ä»¶æè¿°ç¬¦é»˜è®¤æ˜¯è¢«å ç”¨çš„

0	æ ‡å‡†è¾“å…¥	STDIN_FILENO				 é”®ç›˜
1 æ ‡å‡†è¾“å‡º	STDOUT_FILENO				 å±å¹•
2 æ ‡å‡†é”™è¯¯è¾“å‡º	STDERR_FILENO		  å±å¹•

æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡º ä»ä¸é€šçš„æ¥æº 
æ¯”å¦‚ ç”¨ls å‘½ä»¤ èµ°çš„æ˜¯æ ‡å‡†è¾“å‡º
ç”¨tls å‘½ä»¤ èµ°çš„æ˜¯ é”™è¯¯æ ‡å‡†è¾“å‡º  //tlså‘½ä»¤ä¸å­˜åœ¨
```

### æ–‡ä»¶çš„ç±»å‹

```bash
ç¬¬ä¸€ä¸ªå­—ç¬¦ä»£è¡¨æ–‡ä»¶çš„ç±»å‹

-rwxrwxr-x 1 min122218 min122218 16008  4æœˆ  9 14:34 a.out
							æ–‡ä»¶æ‰€æœ‰è€…	æ–‡ä»¶æ‰€å±ç»„
-	æ™®é€šæ–‡ä»¶
d	æ–‡ä»¶å¤¹æ–‡ä»¶
c å­—ç¬¦è®¾å¤‡æ–‡ä»¶
b	å¿«è®¾å¤‡
p ç®¡é“æ–‡ä»¶
s socket æ–‡ä»¶
l è½¯è¿æ¥æ–‡ä»¶


ç¬¬ä¸€ç»„æ–‡ä»¶çš„æ‰€æœ‰è€…çš„æƒé™
ç¬¬äºŒç»„æ–‡ä»¶æ‰€å±äºç»„çš„æƒé™
ç¬¬ä¸‰ç»„å…¶ä»–äººçš„æƒé™ 

```

### umask æ©ç 

```
æ–°æ–‡ä»¶åˆ›å»ºçš„æ—¶å€™
-rw-rw-rw-  0666æƒé™
umask 0002	å»æ‰other wçš„æƒé™
æ–°å»ºçš„æ–‡ä»¶æ–‡ä»¶æƒé™å˜æˆ 
-rw-rw-r--  otheræ²¡æœ‰å†™çš„æƒé™ 
```

æ©ç  æŠŠç›¸åº”ä½çš„æƒé™æ‹¿æ‰



### open()å‡½æ•°

`open()` æ˜¯ Linux ç³»ç»Ÿè°ƒç”¨ä¸­ç”¨äºæ‰“å¼€æ–‡ä»¶çš„å‡½æ•°ã€‚å®ƒçš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```
cCopy code
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int open(const char *pathname, int flags);
int open(const char *pathname, int flags, mode_t mode);
```

å…¶ä¸­ï¼Œ`pathname` æ˜¯æ–‡ä»¶çš„è·¯å¾„åï¼Œå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼›`flags` æ˜¯æ‰“å¼€æ–‡ä»¶æ—¶çš„æ ‡å¿—ï¼Œç”¨äºæŒ‡å®šæ‰“å¼€æ–¹å¼å’Œè®¿é—®æ¨¡å¼ï¼›`mode` æ˜¯åˆ›å»ºæ–°æ–‡ä»¶æ—¶çš„è®¿é—®æƒé™ã€‚

å…·ä½“æ¥è¯´ï¼Œ`flags` å¯ä»¥æœ‰ä»¥ä¸‹å–å€¼ï¼š

- `O_RDONLY`ï¼šä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼›
- `O_WRONLY`ï¼šä»¥åªå†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼›
- `O_RDWR`ï¼šä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼›
- `O_CREAT`ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼› åˆ›å»ºçš„æ—¶å€™è¦è®¾ç½®mode_t æƒé™ 0777 0644 ç­‰ç¯
- `O_EXCL`ï¼šå’Œ `O_CREAT` ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨åˆ™è¿”å›é”™è¯¯ï¼›
- `O_TRUNC`ï¼šå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œä¸”ä»¥å†™æ–¹å¼æ‰“å¼€ï¼Œåˆ™æ¸…ç©ºæ–‡ä»¶å†…å®¹ï¼›
- `O_APPEND`ï¼šä»¥è¿½åŠ æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå³åœ¨æ–‡ä»¶æœ«å°¾å†™å…¥æ•°æ®ã€‚

`mode` å‚æ•°åªæœ‰åœ¨ä½¿ç”¨ `O_CREAT` æ ‡å¿—åˆ›å»ºæ–°æ–‡ä»¶æ—¶æ‰ä¼šä½¿ç”¨ã€‚å®ƒæŒ‡å®šäº†æ–°æ–‡ä»¶çš„è®¿é—®æƒé™ï¼Œå…·ä½“å–å€¼å¯ä»¥å‚è€ƒ `chmod()` å‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–°åˆ›å»ºçš„æ–‡ä»¶æƒé™é»˜è®¤ä¼šå—åˆ°å½“å‰è¿›ç¨‹çš„ umask å€¼çš„å½±å“ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`open()` å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæŒ‡å‘æ‰“å¼€æ–‡ä»¶çš„æŒ‡é’ˆã€‚æ‰“å¼€æ–‡ä»¶åï¼Œå¯ä»¥ä½¿ç”¨è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ–‡ä»¶æ“ä½œï¼Œä¾‹å¦‚è¯»ã€å†™ã€å…³é—­ç­‰ã€‚



### close()å‡½æ•°

æ–‡ä»¶æŒ‡é’ˆæœ‰è®¡æ•°å™¨ï¼Œç”¨close() ä¼šè®¡æ•°å™¨å‡1 ï¼Œè®¡æ•°å™¨ä¸º0çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾èµ„æº

`close()` æ˜¯ Linux ç³»ç»Ÿè°ƒç”¨ä¸­ç”¨äºå…³é—­æ–‡ä»¶çš„å‡½æ•°ã€‚å®ƒçš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```
cCopy code
#include <unistd.h>

int close(int fd);
```

å…¶ä¸­ï¼Œ`fd` æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥æ˜¯ç”± `open()` æˆ– `dup()` å‡½æ•°è¿”å›çš„ä»»æ„æ•´æ•°ã€‚å½“ `close()` å‡½æ•°æˆåŠŸæ‰§è¡Œæ—¶ï¼Œå®ƒä¼šå°† `fd` æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦å…³é—­ï¼Œå¹¶é‡Šæ”¾ç›¸å…³çš„èµ„æºã€‚

`close()` å‡½æ•°åœ¨å…³é—­æ–‡ä»¶æ—¶å¯èƒ½ä¼šå‡ºç°ä¸€äº›é”™è¯¯ï¼Œä¾‹å¦‚æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆã€æ–‡ä»¶å·²ç»è¢«å…³é—­ç­‰ç­‰ã€‚æ­¤æ—¶ï¼Œ`close()` å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè´Ÿæ•´æ•°é”™è¯¯ç ã€‚åœ¨å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ `errno` å…¨å±€å˜é‡æ¥è·å–å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Linux ä¸­ï¼Œè¿›ç¨‹é€€å‡ºæ—¶ä¼šè‡ªåŠ¨å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦æ˜¾å¼åœ°è°ƒç”¨ `close()` å‡½æ•°æ¥å…³é—­æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¸­ï¼Œä¾‹å¦‚éœ€è¦é‡Šæ”¾å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦æˆ–è€…éœ€è¦åœ¨è¿›ç¨‹ä¸­é—´å…³é—­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦ç­‰ï¼Œæ‰‹åŠ¨è°ƒç”¨ `close()` å‡½æ•°å°±æ˜¾å¾—éå¸¸é‡è¦äº†ã€‚



###  read() å‡½æ•°

**ä»æ–‡ä»¶æè¿°ç¬¦é‡Œé¢è¯»å–å†…å®¹ æ”¾åˆ°bufä¸­**

**è¯»å–é”™è¯¯è¿”å›-1ï¼Œè¯»å–åˆ°æœ«å°¾äº†è¿”å›0 ï¼ŒæˆåŠŸ è¿”å›è¯»å–å­—ç¬¦æ•°é‡**

```c
NAME
       read - read from a file descriptor

SYNOPSIS
       #include <unistd.h>

       ssize_t read(int fd, void *buf, size_t count);
é”™è¯¯è¿”å›-1 æˆåŠŸè¿”å›è¯»å–å¤§å°çš„å­—èŠ‚æ•° 0ä»£è¡¨åˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾
  
  
buf	 è¯»å–çš„å†…å®¹æ”¾åˆ°buffä¸­
count:è¯»å–
 
```







### write() å‡½æ•°

**å‘æ–‡ä»¶æè¿°ç¬¦å†™åˆ°è¿½åŠ åˆ°å†…å®¹ä¸­**

```c
 #include <unistd.h>

 ssize_t write(int fd, const void *buf, size_t count);

è¿”å›å€¼
	é”™è¯¯ -1 è®¾ç½®error
  æˆåŠŸä¸–çºªå†™å…¥çš„æ–‡ä»¶å­—èŠ‚æ•°é‡
```




### lseek()å‡½æ•°

**é‡æ–°å®šä½æ–‡ä»¶çš„è¯»å†™æ–‡å­—**

```c
NAME
       lseek - reposition read/write file offset

SYNOPSIS
       #include <sys/types.h>
       #include <unistd.h>

       off_t lseek(int fd, off_t offset, int whence);
fd:
	æ–‡ä»¶æè¿°ç¬¦å·
offsetï¼š
    æŒ‡å®šäº†ä¸€ä¸ªå­—èŠ‚æ•°
    unsigned int 
whenceï¼š
    SEEK_SET: ä½ç½®è¢«è®¾ç½®åœ¨æ–‡ä»¶çš„offsetä¸ªå­—èŠ‚å¤„    			// æ–‡ä»¶çš„å¼€å§‹ +offset
    SEEK_CURï¼šä½ç½®åœ¨å½“å‰ä½ç½®çš„offsetå­—èŠ‚å¤„ç†						// å½“å‰çš„ä½ç½® +offset
    SEEK_ENDï¼šä½ç½®è¢«è®¾ç½®åœ¨æ–‡ä»¶çš„å¤§å°+offsetå­—èŠ‚å¤„ç†			// æ–‡ä»¶æœ€å +offset
è¿”å›å€¼ï¼š
    é”™è¯¯ -1 errnoè¢«è®¾ç½®
    æˆåŠŸ è¿”å›ä½ç½®è·ç¦»æ–‡ä»¶å¼€å¤´çš„å­—èŠ‚æ•°é‡
    
```



**linux cpå‘½ä»¤çš„å®ç°**

```c
#include <t_file.h>
#include <t_stdio.h>
#include <stdlib.h>

/**
 *  å®ç° æ‹·è´cp å‘½ä»¤
 *  tâ€”cp  æºæ–‡ä»¶ ç›®æ ‡æ–‡ä»¶
 *  
*/


int cp_file(int src_fd,int des_fd){
    int total=0;
    int r,w;
    char buff[20];
    while(r=read(src_fd,buff,20)){
        char *temp=buff;
        while(r >0 ){  //ç¡®ä¿æ–‡ä»¶å¯ä»¥å†™è¿›å»
            w=write(des_fd,temp,r);
            r=r-w;
            total +=w;
            temp +=w;
        }
        
    }
    return total;  
}

int main(int argc,char *argv[]){
    if(argc != 3){
        printf("Usage: %s srcfile desfile\n",argv[0]);
        exit(-1);
    }

    ssize_t result;

    int src_fd = open(argv[1],O_RDONLY);
    if(src_fd == -1)E_MSG("open",-1);

    int des_fd=open(argv[2],O_WRONLY|O_CREAT|O_TRUNC,00644);
    if(des_fd == -1)E_MSG("open",-1);

    printf("Total charactes:%d\n",cp_file(src_fd,des_fd));



    printf("src_fd:[%d],des_fd:[%d]\n",src_fd,des_fd);
    close(src_fd);
    close(des_fd);
    return 0;


}
```



### æ–‡ä»¶æè¿°ç¬¦çš„å¤åˆ¶

linuxçš„é‡å®šå‘å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦çš„å¤åˆ¶å®ç°çš„

ç³»ç»Ÿæä¾›çš„å‡½æ•°æœ‰ä¸¤ä¸ª

```c
#include <unistd.h>

int dup(int oldfd);  

å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦
  
  è¿”å›å€¼ï¼š-1 errorè®¾ç½®ä¸ºç›¸åº”çš„é”™è¯¯æè¿°ç 

 int t=dup(1);   1ä¸ºæ ‡å‡†è¾“å‡º å¾€æ–‡ä»¶æè¿°ç¬¦ té‡Œé¢å†™æ•°æ® å°±ç­‰äºå¾€å±å¹•è¾“å‡ºé‚£å•¥
```

```c
#include <unistd.h>
int dup2(int oldfd, int newfd);
```

**æ–‡ä»¶æè¿°ç¬¦é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º**

```c
#include <t_file.h>
#include <t_stdio.h>
#include <stdlib.h>
#include <string.h>

//ä»æ–‡ä»¶åˆ°é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º

int main(int argc,char * argv[]){
    if(argc !=2){
        printf("è¾“å…¥æ ¼å¼ %s filename\n",argv[0]);
        return -1;
    }
  
    int fd=open(argv[1],O_RDONLY);      //æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å·  
    if(fd==-1)E_MSG("open",-1);
    int bak=dup(0);                     //å¤‡ä»½æ ‡å‡†è¾“å…¥
    dup2(fd,0);                         //é‡æ–°å®šå‘åˆ° æ ‡å‡†è¾“å…¥
    close(fd);                          //å…³é—­æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦
    char buff[30];                      //ç¼“å­˜
    int n;                              //å®é™…è¯»å–çš„æ•°å­—
    while( (n = read(0,buff,strlen(buff) )>0))
        write(1,buff,n);                    //å¾€æ ‡å‡†è¾“å‡ºå†™ä¸œè¥¿
    dup2(bak,0);                         //æ¢å¤å¤‡ä»½
    close(bak);                           //å…³é—­å¤‡ä»½çš„æ–‡ä»¶æç´ ç¬¦å·
    return 0;
}
```

**æ–‡ä»¶æè¿°ç¬¦é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º**

```c
#include<t_file.h>
#include<t_stdio.h>
#include<string.h>

//é‡å®šå‘çš„æ–‡ä»¶åé€šè¿‡argv[1]ä¼ é€’ç»™è¿›ç¨‹
//ä¸»è¦æ˜¯æ“ä½œæ–‡ä»¶æè¿°ç¬¦
// å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦  int target=dup(src_fd);      src_fd å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦
//æ‹·è´åˆ°æ–°çš„æ–‡ä»¶æè¿°ç¬¦         dup2(fd1,fd2);      fd1çš„æ–‡ä»¶æè¿°ç¬¦ å¤åˆ¶åˆ° fd2  è®°å¾—å…³é—­fd1 å·²ç»ä¸ç”¨äº†
//æ¢å¤æ–‡ä»¶æè¿°ç¬¦              dup2(target,src_fd2);         

//æ–‡ä»¶
int main(int argc,char *argv[]){
    // 0 , 1, 2

    char *msg="this is a test .... \n";
    char *enter="\n";
    int flags=O_WRONLY|O_CREAT|O_TRUNC;
    int fd=open(argv[1],flags,00644);           //fd=3  æ–‡ä»¶è‡ªå¸¦çš„æ–‡ä»¶æè¿°ç¬¦
    if(fd == -1)E_MSG("open",-1);
    int s_fd=dup(1);                            //s_fd=4 æ‹·è´æ ‡å‡†è¾“å‡ºçš„æ–‡ä»¶æè¿°ç¬¦
    dup2(fd,1);                                 //æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶åˆ°æ ‡å‡†è¾“å‡º
    close(fd);                                  //å…³é—­ æ‰“å¼€æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦
   for(int i=0;i<100;i++){
        
        write(1,msg,strlen(msg));               // å¾€æ–‡ä»¶çš„æ–‡ä»¶çš„æè¿°ç¬¦å†™
        write(s_fd,msg,strlen(msg));            // å¾€åŸæ¥çš„æ ‡å‡†è¾“å‡ºæè¿°å†™
   }
    dup2(s_fd,1);                                 // æ¢å¤æ ‡å‡†è¾“å‡º,s_fd æ˜¯ä¹‹å‰å¤‡ä»½çš„
    close(s_fd);                                  // å…³é—­å¤‡ä»½çš„æ–‡ä»¶æè¿°ç¬¦
    write(1,msg,strlen(msg));                     // å†å¾€æ˜¾ç¤ºå™¨ä¸Šé¢è¾“å‡ºä¸€è¾¹
    return 0;
}
```

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-09 23.10.43.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-09 23.11.46.jpg)

### æ–‡ä»¶çš„å…ƒæ•°æ®

éœ€è¦ä½¿ç”¨ ls -l file ç²—ç•¥çš„æŸ¥çœ‹æ–‡ä»¶å…ƒæ•°æ®

æˆ–è€…ä½¿ç”¨stat å¯ä»¥è¯¦ç»†çš„æŸ¥çœ‹æ–‡ä»¶çš„å…ƒæ•°æ®

```bash
#:stat a.out 
File: a.out
Size: 16088           Blocks: 32         IO Block: 4096   regular file
Device: 803h/2051d      Inode: 1981228     Links: 1
Access: (0777/-rwxrwxrwx)  Uid: ( 1000/min122218)   Gid: ( 1000/min122218)
Access: 2023-04-10 12:04:15.526398860 +0800
Modify: 2023-04-10 12:04:14.330390536 +0800
Change: 2023-04-10 12:04:14.330390536 +0800
Birth: 2023-04-10 12:04:14.314390425 +0800
```

```
#:ls -li d2 

1981316 -rw-rw-rw- 1 min122218 min122218 0  4æœˆ 10 12:48 d2
```

**æ–‡ä»¶çš„inode æ˜¯ä»€ä¹ˆ**

```
inodeï¼ˆindex nodeï¼‰æ˜¯Unixå’Œç±»Unixæ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½ä¼šåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„inodeå·ï¼Œå®ƒåŒ…å«äº†æ–‡ä»¶æˆ–ç›®å½•çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚æ–‡ä»¶ç±»å‹ã€æ–‡ä»¶æƒé™ã€æ‰€æœ‰è€…ã€å¤§å°ã€åˆ›å»ºå’Œä¿®æ”¹æ—¶é—´ã€è®¿é—®æ—¶é—´ã€æ•°æ®å—çš„åœ°å€ç­‰ç­‰ã€‚å¯ä»¥é€šè¿‡ls -i å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶çš„inodeå·ã€‚å› ä¸ºinodeå¯ä»¥æä¾›å¿«é€Ÿè®¿é—®æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ‰€ä»¥Unixå’Œç±»Unixç³»ç»Ÿéƒ½é‡‡ç”¨äº†inodeè¿™ç§æ•°æ®ç»“æ„æ¥ç®¡ç†æ–‡ä»¶ç³»ç»Ÿã€‚
```

**æ•°æ®å—è¡¨æ˜¯å¦åœ¨inodeä¿¡æ¯ä¸­**

```
æ•°æ®å—è¡¨é€šå¸¸ä¸æ˜¯åœ¨inodeä¿¡æ¯ä¸­ã€‚æ¯ä¸ªinodeåŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œä¾‹å¦‚æ–‡ä»¶ç±»å‹ã€æ–‡ä»¶æƒé™å’Œæ‰€æœ‰è€…ä¿¡æ¯ç­‰ã€‚æ•°æ®å—è¡¨æ˜¯ç”¨äºå­˜å‚¨æ–‡ä»¶å†…å®¹çš„ç£ç›˜å—åˆ—è¡¨ï¼Œè¿™äº›å—é€šå¸¸æ˜¯åˆ†é…ç»™æ–‡ä»¶çš„ã€‚æ•°æ®å—è¡¨é€šå¸¸å­˜å‚¨åœ¨ä¸inodeä¸åŒçš„ç£ç›˜å—ä¸Šï¼Œä½†æ˜¯inodeä¸­åŒ…å«æŒ‡å‘æ•°æ®å—è¡¨çš„æŒ‡é’ˆï¼Œè¿™äº›æŒ‡é’ˆæŒ‡å‘å­˜å‚¨æ•°æ®å—è¡¨çš„ç£ç›˜å—ã€‚
```

è·å–æ–‡ä»¶çš„å…ƒæ•°æ®

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <stdio.h>

int stat(const char *pathname, struct stat *statbuf);

pathname è·¯å¾„
statbuf éœ€è¦å­˜å…¥çš„æ•°æ®ç¼“å­˜ï¼Œ
è¿”å›å€¼ 0
é”™è¯¯ -1 errnoè¢«è®¾ç½®

```

**struct statç»“æ„ä½“æˆå‘˜**

```c
struct stat 
  {
    __dev_t st_dev;	æ–‡ä»¶æ‰€åœ¨çš„è®¾å¤‡ IDã€‚
    __ino_t st_ino;	æ–‡ä»¶çš„ inode å·ã€‚
    __nlink_t st_nlink;	æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°ç›®ã€‚
    __mode_t st_mode;	æ–‡ä»¶ç±»å‹å’Œè®¿é—®æƒé™ã€‚
    __uid_t st_uid;	æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ· IDã€‚
    __gid_t st_gid;	æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„ IDã€‚
    int __pad0;
    __dev_t st_rdev;	ç‰¹æ®Šæ–‡ä»¶çš„è®¾å¤‡ IDã€‚
    __off_t st_size;	æ–‡ä»¶çš„å¤§å°ã€‚
    __blksize_t st_blksize;	æ–‡ä»¶ç³»ç»Ÿå—çš„å¤§å°ã€‚
    __blkcnt_t st_blocks;	åˆ†é…ç»™æ–‡ä»¶çš„å—æ•°ã€‚
    struct timespec st_atim;	æœ€åä¸€æ¬¡è®¿é—®æ–‡ä»¶çš„æ—¶é—´æˆ³ã€‚
    struct timespec st_mtim;	æœ€åä¸€æ¬¡ä¿®æ”¹æ–‡ä»¶çš„æ—¶é—´æˆ³ã€‚
    struct timespec st_ctim;	æœ€åä¸€æ¬¡æ”¹å˜æ–‡ä»¶å±æ€§çš„æ—¶é—´æˆ³ã€‚
    __syscall_slong_t __glibc_reserved[3];
};

//struct timespec st_birthtimï¼šæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´æˆ³ï¼ˆæœ‰äº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒæ­¤å­—æ®µï¼‰ã€‚
```

 

 



### è½¯è¿æ¥å’Œç¡¬è¿æ¥

ä¸€ä¸ªæ–‡ä»¶åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸ä¹‹å¯¹åº”ï¼Œä½†æ˜¯å´å¯ä»¥æœ‰å¤šä¸ªæ–‡ä»¶åç§°ä¸ä¹‹å¯¹åº”

æ–‡ä»¶å é“¾æ¥ç¡¬ç›˜ä¸Šçš„ä¸œè¥¿



**è½¯è¿æ¥** åˆç§°ä¸ºç¬¦å·è¿æ¥ï¼Œç±»ä¼¼äºwindowsçš„å¿«æ·æ–¹å¼

```c
ln -s source target
```

**ç¡¬è¿æ¥** ä¸ºæœ¬æ–‡ä»¶å¼€è®¾äº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶åç§°

```
ln source target
	ç¡¬è¿æ¥ä¸å…è®¸è¿æ¥æ–‡ä»¶å¤¹
```



### æ–‡ä»¶çš„æ—¶é—´

**è®¿é—®æ—¶é—´**

```
å¯¹æ–‡ä»¶è¿›è¡Œä¸€æ¬¡è¯»æ“ä½œï¼Œä»–çš„è®¿é—®æ—¶é—´å°±ä¼šè¢«ä¿®æ”¹ åƒcat more ğŸ’¡
ls stat ä¸ä¼šå¯¹st_atime æ—¶é—´è¿›è¡Œä¿®æ”¹
```

**ä¿®æ”¹æ—¶é—´**  

```
ç”¨vim ç¼–è¾‘ä¹‹åä¿å­˜ï¼Œ ä»–çš„st_mtime å°±ä¼šæ”¹å˜
```

**çŠ¶æ€æ—¶é—´**

```
chmod chown  æ”¹å˜æ–‡ä»¶çš„å…ƒæ•°æ®çš„æ—¶å€™ï¼ŒçŠ¶æ€æ—¶é—´å°±ä¼šæ”¹å˜

```

Cæ–‡ä»¶çš„æ ¼å¼åŒ–æ—¶é—´

```
ctime(&æ—¶é—´æˆ³)  è¿”å›å­—ç¬¦ä¸²é¦–å…ˆåœ°å€
```





### ç”¨æˆ·ç»„ç›¸å…³

```bash
root   :x       :0  :  0       :root :/root  :/bin/bash
ç”¨æˆ·åå­—:æ˜¯å¦æœ‰å¯†ç :UID:åˆå§‹ç»„çš„GID:å¤‡æ³¨  :å®¶ç›®å½•  :SHELLè·¯å¾„ ç™»é™†çš„æ—¶å€™æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªç¨‹åº

ç”¨æˆ·ååªæ˜¯æˆ‘ä»¬çœ‹ ç³»ç»Ÿç”¨UID è¯†åˆ« 
å¯†ç å­˜åœ¨ /etc/shaow é‡Œé¢
UID:
	0ä¸ºè¶…çº§ç”¨æˆ· 1-499ä¸ºç³»ç»Ÿç”¨æˆ·ï¼ˆä¼ªç”¨æˆ·çš„UIDï¼‰ 500ï½54435ä¸ºæ™®é€šç”¨æˆ·çš„UID 
GID: 
	ç”¨æˆ·ç»„çš„ID ä¸€åŠåˆ›å»ºç”¨æˆ·çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºåŒåçš„ç”¨æˆ·ç»„
	é™„åŠ ç»„ï¼šç”¨æˆ·ç»„å¯ä»¥åŠ å…¥å…¶ä»–çš„ç”¨æˆ·ç»„
å¤‡æ³¨:
	æ²¡ä»€ä¹ˆç‰¹æ®Šä½œç”¨
å®¶ç›®å½•:
ç™»é™†shell:

```

```
#:cat /etc/group

root:x:0:min122219
adm:x:4:syslog,min122218
cdrom:x:24:min122218
sudo:x:27:min122218
dip:x:30:min122218
plugdev:x:46:min122218
lpadmin:x:122:min122218
lxd:x:134:min122218
min122218:x:1000:
sambashare:x:135:min122218


ç¬¬ä¸€ä¸ªç»„å:ç¬¬äºŒä¸ªå£ä»¤:ç»„æ ‡è¯†å·:ç»„å†…ç”¨æˆ·åˆ—è¡¨ï¼Œä¸ç”¨çš„ç”¨æˆ·ä¹‹é—´ç”¨é€—å·åˆ†å‰²
å¯†ç æ˜¯X ä»£è¡¨æ²¡æœ‰å¯†ç 

root:x:0:min122219,min122218
root ç”¨å‘½ä»¤ : sudo usermod -aG root min122218 æŠŠmin122218 æ·»åŠ åˆ°root ç»„é‡Œé¢


```



**uid è½¬æ¢æˆç”¨æˆ·**

```c
#include <sys/types.h>
#include <pwd.h>

struct passwd *getpwnam(const char *name);
struct passwd *getpwuid(uid_t uid);

æ‰¾ä¸åˆ°è¿”å›NULL errnoä¸è®¾ç½®
  
struct passwd
{
char *pw_name;		/* Username.  */
char *pw_passwd;		/* Hashed passphrase, if shadow database
                                 not in use (see shadow.h).  */
__uid_t pw_uid;		/* User ID.  */
__gid_t pw_gid;		/* Group ID.  */
char *pw_gecos;		/* Real name.  */
char *pw_dir;			/* Home directory.  */
char *pw_shell;		/* Shell program.  */
};

```



**gid è½¬æ¢æˆç»„åç§°**

```c
 #include <sys/types.h>
 #include <grp.h>

 struct group *getgrnam(const char *name);
 struct group *getgrgid(gid_t gid);

 The  getgrnam()  function  returns a pointer to a structure containing
       the broken-out fields of the record in the group database  (e.g.,  the
       local  group  file  /etc/group,  NIS, and LDAP) that matches the group
       name name.
  

 struct group
{
  char *gr_name;		/* Group name.	*/
  char *gr_passwd;		/* Password.	*/
  __gid_t gr_gid;		/* Group ID.	*/
  char **gr_mem;		/* Member list.	*/
};
```



**æ–‡ä»¶ç±»å‹**

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-11 00.09.43.jpg)

**æŸ¥çœ‹æ–‡ä»¶çš„å…ƒä¿¡æ¯ä»£ç **

```c
// ./a.out filename æŸ¥çœ‹æ–‡ä»¶çš„å…ƒä¿¡æ¯ 

#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <stdio.h>
#include <t_stdio.h>
#include <time.h>
#include <pwd.h>
#include <grp.h>

//int stat(const char *pathname, struct stat *statbuf);

int main(int argc,char* argv[]){
    if(argc !=2){
        printf("Usage %s filename\n",argv[0]);
        return -1;
    }

    //å£°æ˜ä¸€ä¸ªç»“æ„ç”¨æ¥å­˜å‚¨æ–°è¯
    struct stat buf;

    //è·å–æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯
    int s=stat(argv[1],&buf);
    if(s==-1)E_MSG("stat",-1);


    printf("file size   :%ld\n",buf.st_size);
    printf("links       :%lu\n",buf.st_nlink);
    printf("inode       :%lu\n",buf.st_ino);
    printf("uid         :%u\n",buf.st_uid); //é€šè¿‡UIDæ‰¾åˆ°å­—ç¬¦åå­—ï¼Ÿï¼Ÿï¼Ÿ
    printf("gid         :%u\n",buf.st_gid);
    
    long int timestape=buf.st_mtim.tv_sec;        //æ—¶é—´æˆ³è½¬æ¢æˆlong intç±»å‹
    struct tm *p=gmtime(&timestape);              //è¿”å›æ—¶é—´ç»“æ„çš„æŒ‡é’ˆå»æ¥æ”¶ä»–
#if 0 
    printf("ç”¨ç»“æ„æ¥æ”¶çš„æ—¶é—´æ˜¯ %d-%d-%d %d:%d:%d\n",(p->tm_year +1900),p->tm_mon +1,p->tm_mday,
    p->tm_hour + 8,p->tm_min,p->tm_sec);
#endif
    //time.hå¤´æ–‡ä»¶ctime()çš„å‡½æ•°
    printf("modify time :%s",ctime(&timestape));

    struct passwd * ws = getpwuid(buf.st_uid);
    printf("User        :%s\n",ws->pw_name);
    printf("passwd      :%s\n",ws->pw_passwd);
    printf("Home dir    :%s\n",ws->pw_dir);
    printf("group Name  :%s\n",getgrgid(buf.st_gid)->gr_name);
    printf("file mode   :%o\n",buf.st_mode);
    printf("file mode2  :");

    switch (buf.st_mode & S_IFMT) {   
           case S_IFBLK:  printf("b");        break;
           case S_IFCHR:  printf("s");        break;
           case S_IFDIR:  printf("d");        break;
           case S_IFIFO:  printf("p");        break;
           case S_IFLNK:  printf("l");        break;
           case S_IFREG:  printf("-");        break;
           case S_IFSOCK: printf("s");        break;
           default:       printf("unknown?\n");                break;
    }

    (buf.st_mode & 0b100000000) ? printf("r"):printf("-");
    (buf.st_mode & 0b10000000)  ? printf("w"):printf("-");
    (buf.st_mode & 0b1000000)   ? printf("x"):printf("-");
    (buf.st_mode & 0b100000)    ? printf("r"):printf("-");
    (buf.st_mode & 0b10000)     ? printf("w"):printf("-");
    (buf.st_mode & 0b1000)      ? printf("x"):printf("-");
    (buf.st_mode & 0b100)       ? printf("r"):printf("-");
    (buf.st_mode & 0b10)        ? printf("w"):printf("-");
    (buf.st_mode & 0b1)         ? printf("x\n"):printf("-\n");









#if 0
    struct stat é‡Œé¢çš„mode æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´å‹

    æŒ‰ä½ 0170000  åé¢çš„çš„12ä½ä¸è¦ æŒ‰8è¿›åˆ¶ åé¢4ä¸ª8è¿›åˆ¶ä½ä¸è¦ æ˜¯å„ç§æƒé™

    st_mode  100664
            0170000  &
            0100000  ç»“æœä¸ºæ™®é€šæ–‡ä»¶


    #define	__S_IFMT	0170000	
    #define	__S_IFDIR	0040000	/* Directory.  */
    #define	__S_IFCHR	0020000	/* Character device.  */
    #define	__S_IFBLK	0060000	/* Block device.  */
    #define	__S_IFREG	0100000	/* Regular file.  */
    #define	__S_IFIFO	0010000	/* FIFO.  */
    #define	__S_IFLNK	0120000	/* Symbolic link.  */
    #define	__S_IFSOCK	0140000	/* Socket.  */
#endif
    




    return 0;
}

```



### æ–‡ä»¶å¤¹

**æ–‡ä»¶å¤¹çš„æƒé™**

****

1. è¯»æƒé™ï¼ˆrï¼‰ï¼š å…è®¸ç”¨æˆ·æŸ¥çœ‹ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•åˆ—è¡¨ã€‚å¯¹äºæ–‡ä»¶å¤¹ï¼Œè¯»æƒé™ç”¨å­—æ¯ "r" è¡¨ç¤ºï¼Œå¯¹åº”æ•°å€¼ä¸º 4ã€‚
2. å†™æƒé™ï¼ˆwï¼‰ï¼š å…è®¸ç”¨æˆ·åœ¨ç›®å½•ä¸­åˆ›å»ºã€åˆ é™¤å’Œé‡å‘½åæ–‡ä»¶å’Œå­ç›®å½•ã€‚å¯¹äºæ–‡ä»¶å¤¹ï¼Œå†™æƒé™ç”¨å­—æ¯ "w" è¡¨ç¤ºï¼Œå¯¹åº”æ•°å€¼ä¸º 2ã€‚
3. æ‰§è¡Œæƒé™ï¼ˆxï¼‰ï¼š å…è®¸ç”¨æˆ·è®¿é—®ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•ä»¥åŠæ›´æ”¹åˆ°è¯¥ç›®å½•ã€‚å¯¹äºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œæƒé™ç”¨å­—æ¯ "x" è¡¨ç¤ºï¼Œå¯¹åº”æ•°å€¼ä¸º 1ã€‚

**æ–‡ä»¶å¤¹çš„æ“ä½œ**

****

1.opendir æ‰“å¼€æ–‡ä»¶å¤¹

```
 #include <sys/types.h>
 #include <dirent.h>

 DIR *opendir(const char *name);
 
 
 é”™è¯¯è¿”å›NULL æˆåŠŸè¿”å›æ–‡ä»¶å¤¹æµçš„åœ°å€
 
```

2.closeir  å…³é—­æ–‡ä»¶å¤¹æµ

```
 #include <sys/types.h>

 #include <dirent.h>

 int closedir(DIR *dirp);
```

3.readdir 

```
 #include <dirent.h>

 struct dirent *readdir(DIR *dirp);
```



### æ–‡ä»¶é”

****

**ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨fcntl å‡½æ•°**

fcntl å‡½æ•°ç”¨äºæ“ä½œå·²ç»æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å®ƒå¯ä»¥å®Œæˆå¾ˆå¤šä¸æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ã€ä¿®æ”¹æ–‡ä»¶çŠ¶æ€æ ‡å¿—ç­‰ã€‚

fcntl å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c
#include <fcntl.h>
int fcntl(int fd, int cmd, ... /* arg */);

fdï¼šéœ€è¦æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦
cmdï¼šæ“ä½œå‘½ä»¤ï¼Œå¯ä»¥æ˜¯ä¸‹åˆ—å‘½ä»¤ä¹‹ä¸€ï¼š
  F_DUPFDï¼šå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦
  F_GETFDï¼šè·å–æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—
  F_SETFDï¼šè®¾ç½®æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—
  F_GETFLï¼šè·å–æ–‡ä»¶çŠ¶æ€æ ‡å¿—
  F_SETFLï¼šè®¾ç½®æ–‡ä»¶çŠ¶æ€æ ‡å¿—
  F_GETLKï¼šè·å–æ–‡ä»¶é”
  F_SETLKï¼šè®¾ç½®æ–‡ä»¶é”ï¼ˆéé˜»å¡ï¼‰ //é‡åˆ°æœ‰é”å°±æŠ¥é”™
  F_SETLKWï¼šè®¾ç½®æ–‡ä»¶é”ï¼ˆé˜»å¡ï¼‰	//é‡åˆ°æœ‰é”å°±ç­‰å¼€å…¶ä»–è¿›ç¨‹è§£é” 
  
  æˆåŠŸè¿”å›0 é”™è¯¯è¿”å›-1 è®¾ç½®errno
  
argï¼š
    struct flock {   //file lock
      
     ...
     short l_type;    /* Type of lock: F_RDLCK,  è¯»é” å†™é” å’Œ è§£é”å’Œ
                         F_WRLCK, F_UNLCK */
     short l_whence;  /* How to interpret l_start:  					åç§»
                         SEEK_SET, SEEK_CUR, SEEK_END */
     off_t l_start;   /* Starting offset for lock */
     off_t l_len;     /* Number of bytes to lock */
     pid_t l_pid;     /* PID of process blocking our lock				
     
                         (set by F_GETLK and F_OFD_GETLK) */
               ...
      };

```



```c


  


è¿”å›å€¼
    æˆåŠŸ0 é”™è¯¯-1 errnoè¢«è®¾ç½®
```




<img src="/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-11 14.55.57.jpg" style="zoom:50%;" />

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-11 14.59.58.jpg)

### å…³äºæ–‡ä»¶çš„å…¶ä»–ç³»ç»Ÿè°ƒç”¨ å’Œ vfs æ–‡ä»¶ç³»ç»Ÿ

****

```
æ–‡ä»¶æƒé™	:access()
æ–‡ä»¶å¤¹æ“ä½œ :chdir()  mkdir() rmdir()
æ–‡ä»¶è·¯å¾„	ï¼šgetcwd() basenameï¼ˆï¼‰ basename()
é“¾æ¥			ï¼šlink() unlink() symlink()
æ”¹æ–‡ä»¶åç§°ï¼šrename()
æ”¹æƒé™: chmod()

```

Vfs æ–‡ä»¶ç³»ç»Ÿ

****

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 11.51.50.jpg)

**task_stuct æ˜¯ä»€ä¹ˆ**

```
task_structæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹çš„çŠ¶æ€å’Œå±æ€§ã€‚å®ƒåŒ…å«äº†è¯¥è¿›ç¨‹æˆ–çº¿ç¨‹çš„å„ç§ä¿¡æ¯ï¼Œä¾‹å¦‚è¿›ç¨‹IDã€çˆ¶è¿›ç¨‹IDã€è¿›ç¨‹çŠ¶æ€ã€è¿›ç¨‹ä¼˜å…ˆçº§ã€è¿›ç¨‹ä½¿ç”¨çš„CPUæ—¶é—´ã€å†…å­˜ç®¡ç†ä¿¡æ¯ã€æ–‡ä»¶æè¿°ç¬¦è¡¨ç­‰ç­‰ã€‚task_structç»“æ„ä½“å®šä¹‰åœ¨<linux/sched.h>å¤´æ–‡ä»¶ä¸­ã€‚
```

**fs_stuct æ˜¯ä»€ä¹ˆ**

```
fs_structæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒåŒ…å«äº†ä¸æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰å·¥ä½œç›®å½•ã€æ‰“å¼€æ–‡ä»¶åˆ—è¡¨ã€æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—ç­‰ç­‰ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„fs_structç»“æ„ä½“ï¼Œå®ƒè¢«å­˜å‚¨åœ¨è¿›ç¨‹çš„task_structç»“æ„ä½“ä¸­ã€‚é€šè¿‡current->fså¯ä»¥è®¿é—®å½“å‰è¿›ç¨‹çš„fs_structç»“æ„ä½“ã€‚
```

**files_stuctæ˜¯ä»€ä¹ˆ**

```
files_structæ˜¯Linuxå†…æ ¸ä¸­ä¸€ä¸ªç”¨æ¥å­˜å‚¨è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªfiles_structç»“æ„ä½“ï¼Œé‡Œé¢åŒ…å«äº†è¯¥è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¦‚æ–‡ä»¶æè¿°ç¬¦è¡¨ã€æ–‡ä»¶è¡¨ã€å¥æŸ„ç­‰ç­‰ã€‚å®ƒæ˜¯è¿›ç¨‹çš„å…¨å±€å˜é‡ä¹‹ä¸€ï¼Œç”±å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å’Œåˆå§‹åŒ–ã€‚files_structç»“æ„ä½“åœ¨Linuxå†…æ ¸ä¸­çš„å®šä¹‰ä½äºinclude/linux/fdtable.hæ–‡ä»¶ä¸­ã€‚
```

**files_stuct ä¸­çš„fd_arrayæ•°ç»„é‡Œé¢æ˜¯ä»€ä¹ˆï¼Ÿ**

```
files_struct ç»“æ„ä½“ä¸­çš„ fd_array æ•°ç»„æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª file ç»“æ„ä½“ï¼Œè¡¨ç¤ºè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶çš„ä¿¡æ¯ã€‚æ¯ä¸ª file ç»“æ„ä½“ä¸­åŒ…å«äº†æ–‡ä»¶æè¿°ç¬¦ã€æ–‡ä»¶çŠ¶æ€æ ‡å¿—ã€æ–‡ä»¶æ“ä½œæ–¹æ³•ç­‰ä¿¡æ¯ã€‚å½“è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶æè¿°ç¬¦è¢«æ”¾å…¥è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­ï¼Œä¸ä¸€ä¸ª file ç»“æ„ä½“å…³è”ã€‚åœ¨ä½¿ç”¨è¯¥æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œ I/O æ“ä½œæ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±å¯ä»¥é€šè¿‡è¯¥ç»“æ„ä½“ä¸­çš„ä¿¡æ¯æ¥è¿›è¡Œæ–‡ä»¶æ“ä½œã€‚
```

**fileç»“æ„ä½“ä¸­æœ‰ä»€ä¹ˆ**

```
file ç»“æ„ä½“æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤ºæ‰“å¼€çš„æ–‡ä»¶ã€‚åœ¨å†…æ ¸ä¸­ï¼Œæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½ä¸ä¸€ä¸ª file ç»“æ„ä½“ç›¸å…³è”ã€‚ä¸‹é¢æ˜¯ file ç»“æ„ä½“ä¸­çš„ä¸€äº›é‡è¦å­—æ®µï¼š

struct file_operations *f_opï¼šè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸æ–‡ä»¶ç›¸å…³çš„æ“ä½œå‡½æ•°ï¼Œä¾‹å¦‚ readã€writeã€openã€close ç­‰ç­‰ã€‚æ–‡ä»¶ç³»ç»Ÿä¼šæ³¨å†Œç›¸åº”çš„æ“ä½œå‡½æ•°ï¼Œä»¥ä¾¿å†…æ ¸åœ¨å¤„ç†æ–‡ä»¶æ—¶è°ƒç”¨è¿™äº›å‡½æ•°ã€‚

struct inode *f_inodeï¼šè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ–‡ä»¶æ‰€åœ¨çš„ inode ç»“æ„ä½“ï¼Œinode åŒ…å«äº†æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚æ–‡ä»¶çš„ç±»å‹ã€æƒé™ã€å¤§å°ã€æ—¶é—´æˆ³ç­‰ç­‰ã€‚

const struct cred *f_credï¼šè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ‰“å¼€æ–‡ä»¶çš„è¿›ç¨‹çš„å®‰å…¨å‡­è¯ï¼Œç”¨äºæƒé™æ£€æŸ¥å’Œè®¿é—®æ§åˆ¶ã€‚

unsigned int f_flagsï¼šè¿™ä¸ªå­—æ®µåŒ…å«äº†æ–‡ä»¶çš„æ ‡å¿—ä½ï¼Œä¾‹å¦‚è¯»å†™æ¨¡å¼ã€é˜»å¡/éé˜»å¡æ¨¡å¼ã€æ–‡ä»¶çŠ¶æ€æ ‡å¿—ç­‰ç­‰ã€‚

atomic_t f_countï¼šè¿™æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè®°å½•æœ‰å¤šå°‘ä¸ªè¿›ç¨‹æ­£åœ¨å¼•ç”¨è¿™ä¸ª file ç»“æ„ä½“ã€‚å½“å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶ï¼Œè¿™ä¸ª file ç»“æ„ä½“ä¼šè¢«é‡Šæ”¾ã€‚

void *private_dataï¼šè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨äºå­˜å‚¨æ–‡ä»¶ç§æœ‰æ•°æ®ï¼Œä¾‹å¦‚æ‰“å¼€æ–‡ä»¶çš„è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç­‰ç­‰ã€‚
```

**inode å­˜å‚¨åœ¨ç¡¬ç›˜**

```
æ˜¯çš„ï¼Œinodeä¿¡æ¯é€šå¸¸å­˜å‚¨åœ¨ç¡¬ç›˜çš„è¶…çº§å—ä¸­ã€‚æ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæœ‰ä¸€ä¸ªè¶…çº§å—ï¼Œè¶…çº§å—ä¸­å­˜å‚¨ç€æ–‡ä»¶ç³»ç»Ÿçš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€å—å¤§å°ã€inodeæ•°é‡ã€å—æ•°é‡ç­‰ä¿¡æ¯ã€‚inodeè¡¨åˆ™å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸­ï¼Œæ¯ä¸ªinodeæè¿°äº†ä¸€ä¸ªæ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶çš„è®¿é—®æƒé™ã€æ‰€æœ‰è€…ã€æ–‡ä»¶å¤§å°ã€æ—¶é—´æˆ³ä»¥åŠæ–‡ä»¶æ•°æ®å­˜å‚¨çš„ç‰©ç†åœ°å€ç­‰ä¿¡æ¯ã€‚
```

**inode ç»“æ„ä½“é‡Œé¢æœ‰ä»€ä¹ˆ åˆ†åˆ«æœ‰ä»€ä¹ˆä½œç”¨**

```
inode ç»“æ„ä½“æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒå­˜å‚¨äº†ä¸€ä¸ªæ–‡ä»¶çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬æ–‡ä»¶çš„è®¿é—®æƒé™ã€æ—¶é—´æˆ³ã€æ–‡ä»¶ç±»å‹ã€æ•°æ®å—æ‰€åœ¨çš„ä½ç½®ç­‰ä¿¡æ¯ã€‚inode ç»“æ„ä½“é€šå¸¸ç”±æ–‡ä»¶ç³»ç»Ÿåœ¨æ–‡ä»¶åˆ›å»ºæ—¶åˆ›å»ºï¼Œå­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªä½ç½®ï¼Œä»¥ä¾›åç»­è¯»å–å’Œä¿®æ”¹ã€‚

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œinode ç»“æ„ä½“çš„å®šä¹‰é€šå¸¸å­˜å‚¨åœ¨ /usr/include/linux/fs.h æ–‡ä»¶ä¸­ï¼Œå¸¸è§çš„å­—æ®µåŒ…æ‹¬ï¼š

mode: æ–‡ä»¶è®¿é—®æƒé™ï¼ˆè¯»ã€å†™ã€æ‰§è¡Œï¼‰å’Œç±»å‹ï¼ˆæ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰ï¼‰
uid: æ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ· ID
gid: æ–‡ä»¶æ‰€æœ‰è€…çš„ç»„ ID
size: æ–‡ä»¶å¤§å°
atimeï¼šæ–‡ä»¶æœ€åè®¿é—®æ—¶é—´
mtimeï¼šæ–‡ä»¶æœ€åä¿®æ”¹æ—¶é—´
ctimeï¼šæ–‡ä»¶åˆ›å»ºæ—¶é—´
blksizeï¼šæ–‡ä»¶æ‰€ä½¿ç”¨çš„å—å¤§å°
blocksï¼šæ–‡ä»¶å ç”¨çš„æ•°æ®å—æ•°é‡
i_blocksï¼šæ–‡ä»¶å ç”¨çš„ç‰©ç†å—æ•°é‡
é™¤æ­¤ä¹‹å¤–ï¼Œinode ç»“æ„ä½“è¿˜åŒ…å«äº†æŒ‡å‘æ•°æ®å—çš„æŒ‡é’ˆï¼Œç”¨äºæè¿°æ–‡ä»¶æ•°æ®åœ¨ç£ç›˜ä¸Šçš„å­˜å‚¨ä½ç½®ã€‚å› ä¸ºæ¯ä¸ª inode ç»“æ„ä½“åªèƒ½æè¿°ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ–‡ä»¶ç³»ç»Ÿä¼šæ ¹æ®éœ€è¦åˆ›å»ºå¤šä¸ª inode ç»“æ„ä½“ï¼Œä»¥ä¾¿å­˜å‚¨æ‰€æœ‰çš„æ–‡ä»¶å…ƒæ•°æ®ã€‚
```





## è¿›ç¨‹çš„ç®¡ç†



### ä»€ä¹ˆæ˜¯è¿›ç¨‹

****

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 12.51.13.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 12.53.48.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 12.55.26.jpg)



![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 13.00.44.jpg)


**ps aux**
```

																								çŠ¶æ€					ç¨‹åºæ‰€åœ¨çš„è·¯å¾„
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.1 168184 13492 ?        Ss   4æœˆ11   0:04 /sbin/init splash
root           2  0.0  0.0      0     0 ?        S    4æœˆ11   0:00 [kthreadd]
root           3  0.0  0.0      0     0 ?        I<   4æœˆ11   0:00 [rcu_gp]
root           4  0.0  0.0      0     0 ?        I<   4æœˆ11   0:00 [rcu_par_gp]
```

**top**

```
    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
  13371 min1222+  20   0   21996   4188   3356 R   1.0   0.1   0:00.09 top
     15 root      20   0       0      0      0 I   0.3   0.0   0:25.50 rcu_preempt
    614 systemd+  20   0   14828   6188   5392 S   0.3   0.1   1:48.87 systemd-oomd
```



### æŸ¥çœ‹è¿›ç¨‹çš„è·¯å¾„

***

ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹è·¯å¾„çš„æ–¹æ³•æœ‰å¤šç§ï¼Œä¸‹é¢åˆ—å‡ºå…¶ä¸­ä¸¤ç§å¸¸ç”¨æ–¹æ³•ï¼š

1. ä½¿ç”¨ ps å‘½ä»¤é…åˆ ls å‘½ä»¤ï¼š

   ```
   $ ps -ef | grep <è¿›ç¨‹å>
   ```

   ç„¶ååœ¨è¾“å‡ºç»“æœä¸­æ‰¾åˆ°è¿›ç¨‹çš„ PIDï¼Œç”¨ ls -l /proc/<PID>/exe å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹è·¯å¾„ã€‚ä¾‹å¦‚ï¼š

   ```
   $ ps -ef | grep firefox
   root      1314     1  1 09:11 ?        00:00:08 /usr/lib/firefox/firefox
   $ ls -l /proc/1314/exe
   lrwxrwxrwx 1 root root 0 Jan 25 09:11 /proc/1314/exe -> /usr/lib/firefox/firefox
   
   ```

2.ä½¿ç”¨ pidof å‘½ä»¤æŸ¥æ‰¾è¿›ç¨‹ PIDï¼Œç„¶åä½¿ç”¨ readlink å‘½ä»¤æŸ¥çœ‹è¿›ç¨‹è·¯å¾„ï¼š

  ```
  $ pidof <è¿›ç¨‹å>
  $ readlink /proc/<PID>/exe

  ```

  ```
$ pidof firefox
	1314
$ readlink /proc/1314/exe
	/usr/lib/firefox/firefox

  ```

   







### è¿›ç¨‹çš„åˆ›å»º

****

**ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨fork()å‡½æ•°**

```c
#include <sys/types.h>
#include <unistd.h>

pid_t fork(void);
å‡½æ•°è¿”å›ä¸¤æ¬¡ï¼Œçˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„pid é”™è¯¯è¿”å›-1

```

```c
#include <t_stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdio.h>


int main(){
    //åœ¨çˆ¶è¿›ç¨‹ä¸­åˆ›å»ºå­è¿›ç¨‹
    pid_t pid;

    pid=fork();

    //å‡½æ•°è°ƒå–å¤±è´¥
    if(pid == -1)E_MSG("fork",-1);

    //è¿”å›å€¼ä¸º0çš„æ—¶å€™ï¼Œè¯´æ˜æ˜¯å­è¿›ç¨‹è¿”å›çš„
    if(pid == 0){
        //å­è¿›ç¨‹ä¸­æ‰§è¡Œçš„ä»£ç 
        printf("Child   processing...%d \n",getpid());
    }else{
        //çˆ¶è¿›ç¨‹ä¸­æ‰§è¡Œçš„ä»£ç 
        printf("Father processing....%d \n",getpid());
    }


    //çˆ¶å­è¿›ç¨‹éƒ½å¯èƒ½æ‰§è¡Œåˆ°çš„ä»£ç 

    printf("tail pid=%d\n",getpid());

   
    return 0;
}
```





![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 13.06.32.jpg)

![](/Users/min122218/Nas_Data/MD_FILE/ç°åœ¨çš„æœ‰å¯èƒ½ä¸æ‚/allPic/Macdo2023-04-12 13.21.27.jpg)

### è¿›ç¨‹çš„ç»ˆæ­¢

****

**return å’Œ exit(3)çš„åŒºåˆ«**

`return `å¦‚æœåœ¨mainå‡½æ•°ç»ˆæ­¢ è¯´æ˜è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢

`exitï¼ˆ3ï¼‰`ä»£è¡¨è¿›ç¨‹çš„æ­£å¸¸ç»ˆæ­¢ï¼Œåœ¨ç¨‹åºçš„ä»»ä½•åœ°æ–¹ä½¿ç”¨éƒ½ä¼šç»ˆæ­¢å½“å‰çš„è¿›ç¨‹

```
#include <stdlib.h>
void exit(int status);
åŠŸèƒ½ï¼šä½¿è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢
å‚æ•°:
	status : å°†status & 0377ï¼ˆ0B111111111ï¼‰çš„å€¼è¿”å›ç»™çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨waitï¼ˆ2ï¼‰æ¥å›æ”¶
æ— è¿”å›å€¼

 The exit() function causes normal process termination and the least
 significant byte of status (i.e., status & 0xFF) is returned to the
 parent (see wait(2)).
```



### é—è¨€å‡½æ•°

****

è¿›ç¨‹ç»ˆæ­¢çš„æ—¶å€™æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿›ç¨‹è°ƒç”¨return æˆ–è€…exitï¼ˆ3ï¼‰ ä»mainå‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„å‡½æ•°

é—è¨€å‡½æ•°éœ€è¦åœ¨è¿›ç¨‹è¿˜æ²¡æœ‰ç»ˆæ­¢ä»¥å‰å‘è¿›ç¨‹æ³¨å†Œï¼Œåœ¨è¿›ç¨‹ç»ˆæ­¢çš„æ—¶å€™è°ƒç”¨



**å‘è¿›ç¨‹æ³¨å†Œé—è¨€å‡½æ•°**

****

**atexit**  ç±»ä¼¼pythoné‡Œé¢çš„å›è°ƒå‡½æ•°

```c
#include<stdlib.h>
int atexit(void (*function)(void)); //æ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰è¿”å›å€¼

æˆåŠŸè¿”å›0 é”™è¯¯è¿”å›é0
```

- é—è¨€å‡½æ•°çš„æ³¨å†Œé¡ºåºå’Œè°ƒç”¨é¡ºåºç›¸å åœ¨æ ˆç©ºé—´ FILO
- é—è¨€å‡½æ•°æ³¨å†Œä¸€æ¬¡ä¼šè¢«è°ƒç”¨ä¸€æ¬¡,å¯ä»¥å¤šæ¬¡æ³¨å†Œ  
- å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„é—è¨€
- è¿›ç¨‹çš„å°è±¡è¢«æ›´æ¢çš„æ—¶å€™ï¼Œè¿›ç¨‹çš„é—è¨€å‡½æ•°ä¹Ÿè¢«è¦†ç›–





â€‹	**on_exit** æ³¨å†Œå¸¦æœ‰å‚æ•°çš„é—è¨€å‡½æ•°

```c
 #include <stdlib.h>

 int on_exit(void (*function)(int , void *), void *arg);

éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª void func(int n,(void *)arg) çš„å‡½æ•°
nä¸º è¿›ç¨‹çš„è¿”å›å€¼ ,å¦‚æœåœ¨mainä¸­æ³¨å†Œï¼Œmain å‡½æ•°æœ€åçš„ return å€¼å°±æ˜¯ nçš„å€¼
arg æ˜¯å”¯ä¸€çš„å‚æ•° ä¼ å‚çš„æ—¶å€™ ä¼šè½¬æ¢ void * æ ¼å¼ ä½¿ç”¨éœ€è¦è‡ªè¡Œè½¬æ¢
	argæ˜¯å‚æ•°
	æˆåŠŸè¿”å›0 é”™è¯¯é0
```













### è¿›ç¨‹èµ„æºçš„å›æ”¶

****

![](allPic/Macdo2023-04-16 20.53.09.jpg)

**wait()	ç³»ç»Ÿè°ƒç”¨å‡½æ•°**

é˜»å¡ç­‰å¾…å­è¿›ç¨‹çš„ç»“æŸï¼Œçˆ¶è¿›ç¨‹å›æ”¶å…¶èµ„æº

```c
pid wait(int *wstatus);  //é€€å‡º çŠ¶æ€ç å­˜å…¥ wstatus 
åŠŸèƒ½ï¼š
	é˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œç„¶åå›æ”¶å­è¿›ç¨‹çš„èµ„æº
å‚æ•°:
	status:ç”¨æ¥å­˜å‚¨å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ç 
è¿”å›å€¼:
	æˆåŠŸ ç»ˆæ­¢å­è¿›ç¨‹çš„pid
	å¤±è´¥ -1 errno è¢«è®¾ç½®	
	

```

**waitpid()	ç³»ç»Ÿè°ƒç”¨å‡½æ•°**

é˜»å¡ç­‰å¾…å­è¿›ç¨‹çš„ç»“æŸï¼Œçˆ¶è¿›ç¨‹å›æ”¶å…¶èµ„æº

```c
pid_t waitpid(pid_t pid, int *wstatus, int options);

å‚æ•°:
	pidï¼šæŒ‡å®šè¦ç­‰å¾…å›æ”¶çš„å­è¿›ç¨‹pid
    	<-1 : pid çš„ç»å¯¹å€¼æŒ‡å®šäº†è¿›ç¨‹ç»„çš„id ç­‰å¾…è¯¥ç»„çš„å­è¿›ç¨‹çš„ç»ˆæ­¢
      -1  : ç­‰å¾…ä»»æ„å­è¿›ç¨‹   å®Œå…¨ç­‰åŒäº wait(pid)
      0	  :	ç­‰å¾…ä¸çˆ¶è¿›ç¨‹åŒç»„çš„å­è¿›ç¨‹
      >0  : æŒ‡å®šäº†è¦ç­‰å¸¦çš„å­è¿›ç¨‹çš„pid
        
  status:ç”¨æ¥å­˜å‚¨å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ç 
  options:	0 é˜»å¡ç­‰å¾…å­è¿›ç¨‹ç»“æŸ
    			WNOHANG éé˜»å¡ç­‰å¾… ï¼ˆå¦‚æœå­è¿›ç¨‹è¿˜æ²¡ç»“æŸå°±è¿”å›ï¼‰
è¿”å›å€¼:
	æˆåŠŸï¼šç»ˆæ­¢å­è¿›ç¨‹çš„pidï¼Œå¦‚æœ optionsçš„å€¼ä¸ºWNOHANG è¦å›æ”¶çš„å­è¿›ç¨‹è¿˜æ²¡æœ‰ç»“æŸï¼Œè¿”å›0
  é”™è¯¯ï¼š -1 errnoåšç›¸åº”çš„è®¾ç½®
```

**æ£€æµ‹å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ç **

  `WIFEXITED(wstatus) `:å¦‚æœè¿›ç¨‹æ­£å¸¸ç»ˆæ­¢ï¼Œè¿”å›çœŸè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å®
  `WEXITSTATUS(wstatus)` //è·å–è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ç 
  `WTERMSIG(wstatus)`ï¼š//å¦‚æœè¿›ç¨‹æ˜¯è¢«æ–°å·æ‰“æ–­ï¼Œè¿”å›çœŸï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å®
  `WTERMSIG(wstatus)`  //è·å–æ‰“æ–­è¿›ç¨‹çš„ä¿¡å·çš„ç¼–å·
  `WCOREDUMP(wstatus)`:è¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥ç¨‹åºæ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…è¢«æ“ä½œç³»ç»Ÿä¿¡å·æ€æ­»

**ç»™è¿›ç¨‹å‘é€ä¿¡å·**

```bash
kill -9 è¿›ç¨‹pid

2ï¼šSIGINTï¼Œä¸­æ–­ä¿¡å·ï¼Œç”¨äºç»ˆæ­¢è¿›ç¨‹ã€‚
3ï¼šSIGQUITï¼Œé€€å‡ºä¿¡å·ï¼Œç”¨äºç»ˆæ­¢è¿›ç¨‹å¹¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚
9ï¼šSIGKILLï¼Œå¼ºåˆ¶ç»ˆæ­¢ä¿¡å·ï¼Œç”¨äºå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹ã€‚
```





### å­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹

****

**å­¤å„¿è¿›ç¨‹**ï¼šçˆ¶è¿›ç¨‹å·²ç»ç»ˆæ­¢ï¼Œå­è¿›ç¨‹è¿˜æ²¡æœ‰ç»“æŸ,å°†å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è®¾ç½®ä¸ºinitè¿›ç¨‹ï¼Œè¿™æ ·çš„å­è¿›ç¨‹è¢«ç§°ä¸ºå­¤å„¿è¿›ç¨‹,init ç§°ä¸ºå­¤å„¿é™¢

```c

int main(){

    pid_t pid =fork();
    if(pid==-1)E_MSG("fork",-1);
    if(pid ==0){
        printf("1.father pid = [%d]\n",getppid());
        printf("2.child pid = [%d]\n",getpid());
        sleep(2); //ç¡ä¸€ç§’ ä¸»è¿›ç¨‹å·²ç»ç»“æŸ
        printf("3.father pid = [%d]\n",getppid());  //çˆ¶pid ä¸º1,å˜ä¸ºå­¤å„¿è¿›ç¨‹
        printf("4.child pid = [%d]\n",getpid());
    }else{
        sleep(1);
        printf("5.father pid = [%d]\n",getpid());
    }    
    
    return 0;
}
```

```bash
#:./a.out  æ‰§è¡Œç»“æœ
1.father pid = [15407]
2.child pid = [15408]
5.father pid = [15407]
#:3.father pid = [1]
4.child pid = [15408]
```

**åƒµå°¸è¿›ç¨‹**ï¼š å­è¿›ç¨‹å·²ç»ç»“æŸï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰å›æ”¶å­è¿›ç¨‹çš„èµ„æºï¼Œè¿™æ—¶å€™å­è¿›ç¨‹å¤„äºåƒµå°¸çŠ¶æ€ï¼Œç§°è¿™æ ·çš„å­è¿›ç¨‹ä¸ºå­¤å„¿è¿›ç¨‹

â€‹					

```c
int main(){

    pid_t p=fork();
    if(p==-1)E_MSG("fork",-1);

    if(p==0){
        exit(0); //å­è¿›ç¨‹ç›´æ¥é€€å‡º
    }else{
        //sleep(2);
        getchar();
        wait(NULL); //ä¸å›æ”¶ï¼Ÿï¼Ÿå­è¿›ç¨‹çš„èµ„æº

    }
#if 0
min1222+   15013  0.0  0.0   1920   516 pts/10   S+   16:03   0:00 ./a.out
min1222+   15014  0.0  0.0      0     0 pts/10   Z+   16:03   0:00 [a.out] <defunct>
                                                åƒµå°¸çŠ¶æ€
  
çˆ¶è¿›ç¨‹ç»“æŸåä¼šå›æ”¶
#endif
    return 0;
}
```



### è¿›ç¨‹çš„æ˜ åƒ æ˜¯ä»€ä¹ˆ

****

è¿›ç¨‹çš„æ˜ åƒï¼ˆimageï¼‰æ˜¯æŒ‡è¿›ç¨‹åœ¨å†…å­˜ä¸­çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ä»£ç ã€æ•°æ®ã€æ ˆç­‰ã€‚å®ƒæ˜¯æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œè¡¨ç¤ºè¿›ç¨‹åœ¨å†…å­˜ä¸­çš„å­˜å‚¨çŠ¶æ€ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ã€‚

åœ¨è¿›ç¨‹è¢«åˆ›å»ºåï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºå®ƒåˆ†é…ä¸€å—å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸåŒ…å«äº†è¿›ç¨‹çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹æ˜ åƒã€‚è¿›ç¨‹æ˜ åƒä¸­çš„ä»£ç æ®µã€æ•°æ®æ®µå’Œå †æ ˆæ®µåˆ†åˆ«å¯¹åº”äº†è¿›ç¨‹ä¸­çš„ä»£ç ã€æ•°æ®å’Œæ ˆã€‚è¿›ç¨‹æ˜ åƒè¿˜åŒ…æ‹¬è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ã€åŠ¨æ€é“¾æ¥åº“ã€è¿›ç¨‹ç¯å¢ƒå˜é‡ç­‰ä¿¡æ¯ã€‚

è¿›ç¨‹æ˜ åƒçš„åˆ›å»ºå’Œç®¡ç†æ˜¯æ“ä½œç³»ç»Ÿçš„é‡è¦åŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒç›´æ¥å½±å“åˆ°è¿›ç¨‹çš„è¿è¡Œå’Œæ€§èƒ½ã€‚åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æ˜ åƒé€šå¸¸ç”±è™šæ‹Ÿå†…å­˜æœºåˆ¶æ¥ç®¡ç†ï¼Œæ“ä½œç³»ç»Ÿä¼šä¸ºè¿›ç¨‹åˆ†é…ä¸€å®šçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ˜ å°„åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œé¡µé¢ç½®æ¢ã€å†…å­˜å›æ”¶ç­‰æ“ä½œï¼Œä»¥ä¿è¯è¿›ç¨‹çš„æ­£å¸¸è¿è¡Œå’Œç³»ç»Ÿçš„æ€§èƒ½ã€‚

â€‹	

### è¿›ç¨‹æ˜ åƒçš„æ›´æ–°

****

![](allPic/Macdo2023-04-17 08.58.21.jpg)

![](allPic/Macdo2023-04-17 09.27.15.jpg)



![](allPic/Macdo2023-04-17 09.38.43.jpg)

![](allPic/Macdo2023-04-17 09.40.11.jpg)



![](allPic/Macdo2023-04-17 09.48.41.jpg)

![](allPic/Macdo2023-04-17 11.36.55.jpg)

**execå®¶æ—ä»¬ æ˜¯å¯¹ execveåº“å‡½æ•°çš„å°è£…**

execve å‡½æ•°æ˜¯ Unix/Linux ç³»ç»Ÿä¸­çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºå°†å½“å‰è¿›ç¨‹æ›¿æ¢ä¸ºæŒ‡å®šç¨‹åºçš„è¿›ç¨‹ã€‚å®ƒçš„å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```c
int execve(const char *pathname, char *const argv[], char *const envp[]);
```



1. pathnameï¼šè¦æ‰§è¡Œçš„ç¨‹åºçš„è·¯å¾„åã€‚å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•ã€‚

2. argvï¼šç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä»£è¡¨ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ã€‚æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ å¿…é¡»ä¸º NULLï¼Œè¡¨ç¤ºå‚æ•°åˆ—è¡¨çš„ç»“æŸã€‚

3. envpï¼šç¨‹åºçš„ç¯å¢ƒå˜é‡ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ä»£è¡¨ä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ å¿…é¡»ä¸º NULLï¼Œè¡¨ç¤ºç¯å¢ƒå˜é‡åˆ—è¡¨çš„ç»“æŸã€‚

4. execve å‡½æ•°æ‰§è¡ŒæˆåŠŸæ—¶ä¸ä¼šè¿”å›ï¼Œå®ƒå°†å½“å‰è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰å…¨éƒ¨æ›¿æ¢ä¸ºæ–°ç¨‹åºçš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆç­‰ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å› -1ï¼Œå¹¶è®¾ç½® errno å˜é‡æ¥æŒ‡ç¤ºé”™è¯¯åŸå› ã€‚

   

`execve`å‡½æ•°æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒç”¨äºå¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹å¹¶ç”¨æ–°è¿›ç¨‹æ›¿æ¢å½“å‰è¿›ç¨‹ã€‚å½“è°ƒç”¨`execve`å‡½æ•°æ—¶ï¼Œå½“å‰è¿›ç¨‹çš„ä»£ç ã€æ•°æ®ã€å †æ ˆç­‰ä¿¡æ¯ä¼šè¢«æ–°ç¨‹åºæ›¿æ¢ã€‚å› æ­¤ï¼Œ`execve`å‡½æ•°ä¸ä¼šè¿”å›ï¼Œé™¤éè°ƒç”¨å¤±è´¥ã€‚å¦‚æœè°ƒç”¨æˆåŠŸï¼Œåˆ™å½“å‰è¿›ç¨‹å·²ç»å˜æˆäº†æ–°ç¨‹åºï¼Œç›´æ¥æ‰§è¡Œæ–°ç¨‹åºçš„ä»£ç ã€‚å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œ`execve`å‡½æ•°ä¼šè¿”å›-1ï¼Œå¹¶å°†`errno`è®¾ç½®ä¸ºç›¸åº”çš„é”™è¯¯ç ï¼Œæ­¤æ—¶åº”è¯¥æ ¹æ®é”™è¯¯ç è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

 

**æ‰“å°å½“å‰å½“å‰å½“å‰ç»ˆç«¯çš„ä¿¡æ¯**

```bash
ps -o pid,ppid,pgrp,comm

    PID    PPID    PGRP COMMAND
   3108    2826    3108 bash
  19986    3108   19986 ps
  
åœ¨bash ä¸­è°ƒç”¨äº†fork
fork é‡Œé¢è°ƒç”¨äº†setpgid å°†psè¿›ç¨‹è®¾ä¸ºå¦ä¸€ä¸ªç»„çš„ç»„é•¿
```

**execå®¶æ—ä»£ç å®ä¾‹**

```c
 #include <unistd.h>

 extern char **environ;		//å…¨å±€çš„ç¯å¢ƒå˜é‡

//æ‰§è¡Œlist çš„å‚æ•° NULL ç»“å°¾  éœ€è¦è‡ªå·±æŒ‡å®šè·¯å¾„
 int execl(const char *pathname, const char *arg, ...
                 /* (char  *) NULL */);

//åœ¨ç¯å¢ƒå˜é‡é‡Œé¢æ‰¾ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤åˆ—è¡¨
 int execlp(const char *file, const char *arg, ...
                 /* (char  *) NULL */);

 int execle(const char *pathname, const char *arg, ...
                 /*, (char *) NULL, char *const envp[] */);

//æ‰§è¡ŒæŒ‡é’ˆæ•°ç»„é‡Œé¢çš„å‘½ä»¤,éœ€è¦NULLç»“å°¾ éœ€è¦è‡ªå·±æŒ‡å®šè·¯å¾„ï¼Œ
 int execv(const char *pathname, char *const argv[]);

//åœ¨ç¯å¢ƒå˜é‡é‡Œé¢ æ‰§è¡ŒæŒ‡é’ˆæ•°ç»„é‡Œé¢çš„å‘½ä»¤,éœ€è¦NULLç»“å°¾ 
 int execvp(const char *file, char *const argv[]);
 int execvpe(const char *file, char *const argv[],
                 char *const envp[]);
```

**execl** æ‰§è¡Œ list åˆ—è¡¨

```c
int main(){

    pid_t pid=fork();
    if(pid==-1)E_MSG("fork",-1);
    if(pid==0){
        printf("child process...\n");

        //exec list æ‰§è¡Œåˆ—è¡¨ NULL ç»“å°¾
        execl("/usr/bin/gcc","gcc","-E","-P","1.fork.c","-o","fuck.c",NULL);


        perror("execl");
        exit(0);
    }else{
        wait(NULL);   //çˆ¶è¿›ç¨‹é˜»å¡é˜»å¡ç­‰å¾…å›æ”¶èµ„æº
    }
    return 0;
}
```



**execvp** åœ¨ ç¯å¢ƒå˜é‡é‡Œé¢æ‰§è¡Œvector é‡Œé¢çš„å‘½ä»¤

v

```c
int main(){
    pid_t pid=fork();
    if(pid==-1)E_MSG("fork",-1);
    if(pid==0){
        printf("child process...\n");
        
        
        //æ›´æ–°è¿›ç¨‹çš„æ˜ åƒ åé¢çš„ä»£ç ä¸æ‰§è¡Œäº†ï¼Œå› ä¸ºå‡½æ•°æ²¡æœ‰è¿”å›å€¼
        execlp("ps","ps","-o","pid,ppid,pgrp,comm",NULL); // ç©ºç»“å°¾

        //æ‰§è¡Œæ•ˆæœå’Œä¸Šé¢ä¸€æ ·
        execl("/bin/ps","ps","-o","pid,ppid,pgrp,comm",NULL); // ç©ºç»“å°¾
        

        //åªæœ‰exec(3)å®¶æ—æ‰§è¡Œå¤±è´¥çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œåˆ°çš„ä»£ç 
        perror("execlp");
        exit(0);
    }else{
        wait(NULL);
    }
    return 0;
}
```







### è¿›ç¨‹ä½¿ç”¨ç¯å¢ƒå˜é‡

***

ä½¿ç”¨åº“å‡½æ•°æ“ä½œç¯å¢ƒå˜é‡

**è·å–ç¯å¢ƒå˜é‡**

```c
char *getenv(const char * name);		

åŠŸèƒ½ è·å–ç¯å¢ƒå˜é‡
 
```



**è®¾ç½®æ–°çš„ç¯å¢ƒå˜é‡**

```c
int putenv(char *string);

åŠŸèƒ½ï¼š
	å°†å­—ç¬¦ä¸²è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
å‚æ•°ï¼š
	String å‚æ•° ä»¥"name=value"çš„å­—ç¬¦ä¸²ï¼Œå°†è¿™ä¸ªå­—ç¬¦ä¸²è®¾ç½®åˆ°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œå¦‚æœè¿›ç¨‹ä¸­æœ‰å’Œnameç—›å—çš„ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨valueæ›¿æ¢æ‰åŸæ¥çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰åŒåçš„ç¯å¢ƒå˜é‡ï¼Œè¿™å°†å­—ç¬¦ä¸²è®¾ç½®ä¸ºè¿›ç¨‹çš„ç¯å¢ƒå˜é‡

è¿”å›å€¼: æˆåŠŸï¼Œè¿”å›0
  			é”™è¯¯ï¼Œè¿”å›é0
åˆ‡è®°ï¼šåªæ˜¯å°†å­—ç¬¦ä¸²è®¾ç½®åˆ°è¿›ç¨‹ç¯å¢ƒå˜é‡ä¸­ï¼Œè€Œä¸æ˜¯æ‹·è´ï¼Œå¦‚æœstringæŒ‡å‘çš„å­—ç¬¦ä¸²å†…å®¹æ³•èº«æ”¹å˜ï¼Œåˆ™ä½œç›¸åº”çš„æ”¹å˜

```



**è®¾ç½®ç¯å¢ƒå˜é‡  **

```c
int setenv(const char *name, const char *value, int overwrite);

åŠŸèƒ½:	
	å¦‚æœç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œæ ¹æ®overweiteçš„å€¼å¯¹ç¯å¢ƒå˜é‡æ“ä½œï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ›é€ ç¯å¢ƒå˜é‡
å‚æ•°ï¼š
  name ç¯å¢ƒå˜é‡çš„åå­—
 	value ç¯å¢ƒå˜é‡çš„å€¼
  overwrite  0 å¦‚æœç¯å¢ƒå˜é‡å·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œä¸æ”¹å˜ç¯å¢ƒå˜é‡çš„å€¼ æ’¤é”€æ“ä½œ
    				é0 å¦‚æœç¯å¢ƒå˜é‡å·²ç»åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™ä½¿ç”¨valueçš„å€¼æ›¿æ¢æ‰åŸæ¥çš„å€¼
è¿”å›å€¼:æˆåŠŸ é0
  		é”™è¯¯ -1 errno è¢«è®¾ç½® 
    				
```



**åˆ é™¤ç¯å¢ƒå˜é‡**

```c
int unsetenv(const char *name);
åŠŸèƒ½:ä»ç¯å¢ƒå˜é‡åˆ—è¡¨åˆ é™¤ç¯å¢ƒå˜é‡ï¼Œå¦‚æœç¯å¢ƒå˜é‡ä¸å­˜åœ¨ï¼Œä»€ä¹ˆéƒ½ä¸åš
è¿”å›å€¼
  æˆåŠŸ 0
  ä¸æˆåŠŸ é0
```



**æ¸…é™¤æ‰€æœ‰ç¯å¢ƒå˜é‡**

```c
int clearenv(void);
åŠŸèƒ½ï¼šæ¸…é™¤è¿›ç¨‹çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œå¹¶å°†å…¨å±€çš„environ è®¾ç½®ä¸ºNULL æ²¡æœ‰å‚æ•°
```



## è¿›ç¨‹é—´çš„é€šä¿¡



#### é€šä¿¡æ–¹å¼

****

è¿›ç¨‹é—´é€šä¿¡ (IPC) æ˜¯æ“ä½œç³»ç»Ÿä¸­éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒå…è®¸ä¸åŒçš„è¿›ç¨‹ä¹‹é—´äº’ç›¸ä¼ é€’ä¿¡æ¯å¹¶åä½œå®Œæˆä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ï¼š

1. ç®¡é“ï¼ˆPipeï¼‰ï¼šæ˜¯ä¸€ç§åŠåŒå·¥çš„é€šä¿¡æ–¹å¼ï¼Œåªèƒ½åœ¨å…·æœ‰çˆ¶å­å…³ç³»çš„è¿›ç¨‹ä¹‹é—´ä½¿ç”¨ï¼Œå¹¶ä¸”åªèƒ½æ”¯æŒå•å‘æ•°æ®ä¼ è¾“ã€‚
2. å‘½åç®¡é“ï¼ˆNamed Pipeï¼‰ï¼šä¹Ÿç§°ä¸ºFIFOï¼Œå®ƒå¯ä»¥å®ç°ä»»æ„ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œè€Œä¸”å¯ä»¥åœ¨æ— å…³çš„è¿›ç¨‹ä¹‹é—´ä½¿ç”¨ï¼Œæ”¯æŒåŒå‘æ•°æ®ä¼ è¾“ã€‚
3. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼šå®ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹ä¹‹é—´æ§åˆ¶å…±äº«èµ„æºçš„è®¿é—®é—®é¢˜ï¼Œå¯ä»¥å®ç°å¯¹ä¸´ç•ŒåŒºçš„äº’æ–¥è®¿é—®ã€‚
4. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼šæ˜¯ä¸€ç§å¯åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„é€šä¿¡æœºåˆ¶ï¼Œå¯ä»¥å®ç°åœ¨å·²çŸ¥è¿›ç¨‹ä¹‹é—´æœ‰åºçš„æ¶ˆæ¯ä¼ é€’ã€‚
5. å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰ï¼šå®ƒæ˜¯æœ€å¿«çš„ä¸€ç§ IPC æ–¹å¼ï¼Œå¯ä»¥å°†ä¸€å—å†…å­˜ç›´æ¥æ˜ å°„åˆ°å¤šä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä»è€Œå®ç°å¤šè¿›ç¨‹ä¹‹é—´çš„æ•°æ®å…±äº«ã€‚
6. å¥—æ¥å­—ï¼ˆSocketï¼‰ï¼šå¯ä»¥å®ç°ç½‘ç»œä¸­ä¸åŒä¸»æœºä¸Šè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä¹Ÿå¯åœ¨åŒä¸€ä¸»æœºçš„ä¸åŒè¿›ç¨‹ä¹‹é—´ä½¿ç”¨ã€‚

ä¸åŒçš„ IPC æ–¹å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå…·ä½“çš„é€‰æ‹©éœ€è¦æ ¹æ®åœºæ™¯å’Œéœ€æ±‚æ¥ç¡®å®šã€‚



****

![](allPic/Macdo2023-04-17 13.06.57.jpg)

#### ç®¡é“

****

æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´ï¼Œæ—¶é—´ç‰‡è½®åˆ°è¯¥è¿›ç¨‹çš„æ—¶å€™ï¼Œè¿›ç¨‹å¯ä»¥ä½¿ç”¨è‡ªå·±çš„ç”¨æˆ·ç©ºé—´ + å…±äº«çš„å†…æ ¸ç©ºé—´ï¼Œä¸¤ä¸ªè¿›ç¨‹é€šä¿¡å°±å¯ä»¥åˆ©ç”¨å†…æ ¸ç©ºé—´é€šä¿¡

**æœ‰åç®¡é“** æ–‡ä»¶ç³»ç»Ÿ

```c
int mkfifo(const char *pathname, mode_t mode);
åŠŸèƒ½ï¼š
  	åˆ›å»ºä¸€ä¸ªæœ‰åç®¡é“
å‚æ•°ï¼š
  		pathname æŒ‡å®šè¦åˆ›å»ºçš„æ–‡ä»¶çš„åå­—ï¼Œç®¡é“ç±»å‹æ–‡ä»¶
     	mode ç®¡é“æ–‡ä»¶çš„æƒé™
è¿”å›å€¼:
			æˆåŠŸ 0  é”™è¯¯è¿”å› -1 errno è¢«è®¾ç½®
æ³¨æ„ï¼š
   ä¸€æ—¦åˆ›å»ºç®¡é“ç±»å‹çš„æ–‡ä»¶ï¼Œå°±å¯ä»¥å‘ä½¿ç”¨æ™®é€šæ–‡ä»¶ä¸€æ ·æ˜¯è¿™ä¸ªæ–‡ä»¶å®ç°è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œè¯»å†™å‡é˜»å¡ï¼Œéœ€è¦ä¸¤ä¸ªè¿›ç¨‹é…åˆä½¿ç”¨
```

**æ— åç®¡é“** å†…å’Œç©ºé—´åˆ†é…å†…å­˜ï¼Œä¸åˆ†é…åˆ°æ–‡ä»¶ç³»ç»Ÿå½“ä¸­

```c
int pipe(int pipefd[2]); åˆ›å»ºæ— åç®¡é“
  å‚æ•°ä¸º ä¸€ä¸ª2ä¸ªå…ƒç´ çš„æ•°ç»„ æ•°ç»„ç¬¬1ä¸ªæ–‡ä»¶æè¿°ç¬¦ç”¨äºè¯»å–ç®¡é“å†…å®¹  ç¬¬2ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥æ”¶ç®¡é“å†…å®¹
  è¿”å›å€¼ 0 ä»£è¡¨æˆåŠŸ -1 å¤±è´¥
```

![](allPic/Macdo2023-04-17 13.13.47.jpg)

![](allPic/Macdo2023-04-17 13.15.02.jpg)

![](allPic/Macdo2023-04-17 13.11.37.jpg)

![](allPic/Macdo2023-04-17 13.16.47.jpg)

![](allPic/Macdo2023-04-17 13.19.14.jpg)

**ä½¿ç”¨æ— åç®¡é“**

```c
/**
 *  æ— åç®¡é“
 * 
*/

#include <t_stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <sys/wait.h>

const char * data="hello,myname is minliang\n";

int main(){
    
    int fd[2];
    char buff[128];
    //fd[0] ç®¡é“çš„è¯»ç«¯å£ fd[1] è´Ÿè´£ç®¡é“çš„å†™ç«¯å£
    //åˆ›å»ºç®¡é“ æ–‡ä»¶æè¿°ç¬¦ä¼ å…¥å‚æ•°é‡Œé¢
    int pp=pipe(fd);
    if(pp==-1){  //åˆ›å»ºå¤±è´¥
        perror("pip2");
        return -1;
    }

    //åˆ›å»ºå­è¿›ç¨‹
    pid_t p=fork();
    if(p==-1)E_MSG("fork",-1);
    if(p==0){  //å­è¿›ç¨‹
        close(fd[1]);                    //å…³é—­å­è¿›ç¨‹çš„çš„å†™ç«¯å£;
        
                                        //å¦‚æœç®¡é“æ²¡æœ‰æ•°æ®é˜»å¡ç­‰å¾…
        int r = read(fd[0],buff,128);   //ä»ç®¡é“è¯»å–æ•°æ®å†™å…¥åˆ°ç¼“å­˜ä¸­
        write(1,buff,r);                //å‘æ ‡å‡†è¾“å‡ºå†™è¯»å–åˆ°çš„ç¼“å­˜
        close(fd[0]);
        exit(0);
    }else{
        close(fd[0]);                       //çˆ¶è¿›ç¨‹å…³é—­ç®¡é“çš„ç«¯å£
        write(fd[1],data,strlen(data));     //å‘ç®¡é“å†™å…¥æ•°æ®
        close(fd[1]);                       //çˆ¶è¿›ç¨‹å…³é—­å†™ç«¯
        printf("the message from father processing\n");
        wait(NULL);                         //é˜»å¡ç­‰å¾…å­è¿›ç¨‹çš„ç»“æŸ è¦æ”¾åœ¨åé¢

    }

    printf("Bye-bye\n");


    return 0;
}

```

**ä½¿ç”¨æœ‰åç®¡é“**

åˆ›å»ºç®¡é“	 (ä¹Ÿå¯ä»¥ç”¨åˆ›å»ºç®¡é“å‘½ä»¤ mkfifo)

```c
#include <t_stdio.h>
#include <sys/types.h>
#include <sys/stat.h>

int main(int argc,char *argv[]){
    int ff=mkfifo(argv[1],0644); //åˆ›å»ºç®¡é“æ–‡ä»¶
    if(ff==-1)E_MSG("mkfifo",-1);
    else{printf("the fifo file:%s be created\n",argv[1]);}

    return 0;
}
```

å‘æœ‰åç®¡é“å†™æ•°æ® ï¼ˆè¿›ç¨‹å‘æœ‰åç®¡é“å†™å…¥æ•°æ®å,ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“æœ‰è¿›ç¨‹è¯»å–å®Œç®¡é“çš„å†…å®¹ï¼Œè¿›ç¨‹æ‰ä¼šç»“æŸ,ç®¡é“çš„æ–‡ä»¶å¤§å°ä¸€ç›´ä¸º0ï¼‰

```c
#include <t_stdio.h>
#include <t_file.h>
#include <string.h>

int main(int argc,char * argv[]){
    char* msg="this is a test......";

    //ä»¥å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶
    int fd=open(argv[1],O_WRONLY);
    if(fd==-1)E_MSG("open",-1);
    
    
    write(fd,msg,strlen(msg));				//æ³¨æ„ å¦‚æœç®¡é“å†…å®¹æ²¡æœ‰è¢«è¯»å–ä¼šä¸€ç›´ç­‰å¾…ç®¡é“å†…å®¹è¢«è¯»å–
    
    close(fd);
    return 0;
}
```

è¯»å–æ— åç®¡é“ï¼ˆè¿›ç¨‹å¼€å§‹è¯»å–ç®¡é“æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœç®¡é“å†…æ²¡æœ‰æ•°æ®ï¼Œä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“æœ‰è¿›ç¨‹å‘ç®¡é“å†™å…¥æ•°æ®åï¼Œå¹¶ä¸”è¯»å–å®Œåï¼Œè¿›ç¨‹æ‰ä¼šç»“æŸï¼‰

```c
#include <t_stdio.h>
#include <t_file.h>
#include <string.h>


int main(int argc,char * argv[]){

    char buff[128];                      //ç¼“å­˜
    int fd=open(argv[1],O_RDONLY);       //æ‰“å¼€ç®¡é“æ–‡ä»¶
    if(fd==-1)E_MSG("open",-1);

    int r=read(fd,buff,128);            //è¯»å–ç®¡é“æ–‡ä»¶				//âš ï¸ å¦‚æœè¯»å–ä¸åˆ°ç®¡é“å†…çš„å†…å®¹ä¼šé˜»å¡ç­‰å¾…
    write(1,buff,r);                    //å†™å…¥åˆ°æ ‡å‡†è¾“å‡º
    close(fd);                          //å…³æ‰æ–‡ä»¶æè¿°ç¬¦
    return 0;
}

```



#### ä¿¡å·

****

![](allPic/Macdo2023-04-20 11.07.26.jpg)

![](allPic/Macdo2023-04-20 11.42.16.jpg)

![](allPic/Macdo2023-04-20 11.27.21.jpg)

![](allPic/Macdo2023-04-21 11.33.42.jpg)



æŸ¥çœ‹æ“ä½œç³»ç»Ÿæä¾›çš„ä¸­æ–­ä¿¡å·

`kill -l`

```bash
kill -l 

 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP
 6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1
11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM
16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP
21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ
26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR
31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3
38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8
43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13
48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12
53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7
58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2
63) SIGRTMAX-1  64) SIGRTMAX

ä¿¡å·çš„ç¼–å·ï¼Œå®

2) SIGINT  ç»ˆæ­¢è¿›ç¨‹Ctrl + C
20)SIGSTP  åœæ­¢è¿›ç¨‹ Ctrl + Z
9) SIGKILL æ€æ­»ä¿¡å·
11) æ®µé”™è¯¯ï¼Œè¿›ç¨‹è®¿é—®ä¸å±äºè‡ªå·±çš„å†…å­˜ä¼šè§¦å‘æ“ä½œç³»ç»Ÿç»™è¿›ç¨‹å‘é€ä¿¡å·
12ï¼‰ è‡ªå·±å®šä¹‰
14) é—¹é’Ÿä¿¡å·
17ï¼‰SIGCHLD å­è¿›ç¨‹ç»ˆæ­¢çš„æ—¶å€™ï¼Œå­è¿›ç¨‹ç»™çˆ¶è¿›ç¨‹å‘é€SIGCHLD ä¿¡å·  çˆ¶è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹çš„17å·ä¿¡å·



SIGSTOP(19)ï¼šè¯¥ä¿¡å·å¯ä»¥æš‚åœä¸€ä¸ªè¿›ç¨‹ï¼Œä»¥ä¾¿ç¨åå°†å…¶æ¢å¤è¿è¡Œã€‚
SIGCONT(18)ï¼šè¯¥ä¿¡å·ç›¸å¯¹äºSIGSTOPï¼Œå¯ä»¥è®©å› SIGSTOPè€ŒæŒ‚èµ·çš„è¿›ç¨‹æ¢å¤è¿è¡Œã€‚

  

```



**å‘½ä»¤è¡Œç»™è¿›ç¨‹å‘æ¶ˆæ¯**

```bash
kill -ä¿¡å·ç¼–å· çº¿ç¨‹pid
	
	kill -9 1234 ç»™1234 ä¿¡å·å‘é€9å·ä¿¡å·
```



**ä»£ç ç»™è¿›ç¨‹å‘é€æ¶ˆæ¯**

****

**KILL(2)**

```c
 #include <sys/types.h>
 #include <signal.h>

 int kill(pid_t pid, int sig);

è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥-1
 æ‰©å……ï¼šç»™è¿›ç¨‹è‡ªå·±å‘é€ä¿¡å· 
  	kill(getpid(),sig_num);//raise(3)çš„å®ç°
```

**RAISE(3)   **

```c
 #include <signal.h>

 int raise(int sig);
åŠŸèƒ½:å‘é€ä¸€ä¸ªä¿¡å·ç»™è°ƒç”¨è€…
  ç›¸å½“äº signal(getpid(),9);
```

**ALARM(2) ** 

```c
#include <unistd.h>

unsigned int alarm(unsigned int seconds	);
åŠŸèƒ½ï¼š
  åœ¨æŒ‡å®šçš„æ—¶é—´äº§ç”ŸSIGNALRM(å®šæ—¶) ä¿¡å·ï¼Œå¹¶å°†å…¶ä¼ é€ç»™å½“å‰è¿›ç¨‹
å‚æ•°ï¼š
  second æŒ‡å®šçš„ç§’æ•°é‡
 è¿”å›å€¼ è¿”å›ä¸Šæ¬¡è®¾å®šçš„é—¹é’Ÿæœªå®Œæˆæ—¶é—´æ—¶é—´å€¼ï¼Œå¦‚æœä¸Šæ¬¡é—¹é’Ÿå·²ç»æ‰§è¡Œï¼Œè¿”å›0
 æ³¨æ„ï¼š
  alarm(0) å–æ¶ˆåŸæ¥è®¾ç½®çš„é—¹é’Ÿ
```

```c
int main(void){

	alarm(5); //å®šæ—¶5ç§’ è¶…æ—¶ä¼šç»™è¿›ç¨‹å‘é€alarm ä¿¡å·ï¼Œåœæ­¢è¿›ç¨‹
	int i=1;
	for(;i<500000;i++){
		printf("%d\n",i);
	}
	int time=alarm(0);  //å–æ¶ˆalarm é—¹é’Ÿ å˜é‡time å­˜æ”¾çš„æ˜¯æœªè§‰æ—¶é—´ å‰©ä½™æ—¶é—´
	
	#if 0
	alarm(1);			//å¦‚æœå®šä¹‰çš„æ—¶é—´é0 ä¼šé‡æ–°è®¾ç½®alarmæ—¶é—´
	#endif

	printf("alarm å‰©ä½™æ—¶é—´ä¸º%d ç§’",time);
	return 0;

}

```

**è®©è¿›ç¨‹ç¡çœ **

****

pause

```c
#include <unistd.h>

int pause(void);

åŠŸèƒ½:
	æ˜¯å½“å‰çš„è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼ŒçŸ¥é“æœ‰ä¿¡å·æ‰åˆ°è¾¾ (å¯ä»¥sigal è‡ªå·±å®šä¹‰ä¿¡å·å‡½æ•°)
è¿”å›å€¼ï¼š
	-1 åªæœ‰è¢«ä¿¡å·æ‰“æ–­çš„æ—¶å€™æ‰è¿”å›-1ï¼Œè¦ä¸ç„¶ä¼šä¸€ç›´ä¼‘çœ ;
```

```c
#include <unistd.h>
#include <stdio.h>
#include <signal.h>

//è‡ªå®šä¹‰çš„ä¿¡å·å‡½æ•°
void conti(int n){
    printf("pid : %d æ¥æ”¶åˆ° %då·ä¿¡å·äº†,æ‰§è¡Œä¸‹é¢çš„ä»£ç \n ",getpid(),n);
}   

int main(){
    
    //æ³¨å†Œå‡½æ•°åˆ°ä¿¡å·    
    signal(10,conti);

    printf("pause the program(pid %d,æ³¨å†Œä¿¡å·ä¸º10)...\n",getpid());
    pause();

    printf("countinue the progream...\n");
    return 0;
}
```



**ä¿¡å·çš„é˜»å¡**

****

é˜»å¡ä¿¡å·æ˜¯æŒ‡è¿›ç¨‹å°†æŸäº›ä¿¡å·è®¾ç½®ä¸ºé˜»å¡çŠ¶æ€ï¼Œä»è€Œåœ¨è¯¥çŠ¶æ€ä¸‹å¿½ç•¥å®ƒä»¬ã€‚å½“ä¸€ä¸ªä¿¡å·è¢«é˜»å¡åï¼Œå¦‚æœè¯¥ä¿¡å·è¢«å‘é€ç»™è¿›ç¨‹ï¼Œå®ƒä¸ä¼šè¢«å¤„ç†ï¼Œä¹Ÿä¸ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿè°ƒç”¨æˆ–ç”¨æˆ·æ€è¿›ç¨‹ä»£ç ã€‚

é€šè¿‡è°ƒç”¨`sigprocmask`å‡½æ•°å¯ä»¥å®ç°å¯¹è¿›ç¨‹ä¿¡å·å±è”½é›†åˆï¼ˆsignal maskï¼‰çš„ä¿®æ”¹ã€‚è¯¥å‡½æ•°æä¾›äº†ä¸€ç»„å‚æ•°æ¥æ§åˆ¶å“ªäº›ä¿¡å·è¦è¢«æ·»åŠ åˆ°é˜»å¡é›†åˆä¸­ï¼Œæˆ–ä»é˜»å¡é›†åˆä¸­ç§»é™¤

**è¿›ç¨‹çš„pcbä¸­æœ‰ä¸¤ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œé¢çš„æ˜¯ ä½ã€‚åªèƒ½æ˜¯0 æˆ–è€…1  True or False**

blocking æ•°ç»„ **ä¿¡å·åˆ°è¾¾è¿›ç¨‹æ—¶ï¼Œå®ƒä¸ä¼šè¢«å¤„ç†**

```
0	è¿›ç¨‹å¯¹è¯¥ä¿¡å·ä¸é˜»å¡
1 è¿›ç¨‹é˜»å¡è¯¥ä¿¡å·
```

pending æ•°ç»„ **å‘³è§‰ä¿¡å·ï¼Œå·²ç»å‘ç”Ÿä½†æ˜¯è¿˜æ²¡å¤„ç†çš„ä¿¡å·**

```
0 è¯¥ä¿¡å·æ²¡æœ‰å‘ç”Ÿ
1 è¯¥ä¿¡å·å‘ç”Ÿäº†è¿˜æ²¡æœ‰å¤„ç†
```



**ä¿¡å·é›†**

```c
 #include <signal.h>

 int sigemptyset(sigset_t *set);

 int sigfillset(sigset_t *set);

 int sigaddset(sigset_t *set, int signum);

 int sigdelset(sigset_t *set, int signum);

 int sigismember(const sigset_t *set, int signum);
```





![](allPic/Macdo2023-04-21 11.53.07.jpg)



**è®¾ç½®è¿›ç¨‹ä¿¡å·æ©ç é›†**

****
**1æŠŠä¿¡å·å±è”½æ‰**

```c
 #include <signal.h>

 /* Prototype for the glibc wrapper function */
 int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);

å‚æ•°:
	how å–å€¼
    SIG_BLOCK	: å°†setä¿¡å·é›†å’ŒåŸæ¥çš„æ–°å·é›†åšå¹¶é›† è®¾ç½®ä¸ºè¿›ç¨‹çš„ä¿¡å·æ©ç é›†   ï¼ˆæˆä¸ºæ©ç  ä¿¡å·å¤±æ•ˆå¤±æ•ˆï¼‰
    SIG_UNBLOCKï¼šå°†setä¿¡å·é›†å’ŒåŸæ¥çš„æ–°ä¿¡é›†ç§»é™¤  è®¾ç½®ä¸ºè¿›ç¨‹çš„ä¿¡å·æ©ç é›†  è§£é™¤ä¿¡å·çš„é¢œå—é›†åˆ
    SIG_SETMASK: æŠŠä¿¡å·é›†èˆè®¾ç½®ä¸ºè¿›ç¨‹çš„ä¿¡å·æ©ç é›†åˆ 
	set
    ç”¨äºæŒ‡å®šçš„ä¿¡å·é›†åˆ
  oldset
    ç”¨äºä¿å­˜åŸæ¥çš„ä¿¡å·é›† å¦‚æœè®¾ç½®ä¸ºNULLï¼Œæ ‡è¯†ä¸ä¿å­˜åŸæ¥çš„ä¿¡å·é›†
      
  è¿”å›å€¼ï¼š
      æˆåŠŸ0
      é”™è¯¯ -1 errnoè¢«è®¾ç½®ç›¸åº”çš„é”™è¯¯ç 
```

**ä¿¡å·é›†**

```c
#include <signal.h>

/* Prototype for the glibc wrapper function */
int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);

/* Prototype for the underlying system call */
int rt_sigprocmask(int how, const kernel_sigset_t *set,
                  kernel_sigset_t *oldset, size_t sigsetsize);

/* Prototype for the legacy system call (deprecated) */
int sigprocmask(int how, const old_kernel_sigset_t *set,
               old_kernel_sigset_t *oldset);

Feature Test Macro Requirements for glibc (see feature_test_macros(7)):

sigprocmask(): _POSIX_C_SOURCE
  
sigprocmaskå‡½æ•°ç”¨äºæŸ¥æ‰¾æˆ–ä¿®æ”¹è¿›ç¨‹çš„ä¿¡å·å±è”½å­—ï¼Œå…¶å‚æ•°åŒ…æ‹¬ï¼š

howï¼šè¡¨ç¤ºå¦‚ä½•ä¿®æ”¹ä¿¡å·å±è”½å­—ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼š
    SIG_BLOCKï¼šå°†å½“å‰ä¿¡å·å±è”½å­—ä¸setæŒ‡å‘çš„ä¿¡å·é›†åˆçš„å¹¶é›†æ›¿æ¢ã€‚
    SIG_UNBLOCKï¼šä»å½“å‰ä¿¡å·å±è”½å­—ä¸­åˆ é™¤setæŒ‡å‘çš„ä¿¡å·é›†åˆã€‚
    SIG_SETMASKï¼šç”¨setæŒ‡å‘çš„ä¿¡å·é›†åˆæ›¿æ¢å½“å‰çš„ä¿¡å·å±è”½å­—ã€‚
  
setï¼šæŒ‡å‘ä¿¡å·é›†åˆçš„æŒ‡é’ˆã€‚å¦‚æœset=NULLï¼Œåˆ™sigprocmaskå‡½æ•°ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚
  
oldsetï¼šè¾“å‡ºå‚æ•°ï¼ŒæŒ‡å‘ä¸€ä¸ªå…ˆå‰çš„ä¿¡å·å±è”½å­—çš„æŒ‡é’ˆã€‚å¦‚æœoldset=NULLï¼Œåˆ™å¿½ç•¥æ­¤å‚æ•°ã€‚
  ï¼ˆå¯ä»¥ç”¨äºä¹‹åæ¢å¤ä¿¡å·ï¼‰
```



**æœªå†³ä¿¡å·**

****

åœ¨Linuxä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç§°ä¸ºpendingä¿¡å·çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨åŒ…å«è¿›ç¨‹å½“å‰æ­£åœ¨ç­‰å¾…å¤„ç†çš„ä¿¡å·ã€‚ pendingæ•°ç»„æ˜¯æŒ‡ç”¨äºè®°å½•è¿›ç¨‹æŒ‚èµ·ï¼ˆpendingï¼‰ä¿¡å·çŠ¶æ€çš„æ•°æ®ç»“æ„ï¼Œåœ¨å†…æ ¸ä¸­ç»´æŠ¤è¯¥åˆ—è¡¨ã€‚

å½“ä¿¡å·è¢«ä¼ é€’ç»™è¿›ç¨‹æ—¶ï¼Œå®ƒå¯èƒ½ä¼šç«‹å³å¤„ç†ï¼Œä¹Ÿå¯èƒ½è¢«æ·»åŠ åˆ°è¯¥è¿›ç¨‹çš„pendingä¿¡å·åˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿ç¨åè¿›è¡Œå¤„ç†ã€‚ pendingæ•°ç»„ä¼šè®°å½•å“ªäº›ä¿¡å·è¢«æŒ‚èµ·ï¼Œå¾…ç¨åè¿›ç¨‹å†æ¬¡æ£€æŸ¥æ—¶å¤„ç†ã€‚è¿™æ ·æœ‰åŠ©äºç¡®ä¿ä¿¡å·ä¸ä¼šä¸¢å¤±ï¼Œå¹¶èƒ½è®©è¿›ç¨‹æŒ‰ç…§é¢„æœŸçš„æ–¹å¼å“åº”ä¿¡å·ã€‚

åŸºäºpendingæ•°ç»„ï¼Œè¿›ç¨‹å¯ä»¥å®ç°é€‰æ‹©æ€§åœ°é˜»å¡æˆ–è§£é™¤é˜»å¡æŸäº›ä¿¡å·ï¼Œä»¥åŠç¡®å®šå½“å‰æ˜¯å¦æœ‰ä¿¡å·éœ€è¦å¤„ç†ï¼Œä»è€Œå®ç°æ›´é«˜æ•ˆå’Œç²¾ç¡®çš„ä¿¡å·å¤„ç†ã€‚



```c
//å®šä¹‰ä¸€ä¸ªsigset_tçš„å˜é‡
sigset_t pset;

//è·å–è¿›ç¨‹çš„å‘³è§‰ä¿¡å·é›†,psetå­˜æ”¾çš„æ˜¯è¿›ç¨‹çš„å‘³è§‰ä¿¡å·é›†
sigpending(&pset);

//åˆ¤æ–­æ˜¯å¦ä¸ºå‘³è§‰ä¿¡å·
int is=sigismember(&pset,2);
if(is ==-1) E_MSG("sigismember",-1);
is?printf("yes\n"):printf("NO\n");


2å·ä¿¡å·æ˜¯ctrl+c
å·²ç»è®¾ç½®ä¸ºé˜»å¡2å·ä¿¡å·,peddingæ•°ç»„
å½“é”®ç›˜æ²¡æœ‰å‘é€ 2å·ä¿¡å·çš„æ—¶å€™ 2å·ä¿¡å·ä¸æ˜¯æœªè§‰ä¿¡å·ï¼Œ
ä½†æ˜¯å‘é€äº†2å·ä¿¡å·ï¼Œpeddingæ•°ç»„ ä¼šè®¾ç½®2å·ä¿¡å·ä¸ºTrue
```

#### system V IPC

****

system V IPC åˆ†ä¸ºä¸€ä¸‹ä¸‰ç§ï¼Œä¸‰ç§éƒ½è¦æœ‰å”¯ä¸€çš„ä¸€ä¸ªé”®ï¼Œç„¶åç”¨è¯¥é”®å‘æ“ä½œç³»ç»Ÿç”³è¯·ä¸‰ç§ä¸é€šçš„idï¼ˆå…±äº«å†…å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¿¡å·é‡é›†åˆï¼‰

1. æ¶ˆæ¯é˜Ÿåˆ—

2. å…±äº«å†…å­˜
3. ä¿¡å·é‡é›†åˆ

```bash
ipcs å‘½ä»¤
------ Message Queues -------- æ¶ˆæ¯é˜Ÿåˆ—
key        msqid      owner      perms      used-bytes   messages    

------ Shared Memory Segments -------- å…±äº«å†…å­˜
key        shmid      owner      perms      bytes      nattch     status      

------ Semaphore Arrays --------	ä¿¡å·é‡é›†åˆ
key        semid      owner      perms      nsems     

```

ä¸‰ç§éƒ½è¦æœ‰å”¯ä¸€ä¸ªé”®ï¼Œkey 

é¦–å…ˆè¦æœ‰ä¸€ä¸ªé”®å€¼ï¼Œç„¶åä½¿ç”¨ä¸‰ç§å…¶ä¸­



```c
key_t ftok(const char *pathname, int proj_id); 

æ˜¯çš„ï¼Œproj_idæ˜¯ä¸€ä¸ªç”±ç”¨æˆ·å®šä¹‰çš„æ•´æ•°å€¼ï¼Œç›®çš„æ˜¯ç¡®ä¿åŒä¸€è·¯å¾„åçš„ä¸åŒæ¶ˆæ¯é˜Ÿåˆ—æœ‰ä¸åŒçš„æ ‡è¯†ç¬¦ï¼ˆå³keyï¼‰ã€‚åœ¨ ftok å‡½æ•°ä¸­ï¼Œå¦‚æœåŒä¸€ä¸ªè·¯å¾„åå’ŒåŒä¸€ä¸ªproj_idéƒ½ä¼ é€’ç»™å‡½æ•°ï¼Œåˆ™å®ƒä»¬å°†è¿”å›ç›¸åŒçš„keyå€¼ï¼Œè¿™æ ·å°±å¯ä»¥åˆ›å»ºæŒ‡å‘åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„å¤šä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨å›ºå®šçš„ç‰¹å®šå€¼æˆ–å…¶ä»–æ–¹æ³•æ¥ç”Ÿæˆå”¯ä¸€çš„proj_idä¼šæ›´å¥½ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œproj_idå¿…é¡»åœ¨0åˆ°255ä¹‹é—´ï¼Œå¹¶ä¸”å”¯ä¸€åœ°åœ¨è·¯å¾„åä¸‹ç¡®å®šæŸä¸ªIPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰å¯¹è±¡çš„keyã€‚
```



#### å…±äº«å†…å­˜

****

**åˆ›å»ºå…±äº«å†…å­˜çš„æ­¥éª¤**

1. `ftok()`å‡½æ•°å‘å†…æ ¸ç©ºé—´é¢†å–ä¸€ä¸ªkey_t ç±»å‹çš„ é”®
2. `shmget()` ç”¨key_t å‘æ“ä½œç³»ç»Ÿç”³è¯·å…±äº«å†…å­˜çš„id (shmid)
3. `shmat()` ç”¨å…±äº«å†…å­˜idæ˜ å°„åˆ°ï¼ˆé™„åŠ åˆ°è°ƒç”¨è¿›ç¨‹çš„å†…å­˜ä¸­ï¼‰ è¿”å›å€¼ä¸ºvoid* éœ€è¦



é¦–å…ˆè¦ç”¨ftok()å‡½æ•°è·å–ä¸€ä¸ªweiyiçš„key åœ¨å†…æ ¸ç©ºé—´ä¸­é¢†å–ä¸€ä¸ªèº«ä»½è¯ key æ‰èƒ½åœ¨å†…æ ¸ç©ºé—´ä¸­æ“ä½œå…±äº«å†…å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ— ç­‰ç­‰

å¤šä¸ªè¿›ç¨‹ä½¿ç”¨å…±äº«å†…å­˜çš„æ—¶å€™ï¼Œå¯¹å…±äº«å†…å­˜è¯»å–æ˜¯å¼‚æ­¥çš„ï¼Œä¼šä¸ç¨³å®šï¼Œå¯ä»¥é‡‡ç”¨ä¿¡å·å¯¹è¿›ç¨‹æ§åˆ¶

æ¯”å¦‚è¿›ç¨‹Aå¯¹å…±äº«å†…å­˜æ“ä½œçš„æ—¶å€™ï¼Œè¿›ç¨‹Aå¯ä»¥ç»™è¿›ç¨‹Bå‘é€ä¸€ä¸ªä¿¡å·ï¼Œè®©Bè¿›ç¨‹æš‚åœç­‰ç­‰



<img src="allPic/Macdo2023-04-23 10.40.15.jpg" style="zoom:50%;" />

**å…±äº«å†…å­˜çš„æ“ä½œå‡½æ•°**

```c
 #include <sys/ipc.h>
 #include <sys/shm.h>

 int shmget(key_t key, size_t size, int shmflg);

å‚æ•°
	key  ç”¨ftok()å‡½æ•°çš„è¿”å›å€¼
	size   æŒ‡å®šäº†å…±äº«å†…å­˜æ®µçš„å¤§å°
  shmflg
  	IPC_CREAT
  	IPC_EXCL
  	mode
è¿”å›å€¼
  æˆåŠŸ è¿”å›å…±äº«å†…å­˜çŸ­çš„id
  å¤±è´¥ -1 errnoè¢«è®¾ç½®

```





**ä½¿ç”¨å…±äº«å†…å­˜**

****

```c
 #include <sys/types.h>
 #include <sys/shm.h>

 void *shmat(int shmid, const void *shmaddr, int shmflg);
åŠŸèƒ½:å°†å…±äº«å†…å­˜æ®µé™„åŠ åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´
å‚æ•°:
	shmid:	
				æŒ‡å®šäº†å…±äº«å†…å­˜çŸ­çš„idï¼Œå°†è¿™ä¸ªå…±äº«å†…å­˜çŸ­é™„åŠ åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´
  shmaddr:
				NULL ç³»ç»Ÿé€‰æ‹©è¿›ç¨‹çš„å…·ä½“åœ°å€ç©ºé—´
  shmflg:
				0
è¿”å›å€¼:
		æˆåŠŸ é™„åŠ åˆ°è¿›ç¨‹çš„å…·ä½“åœ°å€
    é”™è¯¯(void *) -1
 
 
```

```c
int shmdt(const void *shmaddr);

åŠŸèƒ½ï¼šå°†å…±äº«å†…å­˜çŸ­ä»è¿›ç¨‹åœ°å€ç©ºé—´è§£é™¤é™„åŠ 
å‚æ•°ï¼š
	shmaddr:æŒ‡å®šäº†å…±äº«å†…å­˜æ®µçš„å…·ä½“åœ°å€   shmat()çš„è¿”å›å€¼
	
```



**ç¤ºèŒƒä»£ç **

****

æ–°å»ºä¸€ä¸ªå…±äº«å†…å­˜å¹¶ä¸”å†™å…¥æ•°æ®

```c
#include <t_stdio.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>

int main(int argc,char *argv[]){
    //è·å–ä¸€ä¸ªSYSTEM V IPC çš„é”®å€¼

    key_t key=ftok(argv[0],32);
    printf("key=0x%x",key);
    if(key==-1)E_MSG("ftok",-1);

    //åˆ†é…å…±äº«å†…å­˜ å†…å­˜é¡µ æŒ‰ç…§4Kæ¥åˆ†é…  4KB  
    //éœ€è¦æŒ‰ä½æˆ– ä¸€ä¸‹æƒé™ IPC_EXCL å¦‚æœæ–‡ä»¶å­˜åœ¨å°±å¤±è´¥
    //IPC_CREAT æ–°å»º
    //IPC_EXCL å¦‚æœæ–‡ä»¶å­˜åœ¨å°±å¤±è´¥
    int shm=shmget(key,1024,IPC_CREAT|IPC_EXCL|0644);
    if(shm == -1)E_MSG("shmget",-1);

    printf("\nshmid:%d\n",shm);

    void *temp=shmat(shm,NULL,0);
    if(temp==(void *)-1)E_MSG("shmat",-1);

    strcpy(temp,"hello,kitty");
    printf("%s\n",(char *)temp);

    

    return 0;
}
```



è¯»å–å…±äº«å†…å­˜çš„æ•°æ®

****

```c
#include <t_stdio.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>

int main(int argc,char *argv[]){
    //è·å–ä¸€ä¸ªSYSTEM V IPC çš„é”®å€¼
    int shm=6;
	
    void *temp=shmat(shm,NULL,0);
    if(temp==(void *)-1)E_MSG("shmat",-1);

    strcpy(temp,"hello,kitty");
    printf("%s\n",(char *)temp);

    

    return 0;
}
```



**å‘½ä»¤è¡Œé‡Šæ”¾å…±äº«å†…å­˜**

***

è¦é‡Šæ”¾å…±äº«å†…å­˜ï¼Œå¯ä»¥ä½¿ç”¨`ipcrm`å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å¯ç”¨äºåˆ é™¤ç”±ç³»ç»Ÿåˆ›å»ºçš„IPCå¯¹è±¡ï¼ˆä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜æ®µå’Œä¿¡å·é‡ï¼‰ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨ `ipcrm` å‘½ä»¤é‡Šæ”¾å…±äº«å†…å­˜çš„æ­¥éª¤ï¼š

1. é¦–å…ˆè¿è¡Œ `ipcs` å‘½ä»¤ä»¥è·å–ç³»ç»Ÿä¸­ç°æœ‰çš„IPCå¯¹è±¡çš„åˆ—è¡¨ã€‚

2. æ‰¾åˆ°æ‚¨è¦é‡Šæ”¾çš„å…±äº«å†…å­˜æ®µçš„IDï¼Œå¹¶è®°å½•å®ƒã€‚

3. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡Šæ”¾å…±äº«å†…å­˜æ®µï¼š

   DiffCopyInsertNew

   ```
   ipcrm -m <shmid>
   ```

   å…¶ä¸­ `<shmid>` æ˜¯æ‚¨æƒ³è¦é‡Šæ”¾çš„å…±äº«å†…å­˜æ®µçš„IDã€‚

4. æœ€åï¼Œå†æ¬¡è¿è¡Œ `ipcs` å‘½ä»¤ä»¥ç¡®ä¿å·²æˆåŠŸåˆ é™¤å…±äº«å†…å­˜æ®µã€‚



#### æ¶ˆæ¯é˜Ÿåˆ—

****

1. `ftok()` å‡½æ•°é€šå¸¸ä¸æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ `key_t` ç±»å‹çš„é”®å€¼ã€‚è¿™ä¸ªé”®å€¼å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºå’Œè®¿é—®ç³»ç»Ÿä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

2. `msgget()`åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—id

3. åˆ›å»ºæ¶ˆæ¯

   ```c
   struct msgbuf {  //æ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„
       long mtype;
       char mtext[100];
   };
   
   struct msgbuf message;//åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
   message.mtype = 1;
   strcpy(message.mtext, "This is a test message.");
   ```

4. `msgsnd()`ä¼ é€’æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—

   ```c
   int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg); //ä¼ é€’æ¶ˆæ¯ç»™æ¶ˆæ¯é˜Ÿåˆ—
   
   if(msgsnd(msgid, &message, sizeof(message.mtext), 0) == -1)
   {
       perror("msgsnd");
       exit(1);
   }
   ```

5. `msgrcv()`æ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯

   ```c
   ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp,
                         int msgflg);
   ```




**å‘é€æ¶ˆæ¯**

```c
#if 0
  ftok() å‡½æ•°é€šå¸¸ä¸æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ key_t ç±»å‹çš„é”®å€¼ã€‚è¿™ä¸ªé”®å€¼å¯ä»¥è¢«ç”¨æ¥åˆ›å»ºå’Œè®¿é—®ç³»ç»Ÿä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚

  ftok() å‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šä¸€ä¸ªå¯è®¿é—®çš„æ–‡ä»¶è·¯å¾„åå’Œä¸€ä¸ªé¡¹ç›®æ ‡è¯†IDï¼Œé€šå¸¸ç”¨å­—ç¬¦æˆ–æ•°å­—è¡¨ç¤ºã€‚å®ƒä¼šæ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°è®¡ç®—å¹¶è¿”å›ä¸€ä¸ªå¯¹åº”çš„é”®å€¼ã€‚å¦‚æœåœ¨ä¸åŒçš„è¿›ç¨‹æˆ–ä»£ç ç‰‡æ®µä¸­ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶è·¯å¾„åå’Œé¡¹ç›®æ ‡è¯†IDå‚æ•°ï¼Œftok() å‡½æ•°å°†å§‹ç»ˆè¿”å›ç›¸åŒçš„é”®å€¼ã€‚

  ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ ftok() å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªå…·æœ‰å”¯ä¸€é”®å€¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š
#endif
    
    
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <stdio.h>
#include <stdlib.h>

int main()
{
    key_t key;
    int msgid;

    // Generate a unique key using ftok()
    key = ftok("message_queue.c", 'b');

    // Create the message queue with the generated key
    msgid = msgget(key, 0666 | IPC_CREAT);
    if (msgid == -1)
    {
        perror("msgget");
        exit(1);
    }
    printf("Message queue created with key %d.\n", key);

    return 0;
}

```

**æ¥æ”¶æ¶ˆæ¯**

```c
#if 0
	è¦å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ msgsnd() å‡½æ•°ã€‚è¯¥å‡½æ•°éœ€è¦æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„æ ‡è¯†ç¬¦ã€è¦å‘é€çš„æ¶ˆæ¯å’Œæ¶ˆæ¯çš„é•¿åº¦ç­‰å‚æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºäº†å¦‚ä½•å°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼š
#endif 
  
  #include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/msg.h>

struct msgbuf {
    long mtype;
    char mtext[100];
};

int main()
{
    key_t key;
    int msgid;
    struct msgbuf message;

    // Generate a unique key using ftok()
    key = ftok("message_queue.c", 'b');

    // Access the message queue with the generated key
    msgid = msgget(key, 0666 | IPC_CREAT);
    if (msgid == -1)
    {
        perror("msgget");
        exit(1);
    }
    printf("Message queue created with key %d.\n", key);

    //Receive the message from the queue
    if(msgrcv(msgid, &message, sizeof(message.mtext), 1, 0) == -1)
    {
        perror("msgrcv");
        exit(1);
    }

    printf("Message received from the queue: %s\n", message.mtext);

    return 0;
}

```


â€‹	

#### ä¿¡å·é‡é›†ï¼ˆç•¥ï¼‰

****

**ä¿¡å·é‡é›† æ˜¯ä¸æ˜¯ç»å¸¸æ­é…å…±äº«å†…å­˜ä½¿ç”¨**

æ˜¯çš„ï¼Œåœ¨è¿›ç¨‹é—´å…±äº«æ•°æ®æ—¶ï¼Œå¸¸å¸¸éœ€è¦ä½¿ç”¨ä¿¡å·é‡é›†åˆå’Œå…±äº«å†…å­˜ä¸¤ç§æœºåˆ¶ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚å…±äº«å†…å­˜ç”¨äºåœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«æ•°æ®ï¼Œè€Œä¿¡å·é‡é›†åˆåˆ™ç”¨äºæ§åˆ¶å¯¹å…±äº«å†…å­˜çš„è®¿é—®ï¼Œé˜²æ­¢å¹¶å‘è®¿é—®é€ æˆçš„æ•°æ®ä¸ä¸€è‡´æˆ–ç«æ€æ¡ä»¶ç­‰é—®é¢˜ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨ä½¿ç”¨å…±äº«å†…å­˜æ—¶ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜æ®µï¼Œå¹¶å°†è¯¥å†…å­˜æ®µæ˜ å°„åˆ°å„ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ï¼Œä»è€Œå®ç°å¤šè¿›ç¨‹å…±äº«æ•°æ®ã€‚ç„¶åï¼Œé€šè¿‡ä½¿ç”¨ä¿¡å·é‡é›†åˆæ¥æ§åˆ¶å¯¹å…±äº«å†…å­˜æ®µçš„è®¿é—®ï¼Œä¾‹å¦‚é€šè¿‡äº’æ–¥ä¿¡å·é‡ä¿è¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ“ä½œå…±äº«å†…å­˜ï¼Œæˆ–è€…ä½¿ç”¨æ¡ä»¶ä¿¡å·é‡ç­‰å¾…å…¶ä»–è¿›ç¨‹é‡Šæ”¾å…±äº«å†…å­˜ä½¿ç”¨æƒç­‰ã€‚

å› æ­¤ï¼Œä¿¡å·é‡é›†åˆå’Œå…±äº«å†…å­˜æ˜¯ç»å¸¸æ­é…ä½¿ç”¨çš„ä¸¤ç§æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šè¿›ç¨‹ç¨‹åºä¸­å®ç°æ•°æ®å…±äº«å’ŒåŒæ­¥ã€‚





ä½¿ç”¨ä¿¡å·é‡é›†åˆæ¥æ§åˆ¶å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºçš„äº’æ–¥è®¿é—®æˆ–åŒæ­¥æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ä¿¡å·é‡é›†åˆï¼š

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>

int main()
{
    int semid;
    struct sembuf sb;

    // Create a semaphore set with three semaphores
    semid = semget(IPC_PRIVATE, 3, IPC_CREAT | 0666);
    if (semid == -1)
    {
        perror("semget");
        exit(1);
    }

    // Initialize the first and second semaphores
    semctl(semid, 0, SETVAL, 1); // Initialized to 1 (available)
    semctl(semid, 1, SETVAL, 0); // Initialized to 0 (not available)

    // Fork a child process
    pid_t pid = fork();
    if (pid == -1)
    {
        perror("fork");
        exit(1);
    }
    else if (pid == 0) // Child Process
    {
        // Acquire the second semaphore
        sb.sem_num = 1;
        sb.sem_op = -1;
        sb.sem_flg = 0;
        if (semop(semid, &sb, 1) == -1)
        {
            perror("semop");
            exit(1);
        }

        printf("Child Process has acquired the semaphore.\n");
        sleep(3);

        // Release the first semaphore
        sb.sem_num = 0;
        sb.sem_op = 1;
        sb.sem_flg = 0;
        if (semop(semid, &sb, 1) == -1)
        {
            perror("semop");
            exit(1);
        }

        printf("Child Process has released the semaphore.\n");
    }
    else // Parent Process
    {
        // Acquire the first semaphore
        sb.sem_num = 0;
        sb.sem_op = -1;
        sb.sem_flg = 0;
        if (semop(semid, &sb, 1) == -1)
        {
            perror("semop");
            exit(1);
        }

        printf("Parent Process has acquired the semaphore.\n");
        sleep(3);

        // Release the second semaphore
        sb.sem_num = 1;
        sb.sem_op = 1;
        sb.sem_flg = 0;
        if (semop(semid, &sb, 1) == -1)
        {
            perror("semop");
            exit(1);
        }

        printf("Parent Process has released the semaphore.\n");
    }

    // Remove the semaphore set
    semctl(semid, 0, IPC_RMID);

    return 0;
}

```

ä¸Šé¢çš„ä»£ç åˆ›å»ºä¸€ä¸ªåŒ…å«ä¸‰ä¸ªä¿¡å·é‡çš„ä¿¡å·é‡é›†åˆï¼Œå¹¶åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªä¿¡å·é‡ã€‚ç„¶åï¼Œå®ƒ fork ä¸€ä¸ªå­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­è·å–ç¬¬äºŒä¸ªä¿¡å·é‡ï¼Œç­‰å¾…3ç§’é’Ÿï¼Œç„¶åé‡Šæ”¾ç¬¬ä¸€ä¸ªä¿¡å·é‡ã€‚åœ¨çˆ¶è¿›ç¨‹ä¸­è·å–ç¬¬ä¸€ä¸ªä¿¡å·é‡ï¼Œç­‰å¾…3ç§’é’Ÿï¼Œç„¶åé‡Šæ”¾ç¬¬äºŒä¸ªä¿¡å·é‡ã€‚

æˆ‘ä»¬ä½¿ç”¨ `semget()` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡å·é‡é›†åˆï¼Œå¹¶ä¸ºå…¶ä¸­çš„æ¯ä¸ªä¿¡å·é‡åˆ†é…å”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚ç„¶åï¼Œä½¿ç”¨ `semctl()` å‡½æ•°å¯¹ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªä¿¡å·é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå°†å®ƒä»¬çš„å€¼åˆ†åˆ«è®¾ç½®ä¸º 1 å’Œ 0ã€‚

åœ¨å­è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `semop()` å‡½æ•°è·å–ç¬¬äºŒä¸ªä¿¡å·é‡ï¼Œè¯¥å‡½æ•°éœ€è¦æŒ‡å®šä¿¡å·é‡é›†åˆçš„æ ‡è¯†ç¬¦ã€è¦ä¿®æ”¹çš„ä¿¡å·é‡çš„ç¼–å·å’Œæ“ä½œç±»å‹ç­‰å‚æ•°ã€‚å¦‚æœè·å–ä¿¡å·é‡å¤±è´¥ï¼Œæˆ‘ä»¬æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºç¨‹åºã€‚ç±»ä¼¼åœ°ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `semop()` å‡½æ•°è·å–ç¬¬ä¸€ä¸ªä¿¡å·é‡ï¼Œå¹¶ç­‰å¾…3ç§’é’Ÿï¼Œç„¶åé‡Šæ”¾ç¬¬äºŒä¸ªä¿¡å·é‡ã€‚

æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ `semctl()` å‡½æ•°åˆ é™¤ä¿¡å·é‡é›†åˆï¼Œä½¿å…¶ä¸å†è¢«ä½¿ç”¨ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨ä¿¡å·é‡é›†åˆæ—¶ï¼Œå¿…é¡»å°å¿ƒé¿å…æ­»é”å’Œç«äº‰æ¡ä»¶ã€‚å¦‚æœå¤šä¸ªè¿›ç¨‹åŒæ—¶ç­‰å¾…ä¸€ä¸ªæˆ–å¤šä¸ªä¿¡å·é‡ï¼Œå°±å¯èƒ½å¯¼è‡´æ­»é”ã€‚å› æ­¤ï¼Œåº”è¯¥ç¡®ä¿æ¯ä¸ªè¿›ç¨‹åœ¨é‡Šæ”¾æ‰€æœ‰å·²ç»ä¿æŒçš„ä¿¡å·é‡ä¹‹å‰éƒ½èƒ½å¤Ÿæ­£å¸¸é€€å‡ºã€‚



**ä¿¡å·é‡æ­é…å…±äº«å†…å­˜ä½¿ç”¨**

****



```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/sem.h>

#define SHM_KEY 1234 // å…±äº«å†…å­˜é”®å€¼
#define SEM_KEY 5678 // ä¿¡å·é‡é›†åˆé”®å€¼

#define SHM_SIZE 1024 // å…±äº«å†…å­˜å¤§å°
#define SEM_NUM 2 // ä¿¡å·é‡æ•°é‡

union semun {
    int val;               // Value for SETVAL
    struct semid_ds *buf;  // Buffer for IPC_STAT, IPC_SET
    unsigned short *array; // Array for GETALL, SETALL
};

int main()
{
    int shm_id;         // å…±äº«å†…å­˜æ ‡è¯†ç¬¦
    int sem_id;         // ä¿¡å·é‡æ ‡è¯†ç¬¦
    char *shm_ptr;      // å…±äº«å†…å­˜æŒ‡é’ˆ
    struct sembuf sop;  // ä¿¡å·é‡æ“ä½œç»“æ„ä½“
    union semun arg;    // ä¿¡å·é‡æ§åˆ¶æ“ä½œå‚æ•°

    // åˆ›å»ºå…±äº«å†…å­˜æ®µ
    shm_id = shmget(SHM_KEY, SHM_SIZE, IPC_CREAT | 0666);
    if (shm_id == -1) {
        perror("shmget");
        exit(1);
    }

    // æ˜ å°„å…±äº«å†…å­˜
    shm_ptr = shmat(shm_id, NULL, 0);
    if (shm_ptr == (char *) -1) {
        perror("shmat");
        exit(1);
    }

    // åˆå§‹åŒ–ä¿¡å·é‡é›†åˆ
    sem_id = semget(SEM_KEY, SEM_NUM, IPC_CREAT | 0666);
    if (sem_id == -1) {
        perror("semget");
        exit(1);
    }

    // åˆå§‹åŒ–äº’æ–¥ä¿¡å·é‡ä¸º1
    arg.val = 1;
    if (semctl(sem_id, 0, SETVAL, arg) == -1) {
        perror("semctl");
        exit(1);
    }

    // åˆå§‹åŒ–æ¡ä»¶ä¿¡å·é‡ä¸º0
    arg.val = 0;
    if (semctl(sem_id, 1, SETVAL, arg) == -1) {
        perror("semctl");
        exit(1);
    }

    // å†™è¿›ç¨‹å‘å…±äº«å†…å­˜å†™å…¥æ•°æ®
    if (fork() == 0) {
        printf("Writing to shared memory...\n");
        sleep(1);

        // ç­‰å¾…äº’æ–¥ä¿¡å·é‡
        sop.sem_num = 0;
        sop.sem_op = -1;
        sop.sem_flg = SEM_UNDO;
        semop(sem_id, &sop, 1);

        // å‘å…±äº«å†…å­˜å†™å…¥æ•°æ®
        sprintf(shm_ptr, "Hello, world!");

        // å‘é€æ¡ä»¶ä¿¡å·é‡
        sop.sem_num = 1;
        sop.sem_op = 1;
        sop.sem_flg = SEM_UNDO;
        semop(sem_id, &sop, 1);

        printf("Data written to shared memory.\n");

        exit(0);
    }

    // è¯»è¿›ç¨‹ä»å…±äº«å†…å­˜ä¸­è¯»å–æ•°æ®
    else {
        printf("Reading from shared memory...\n");

        // ç­‰å¾…æ¡ä»¶ä¿¡å·é‡
        sop.sem_num = 1;
        sop.sem_op = -1;
        sop.sem_flg = SEM_UNDO;
        semop(sem_id, &sop, 1);

        // ä»å…±äº«å†…å­˜è¯»å–æ•°æ®
        printf("Data read from shared memory: %s\n", shm_ptr);

        // å‘é€äº’æ–¥ä¿¡å·é‡
        sop.sem_num = 0;
        sop.sem_op = 1;
        sop.sem_flg = SEM_UNDO;
        semop(sem_id, &sop, 1);

        exit(0);
    }

    return 0;
}

```

ä»¥ä¸Šä»£ç ä¸­ï¼Œä½¿ç”¨äº† `shmget()` å‡½æ•°åˆ›å»ºå…±äº«å†…å­˜ï¼Œå¹¶é€šè¿‡ `shmat()` å‡½æ•°å°†è¯¥å†…å­˜æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚ç„¶åï¼Œä½¿ç”¨ `semget()` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªä¿¡å·é‡çš„ä¿¡å·é‡é›†åˆï¼Œå…¶ä¸­ä¸€ä¸ªä¿¡å·é‡ç”¨äºå®ç°äº’æ–¥ï¼Œå¦ä¸€ä¸ªä¿¡å·é‡åˆ™ç”¨äºç­‰å¾…æ¡ä»¶ã€‚

åœ¨å†™è¿›ç¨‹ä¸­ï¼Œé¦–å…ˆç­‰å¾…äº’æ–¥ä¿¡å·é‡ï¼Œç„¶åå‘å…±äº«å†…å­˜å†™å…¥æ•°æ®ï¼Œå¹¶å‘é€æ¡ä»¶ä¿¡å·é‡é€šçŸ¥è¯»è¿›ç¨‹å¯ä»¥å¼€å§‹è¯»å–æ•°æ®ã€‚åœ¨è¯»è¿›ç¨‹ä¸­ï¼Œç­‰å¾…æ¡ä»¶ä¿¡å·é‡ï¼Œç„¶åä»å…±äº«å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å‘é€äº’æ–¥ä¿¡å·é‡é€šçŸ¥å†™è¿›ç¨‹å¯ä»¥å¼€å§‹å†™å…¥æ•°æ®ã€‚

è¿™æ ·ï¼Œå°±é€šè¿‡ä¿¡å·é‡é›†åˆå’Œå…±äº«å†…å­˜æˆåŠŸå®ç°äº†è¿›ç¨‹é—´çš„æ•°æ®å…±äº«å’ŒåŒæ­¥ã€‚





## ç½‘ç»œç¼–ç¨‹

****

11

### ç½‘ç»œåŸºç¡€

****

``æµè§ˆå™¨``:æ˜¯å®¢æˆ·ç«¯çš„ä¸€ç§

 ``æœåŠ¡å™¨``ï¼šæœåŠ¡å™¨æ˜¯è½¯ä»¶å’Œç¡¬ä»¶çš„ç»“åˆï¼Œä¸ç®—çš„å‘å®¢æˆ·æä¾›æœåŠ¡

``åè®®``ï¼šä¸¤å°ä¸»æœºç›¸è¿ï¼Œè¦é€šä¿¡ï¼Œåº”è¯¥ä½¿ç”¨ç²¤è¯­ï¼Œè‹±è¯­ï¼Œæ™®é€šè¯é‚£ç§é€šä¿¡æ–¹å¼ï¼Ÿè¿™ç§é€šä¿¡æ–¹å¼å°±å«åè®®

`ç«¯å£`ï¼šè¿›ç¨‹è¦ç›‘å¬ç«¯å£ï¼Œæ“ä½œç³»ç»Ÿæ‰ä¼šæŠŠç«¯å£çš„æ•°æ®ç»™ä½ 

<img src="allPic/Macdo2023-04-23 13.30.26.jpg" style="zoom:50%;" />

**è°ƒåˆ¶è§£è°ƒå™¨** è´Ÿè´£æ¨¡æ‹Ÿç”µè·¯è½¬å’Œæ•°å­—ç”µè·¯ä¹‹é—´çš„è½¬æ¢ 

![](allPic/Macdo2023-04-23 13.41.08.jpg)

![](allPic/Macdo2023-04-23 13.50.07.jpg)

![](allPic/Macdo2023-04-23 13.52.43.jpg)

![](allPic/Macdo2023-04-23 14.00.39.jpg)

![](allPic/Macdo2023-04-23 14.16.45.jpg)

![](allPic/Macdo2023-04-23 14.44.36.jpg)

![](allPic/Macdo2023-04-24 15.10.10.jpg)

![](allPic/Macdo2023-04-24 15.13.49.jpg)

![](allPic/Macdo2023-04-24 15.16.44.jpg)

![](allPic/Macdo2023-04-24 15.20.11.jpg)

![](allPic/Macdo2023-04-24 15.25.00.jpg)

![](allPic/Macdo2023-04-24 15.47.27.jpg)

ç›®çš„åœ°å€æ˜¯ç½‘å¡çš„åœ°å€ æºåœ°å€ä¹Ÿæ˜¯ç½‘å¡åœ°å€

ether æ˜¯ç‰©ç†åœ°å€

```
ifconfig

ens160: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.50.8  netmask 255.255.255.0  broadcast 192.168.50.255
        inet6 fe80::20c:29ff:fe6d:de9e  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:6d:de:9e  txqueuelen 1000  (Ethernet)
        RX packets 143560  bytes 24095662 (24.0 MB)
        RX errors 0  dropped 32  overruns 0  frame 0
        TX packets 108138  bytes 18734574 (18.7 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
        device interrupt 40  memory 0x3fe00000-3fe20000  
```

è®¾ç½®ipåœ°å€çš„æ—¶å€™ï¼Œä¼šç”¨ç½‘å¡åœ°å€å’Œipåœ°å€ç»‘å®š

### å…³äºç½‘ç»œçš„å‘½ä»¤

`sudo ifconfig`

`ping ç›®æ ‡ip`

```
ä¸¤å°è®¡ç®—æœºä¹‹é—´è¦pingé€š æ²¡pingé€š æ— æ³•é€šè¡Œ

127.0.0.1 æµ‹è¯•ç½‘å¡æ˜¯å¦æ­£å¸¸
```

`sudo route`

```
æŸ¥çœ‹è·¯ç”±è¡¨
```

`sudo arp -a`

```
æŸ¥çœ‹æœ¬arpè¡¨
```





### äº”ç±»äº’è”ç½‘åœ°å€

****

äº”ç±»äº’è”ç½‘åœ°å€æŒ‡çš„æ˜¯IPåœ°å€åˆ†ç±»ä¸­çš„äº”ç±»ï¼Œæ¯ä¸€ç±»çš„åœ°å€èŒƒå›´å’Œç”¨é€”éƒ½æœ‰æ‰€ä¸åŒã€‚å…·ä½“å¦‚ä¸‹ï¼š

1. Aç±»IPåœ°å€ï¼šä»¥0å¼€å¤´çš„ç½‘ç»œå·ï¼Œå‰©ä½™éƒ¨åˆ†ä¸ºä¸»æœºå·ã€‚å…¶èŒƒå›´æ˜¯1.0.0.0~126.0.0.0ï¼Œå…¶ä¸­0å’Œ127è¢«ä¿ç•™ä¸ä½¿ç”¨ã€‚Aç±»åœ°å€é€šå¸¸ç”¨äºå¤§å‹ä¼ä¸šæˆ–ç»„ç»‡å†…éƒ¨çš„ç½‘ç»œï¼Œä¾‹å¦‚IBMçš„å†…éƒ¨ç½‘ç»œå°±æ˜¯é‡‡ç”¨Aç±»åœ°å€ã€‚
2. Bç±»IPåœ°å€ï¼šä»¥10å¼€å¤´çš„ç½‘ç»œå·ï¼Œå‰©ä½™éƒ¨åˆ†ä¸ºä¸»æœºå·ã€‚å…¶èŒƒå›´æ˜¯128.0.0.0~191.255.0.0ã€‚Bç±»åœ°å€é€šå¸¸ç”¨äºä¸­ç­‰è§„æ¨¡çš„ç½‘ç»œï¼Œä¾‹å¦‚æŸä¸ªåŸå¸‚çš„åŒ»é™¢ç³»ç»Ÿå¯èƒ½ä¼šé‡‡ç”¨Bç±»åœ°å€ã€‚
3. Cç±»IPåœ°å€ï¼šä»¥110å¼€å¤´çš„ç½‘ç»œå·ï¼Œå‰©ä½™éƒ¨åˆ†ä¸ºä¸»æœºå·ã€‚å…¶èŒƒå›´æ˜¯192.0.0.0~223.255.255.0ã€‚Cç±»åœ°å€é€šå¸¸ç”¨äºå°å‹ç½‘ç»œï¼Œä¾‹å¦‚å®¶åº­æˆ–åŠå…¬ç½‘ç»œã€‚
4. Dç±»IPåœ°å€ï¼šä»¥1110å¼€å¤´çš„åœ°å€ï¼Œç”¨äºå¤šæ’­ï¼ˆMulticastï¼‰ã€‚å®ƒæ²¡æœ‰ä¸»æœºå·ï¼Œå¯ä»¥è¡¨ç¤ºä¸€ä¸ªç»„çš„åœ°å€ã€‚Dç±»åœ°å€èŒƒå›´æ˜¯224.0.0.0~239.255.255.255ã€‚
5. Eç±»IPåœ°å€ï¼šä»¥1111å¼€å¤´çš„åœ°å€ï¼Œç”¨äºå®éªŒå’Œç ”ç©¶ã€‚Eç±»åœ°å€èŒƒå›´æ˜¯240.0.0.0~255.255.255.254ã€‚

ä¾‹å¦‚ï¼Œ192.168.1.1æ˜¯ä¸€ä¸ªCç±»åœ°å€ï¼Œè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå°å‹ç½‘ç»œä¸­çš„æŸå°ä¸»æœºï¼›172.16.0.0æ˜¯ä¸€ä¸ªBç±»åœ°å€ï¼Œè¡¨ç¤ºçš„æ˜¯æŸä¸ªå¤§å‹ä¼ä¸šå†…éƒ¨çš„å­ç½‘ï¼›239.255.255.250æ˜¯ä¸€ä¸ªDç±»åœ°å€ï¼Œè¡¨ç¤ºçš„æ˜¯æŸä¸ªå¤šæ’­ç»„ã€‚





**ä¸ºä»€ä¹ˆåˆ’åˆ†äº”ç±»äº’è”ç½‘åœ°å€ï¼Œé‚£å…¬ç½‘Ipå‘¢**

åˆ’åˆ†äº”ç±»äº’è”ç½‘åœ°å€æ˜¯ä¸ºäº†æ›´å¥½åœ°ç®¡ç†å’Œè§„åˆ’IPåœ°å€çš„åˆ†é…å’Œä½¿ç”¨ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯Aç±»ã€Bç±»ã€Cç±»ã€Dç±»å’ŒEç±»ã€‚å…¶ä¸­ï¼ŒAã€Bã€Cä¸‰ç±»ä¸»è¦ç”¨äºå…¬å…±äº’è”ç½‘ï¼Œè€ŒDã€Eä¸¤ç±»åˆ™ç”¨äºç‰¹æ®Šç›®çš„ã€‚

è‡³äºå…¬ç½‘IPï¼Œå®ƒæ˜¯æŒ‡åœ¨å…¬å…±äº’è”ç½‘ä¸Šå¯ä»¥è®¿é—®çš„IPåœ°å€ï¼Œé€šå¸¸æŒ‡çš„å°±æ˜¯Aã€Bã€Cä¸‰ç±»äº’è”ç½‘åœ°å€ã€‚å¯¹äºä¸€å°è¿æ¥åˆ°å…¬ç½‘çš„è®¡ç®—æœºæˆ–è®¾å¤‡æ¥è¯´ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªå…¬ç½‘IPåœ°å€æ‰èƒ½æ­£å¸¸è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚å…¬ç½‘IPåœ°å€ç”±å„ä¸ªäº’è”ç½‘æœåŠ¡æä¾›å•†ï¼ˆISPï¼‰è´Ÿè´£åˆ†é…å’Œç®¡ç†ï¼Œæ¯ä¸ªISPæ‹¥æœ‰çš„å…¬ç½‘IPåœ°å€ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œå› æ­¤éœ€è¦è¿›è¡Œç²¾ç»†çš„è§„åˆ’å’Œç®¡ç†ã€‚



**å±€åŸŸç½‘é‡Œé¢çš„æ•°æ®å¦‚ä½•ä¼ è¾“**

å±€åŸŸç½‘IPä¼ é€åˆ°å¦å¤–ä¸€ä¸ªå±€åŸŸç½‘ï¼Œä¼šä¸255.255.255.0 åšæˆ–è¿ç®— åªè¦å‰ä¸‰ä½ç„¶åæ‰¾arpè¡¨,å¦‚æœæœ‰ï¼Œå°±æŠŠç½‘å¡åœ°å€å¤©åˆ°å¸§æ•°æ®çš„å¤´éƒ¨ï¼Œç„¶åç›®æ ‡åœ°å€ä¼šæŠŠåœ°å€ä¼ è¾“è¿‡å»



**192.158.50.3/24**

å­ç½‘æ¼”ç ä¸ºå‰24ä½éƒ½ä¸º1ï¼Œä¹Ÿå°±æ˜¯255.255.255.0





### TCP/UDP çš„ä¼˜ç¼ºç‚¹

****

![](allPic/Macdo2023-04-24 15.56.26.jpg)

![](allPic/Macdo2023-04-24 16.01.09.jpg)

![](allPic/Macdo2023-04-24 16.02.29.jpg)

### TCPçš„ä¸‰æ¬¡æ¡æ‰‹

****



![](allPic/Macdo2023-04-24 16.05.28.jpg)

![](allPic/Macdo2023-04-24 16.09.33.jpg)

### TCPçš„ç¼–ç¨‹æ¨¡å‹

****

#### åŸç†

![](allPic/Macdo2023-04-24 16.11.57.jpg)

![](allPic/Macdo2023-04-25 08.59.08.jpg)

![](allPic/Macdo2023-04-25 09.00.47.jpg)

![](allPic/Macdo2023-04-25 09.03.54.jpg)

![](allPic/Macdo2023-04-25 09.05.22.jpg)

![](allPic/Macdo2023-04-25 09.07.36.jpg)

![](allPic/Macdo2023-04-25 09.25.42.jpg)

<img src="allPic/Macdo2023-04-25 09.28.16.jpg" alt="ï¼" style="zoom:50%;" />

<img src="allPic/Macdo2023-04-25 09.28.45.jpg" style="zoom:50%;" />

<img src="allPic/Macdo2023-04-25 09.34.56.jpg" alt="!" style="zoom:50%;" />



<img src="allPic/Macdo2023-04-25 09.36.31.jpg" alt="!" style="zoom:50%;" />

![](allPic/Macdo2023-04-25 09.38.12.jpg)

![](allPic/Macdo2023-04-25 09.39.58.jpg)

<img src="allPic/Macdo2023-04-25 09.41.25.jpg" style="zoom:50%;" />

#### ä»£ç éƒ¨åˆ†

****

**service**

```c
#include <t_stdio.h>
#include <sys/types.h>          /* See NOTES */
#include <sys/socket.h>
#include <arpa/inet.h>      //è½¬æ¢å¤§å°æ®µ for htons()
#include <netinet/in.h>    //å®šä¹‰äº†ipv4çš„åœ°å€ç»“æ„
#include <ctype.h>          //è½¬æ¢å¤§å°å†™çš„
#include <unistd.h>



int main(void){

    //åˆ›å»ºipv4çš„ç»“æ„
    struct sockaddr_in  struct_ipv4;

    //æ¥æ”¶ä¿¡æ¯
    char buff[128];

    //åˆ›å»ºåˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦
    //int socket(int domain, int type, int protocol);
    //domain:AF_INET æ˜¯IPV4 
    //type: SOCK_STREAM (TCP),SOCK_DGRAM(UDP),SOCK_RAW(åŸå§‹å¥—æ¥å­—)
    //protocol: 0 é»˜è®¤çš„å¥—æ¥å­—ç±»å‹
    int s_fd=socket(AF_INET,SOCK_STREAM,0);
    if(s_fd==-1)E_MSG("socket",-1);

    //ipv4åœ°å€ç«¯å£çš„ç»“æ„èµ‹äºˆå€¼
    struct_ipv4.sin_family=AF_INET;
    struct_ipv4.sin_port=htons(5566);  //æœ¬åœ°çš„å°æ®µæ¨¡å¼è½¬æ¢æˆç½‘ç»œçš„é€šç”¨å¤§æ®µæ¨¡å¼
    struct_ipv4.sin_addr.s_addr=htonl(INADDR_ANY);//INADDR_ANY ä»£è¡¨æœ¬åœ°ä¸»æœºçš„ä»»æ„IPåœ°å€


    //å°†s_fdå’Œæœ¬åœ°åœ°å€ç«¯å£è¿›è¡Œç»‘å®š
    //        struct sockaddr {
    //            sa_family_t sa_family;
    //            char        sa_data[14];
    //        }
    // ipv4çš„ç»“æ„å­˜æ”¾å­˜æ”¾ipå’Œç«¯å£ï¼Œéœ€è¦è½¬æ¢æˆé€šç”¨çš„åœ°å€,ipv4çš„åœ°å€ç±»å‹ä¸º struct sockaddr_in 
    int b=bind(s_fd,(struct sockaddr *)&struct_ipv4,sizeof(struct_ipv4));
    if(b==-1)E_MSG("bind",-1);

    //int listen(int sockfd, int backlog);
    //æŠŠfdè®¾ç½®æˆè¢«åŠ¨è¿æ¥,ç›‘å¬å®¢æˆ·ç«¯è¿æ¥çš„åˆ°æ¥
    //å°†å®¢æˆ·ç«¯åˆ°æ¥çš„è¿æ¥æ”¾å…¥åˆ°å‘³è§‰è¿æ¥ï¼Œbacklogä¸ºæœªè§‰è¿æ¥çš„æŒ‡å®šçš„é•¿åº¦

    listen(s_fd,5);

    while(1){
        //ä»s_fd è®¾å¤‡çš„æœªè§‰è¿æ¥é˜Ÿåˆ—ä¸­æå–ä¸€ä¸ªè¿›è¡Œå¤„ç†ï¼Œè¿”å›ä¸€ä¸ªè¿æ¥æè¿°ç¬¦ï¼Œ
        //ä½¿ç”¨è¿æ¥æè¿°ç¬¦å’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡
        int c_fd=accept(s_fd,NULL,NULL); //ä¸¤ä¸ªNULLä¸ºå®¢æˆ·ç«¯ç»“æ„åœ°å€å’Œç»“æ„åœ°å€çš„å¤§å°ï¼Œä½¿ç”¨NULLä¸ºä¸å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªç»“æ„æ¥æ¥æ”¶ ç”¨inetâ€”â€”ntop è½¬æ¢åœ°å€
        if(c_fd==-1)E_MSG("appect",-1);
        //åˆ°è¿™ä¸‰æ¬¡æ¡æ‰‹å·²ç»OKäº†ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ä¼ è¾“äº†
        //ä»c_fdä¸­è¯»å–å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„è¯·æ±‚ä¿¡æ¯
        int r=read(c_fd,buff,128);
        int i;
        for(i=0;i<r;i++){
            buff[i]=toupper(buff[i]);
        }

        //å°†å¤„ç†ç»“æœå›é€é€å®¢æˆ·ç«¯
        write(c_fd,buff,r);

        //å…³é—­æœ¬åœ°è¿æ¥
        close(c_fd);

    }



    printf("Done....\n");




    return 0;
}
```

**client**

```c
#include <t_stdio.h>
#include <sys/types.h> 
#include <sys/socket.h> 
#include <netinet/in.h>
#include <netinet/ip.h>
#include <arpa/inet.h> //for inet_pton å­—ç¬¦ä¸²å­˜å‚¨åˆ°ç»“æ„é‡Œé¢
#include <string.h>
#include <unistd.h>

int main(void){

    struct sockaddr_in ser_addr;
    const char * ipstr="127.0.0.1";
    char *msg="this is a message....\n";

    char buff[128];

    //int inet_pton(int af, const char *src, void *dst);
    
    //åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦
    int fd=socket(AF_INET,SOCK_STREAM,0);
    if(fd==-1)E_MSG("socket",-1);

    //æœåŠ¡å™¨çš„ä¿¡æ¯
    ser_addr.sin_family=AF_INET; 
    ser_addr.sin_port=htons(5566);

    //å­—ç¬¦ä¸²åœ°å€ æ”¾åˆ° service_addr.sin_addr çš„ç»“æ„é‡Œé¢
    inet_pton(AF_INET,"127.0.0.1",&ser_addr.sin_addr);
    

    //ä½¿ç”¨fdå‘æœåŠ¡å™¨å‘èµ·è¿æ¥
    int c=connect(fd,(struct sockaddr *)&ser_addr,sizeof(ser_addr));
    if(c==-1)E_MSG("connect",-1);

    //åˆ°è¿™é‡Œ ä¸‰æ¬¡æ¡æ‰‹å·²ç»æˆåŠŸ

    write(fd,msg,strlen(msg)+1); //æ²¡æœ‰+'\0' éœ€è¦å¤šåŠ ä¸€ä¸ªå­—ç¬¦

    //é˜»å¡ç­‰å¾…æœåŠ¡å™¨çš„ç›¸åº”,è¿”å›ç›¸åº”çš„å­—èŠ‚
    int r=read(fd,buff,128);
    
    write(1,buff,r);

    close(fd);

    return 0;

}
```







### UDPçš„ç¼–ç¨‹æ¨¡å‹

****

#### ç¼–ç¨‹æ¨¡å‹

![](allPic/Macdo2023-05-02 14.21.06.jpg)

![](allPic/Macdo2023-05-02 14.27.28.jpg)

![](allPic/Macdo2023-05-02 14.28.46.jpg)

![](allPic/Macdo2023-05-02 14.29.32.jpg)

![](allPic/Macdo2023-05-02 14.31.06.jpg)

![](allPic/Macdo2023-05-02 14.32.18.jpg)

![](allPic/Macdo2023-05-02 14.33.09.jpg)



![](allPic/Macdo2023-05-02 15.49.33.jpg)

![](allPic/Macdo2023-05-02 15.51.02.jpg)

#### éœ€è¦ç”¨åˆ°çš„å‡½æ•°ä»¬

```æ¥æ”¶æ•°æ®
 //udp æ¥æ”¶æ•°æ®
 ssize_t
 recvfrom(int socket, void *restrict buffer, size_t length, int flags,
     struct sockaddr *restrict address, socklen_t *restrict address_len);
     
//å‘é€æ•°æ®
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags,
                      const struct sockaddr *dest_addr, socklen_t addrlen);
```

#### ç¤ºèŒƒä»£ç 

**UPDæœåŠ¡ç«¯**

```c
#include <t_stdio.h>
#include <netinet/in.h>
#include <unistd.h>
#include <sys/types.h>          /* See NOTES */
#include <sys/socket.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#include <arpa/inet.h>

#define BUFFSIZE 1024
char buff[BUFFSIZE];
char IP[40];  //ä¿å­˜å®¢æˆ·ç«¯çš„ip


int main(int argc,char *argv[]){
    if(argc <2){
        printf("Usage:%s Port\n",argv[0]);
        exit(EXIT_FAILURE);
    }

    //åˆ›å»ºsocket è¿”å›è¯¥è®¾å¤‡çš„æ–‡ä»¶æè¿°ç¬¦
    struct sockaddr_in Serv;  //æœåŠ¡å™¨çš„socketè®¾å¤‡   
    struct sockaddr_in Clie;  //ä¿å­˜å®¢æˆ·ç«¯çš„åœ°å€
    socklen_t Clie_size;


    int fd=socket(AF_INET,SOCK_DGRAM,0);  //æ–°å»ºæ–‡ä»¶æè¿°ç¬¦
    if(fd==-1){
        printf("Udp create Error...\n");
        exit(EXIT_FAILURE);
    }

    Serv.sin_family=AF_INET;
    Serv.sin_port=htons(atoi(argv[1]));
    Serv.sin_addr.s_addr=INADDR_ANY;
    int b=bind(fd,(struct sockaddr *)&Serv,sizeof(Serv));
    if(b==-1){
        perror("bind");return -1;
    }

    while(1){//å¾ªç¯å¤„ç†
        Clie_size=sizeof(Clie);

        //é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œæ²¡æœ‰å®¢æˆ·ç«¯ï¼Œä¼šä¸€ç›´åœ¨è¿™ç­‰ç€ Clie ä¿å­˜å®¢æˆ·ç«¯ä¿¡æ¯ //å¤„ç†å®Œçš„æ•°æ®å¾€è¿™ä¸ªå®¢æˆ·ç«¯å‘
        size_t r=recvfrom(fd,buff,(size_t)BUFFSIZE,0,(struct sockaddr *)&Clie,&Clie_size);
        if(r ==-1)break;
        inet_ntop(AF_INET, &Clie.sin_addr,IP,40);  //ä»å®¢æˆ·ç«¯çš„structçš„ç»“æ„é‡Œä¿å­˜up ä¿¡æ¯
                             

        printf("Got message From [%s]:%s\n",IP,buff);

        //ç®€å•çš„å¤„ç†é‚£å•¥å®¢æˆ·ç«¯çš„ä¿¡æ¯
        for(int i=0;i<r;i++){
            buff[i]=toupper(buff[i]);
        }
       
        //æŠŠæ•°æ®å‘é€å›å»
        ssize_t s= sendto(fd,buff,r,0,(struct sockaddr *)&Clie,sizeof(Clie));
        if(r ==-1)break;


    }
    close(fd);  //å…³é—­æ–‡ä»¶æè¿°ç¬¦

    return 0;
}

```

**UDPå®¢æˆ·ç«¯**

```c
#include <stdio.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <netinet/udp.h>
#include <unistd.h>
#include <string.h>
#include <arpa/inet.h>
#include <stdlib.h>


int main(int argc,char *argv[]){
    if(argc !=4){
        printf("Usage:%s Ip Port message\n",argv[0]);
        return -1;
    }



    struct sockaddr_in Ser;

    socklen_t slen=sizeof(Ser);
    Ser.sin_family=AF_INET;
    Ser.sin_port=htons(atoi(argv[2]));
    inet_pton(AF_INET,argv[1],&Ser.sin_addr);

    int fd = socket(AF_INET, SOCK_DGRAM, 0);

    if(fd==-1){
        perror("socket");
        return -1;
    }

    char buff[1024];
    strcpy(buff,argv[3]);

    int s=sendto(fd,buff,strlen(buff)+1,0,(struct sockaddr*)&Ser,slen);
    if(s==-1){
        perror("sendto");
        return -1;
    }

    int r=recvfrom(fd,buff,1024,0,(struct sockaddr *)&Ser,&slen);

    write(1,buff,r);
    printf("\n");

    close(fd);


    

    return 0;
}
```





## çº¿ç¨‹



### çº¿ç¨‹åŸºæœ¬æ¦‚å¿µ

//ç¼–è¯‘çš„æ—¶å€™éœ€è¦æŒ‡å®šé“¾æ¥çš„åº“ ï¼ŒåŠ ä¸Šå‚æ•°-lpthread

```bash
gcc source.c -lpthread
```

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„tid å’Œ TCB ç»ˆç«¯è¿›ç¨‹ä¸­çº¿ç¨‹æ‰€æœ‰çº¿ç¨‹çš„è¿è¡ŒçŠ¶å†µ

```bash
top -H -p çº¿ç¨‹id
```

ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè‡³å°‘è¦æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹
è¿›ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼ˆä»£ç æ®µï¼Œå †é‡Œé¢çš„ï¼‰ï¼Œä½†æ˜¯æ¯ä¸ªçº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„ç§æœ‰èµ„æº
æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„æ‰§è¡Œå‡½æ•°ï¼Œçº¿ç¨‹ç§æœ‰èµ„æºåœ¨å‡½æ•°å¯¹åº”çš„æ ˆé’ˆé‡Œé¢

ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ä¸å¯èƒ½é€šä¿¡çš„ï¼Œéœ€è¦å€ŸåŠ©å†…æ ¸ç©ºé—´
çº¿ç¨‹ä¹‹é—´é€šä¿¡å¯ä»¥
è¿›ç¨‹ä¹‹é—´å¯¹èµ„æºè®¿é—®ï¼Œä¼šå¼‚æ­¥

#### **çº¿ç¨‹çš„åˆ›å»º**
åœ¨å½“å‰çš„è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ ç¼–è¯‘å’Œè¿æ¥çš„æ—¶å€™ éœ€è¦é“¾æ¥phthread

```c

#include <pthread.h>

int pthread_create(pthread_t *thread, const pthread_attr_t *attr,
                    void *(*start_routine) (void *), void *arg);


å‚æ•°:
    threadï¼š
        å­˜æ”¾æ–°å»ºçº¿ç¨‹çš„tidçš„ç©ºé—´ï¼ŒæŒ‡å‘çº¿ç¨‹æ ‡è¯†ç¬¦çš„æŒ‡é’ˆï¼Œéœ€è¦åœ¨ pthread_create å‡½æ•°ä¸­æŒ‡å®šè¯¥å‚æ•°çš„å€¼ï¼Œä»¥ä¾¿åœ¨è°ƒç”¨å…¶ä»–çº¿ç¨‹ API æ—¶æ ‡è¯†çº¿ç¨‹ã€‚
    attr:
        æŒ‡å®šçº¿ç¨‹çš„å±æ€§ï¼Œå¯ä»¥ä¸º NULLï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚å¦‚æœéœ€è¦ä¿®æ”¹å±æ€§ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ª pthread_attr_t ç±»å‹çš„å˜é‡ï¼Œå¹¶ä½¿ç”¨ç›¸å…³ API è®¾ç½®å±æ€§å€¼ã€‚
    start_routine:
        æŒ‡å®šçº¿ç¨‹è¿è¡Œçš„å‡½æ•°åœ°å€ï¼Œè¯¥å‡½æ•°éœ€è¦ä½¿ç”¨ void* ç±»å‹ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼ã€‚
    arg:
        ä¼ é€’ç»™å‡½æ•°å”¯ä¸€çš„ä¸€ä¸ªå‚æ•°ï¼Œçº¿ç¨‹è¿è¡Œå‡½æ•°çš„å‚æ•°ï¼Œéœ€è¦ä½¿ç”¨ void* ç±»å‹ä¼ é€’ï¼Œå¦‚æœæ²¡æœ‰å‚æ•°å¯ä»¥ä¼ å…¥ NULLã€‚
è¿”å›å€¼:
    0 or é”™è¯¯ç 
æ³¨æ„ï¼šç¼–è¯‘å’Œè¿æ¥çš„æ—¶å€™ éœ€è¦é“¾æ¥-pthread

```

#### **åœ¨çº¿ç¨‹ä¸­æ‰“å°è‡ªå·±çš„çº¿ç¨‹id**

```c
pthread_t pthread_self(void);
åŠŸèƒ½:
    è¿”å›å½“å‰çº¿ç¨‹çš„tid
è¿”å›å€¼ï¼š
    è¿™ä¸ªå‡½æ•°æ€»æ˜¯æˆåŠŸæ‰§è¡Œï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„id

æ³¨æ„ï¼šç¼–è¯‘å’Œè¿æ¥çš„æ—¶å€™ éœ€è¦é“¾æ¥-pthread
```

####  **çº¿ç¨‹åˆ†ç¦»**
å¦‚æœçº¿ç¨‹è®¾ç½®äº†åˆ†ç¦»çš„çŠ¶æ€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶çº¿ç¨‹çš„èµ„æº,ä¸»çº¿ç¨‹ä¸ç”¨ç­‰å¾…

```c
int pthread_detach(pthread_t thread);
å‚æ•°:tid
è¿”å›å€¼:æˆåŠŸ0

//ä½¿ç”¨ pthread_detach() å‡½æ•°å°†çº¿ç¨‹æ ‡è®°ä¸ºåˆ†ç¦»çº¿ç¨‹ï¼Œå³å¯å®ç°çº¿ç¨‹çš„åˆ†ç¦»ã€‚ä¸€æ—¦çº¿ç¨‹è¢«æ ‡è®°ä¸ºåˆ†ç¦»çº¿ç¨‹ï¼Œå®ƒå°±æ— æ³•è¢«åŠ å…¥åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œä¹Ÿå°±æ— æ³•å†è¢«ç­‰å¾…å’Œå›æ”¶èµ„æºã€‚å¦å¤–ï¼Œåˆ†ç¦»çº¿ç¨‹ä¹Ÿä¸èƒ½è°ƒç”¨ pthread_join() å‡½æ•°ã€‚
```
####  **é€€å‡ºçº¿ç¨‹**

```c
 #include <pthread.h>
void pthread_exit(void *retval);

//pthread_exitå‡½æ•°æ˜¯POSIXçº¿ç¨‹åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé€€å‡ºå½“å‰çº¿ç¨‹å¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘voidçš„æŒ‡é’ˆï¼Œå®ƒæœ‰ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®šè¯¥æŒ‡é’ˆçš„å€¼ã€‚è¯¥å‡½æ•°é€šå¸¸ç”¨äºåœ¨çº¿ç¨‹å®Œæˆå·¥ä½œåé€€å‡ºçº¿ç¨‹ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

//åœ¨è°ƒç”¨pthread_exitå‡½æ•°åï¼Œçº¿ç¨‹å°†è¢«ç»ˆæ­¢å¹¶ç«‹å³é‡Šæ”¾å®ƒæ‰€æŒæœ‰çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬æ ˆã€çº¿ç¨‹å±€éƒ¨å­˜å‚¨å’Œäº’æ–¥é‡ç­‰ã€‚å› æ­¤ï¼Œä½¿ç”¨pthread_exitå‡½æ•°æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®‰å…¨çš„æ–¹æ³•æ¥é€€å‡ºçº¿ç¨‹ï¼Œè€Œä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼æˆ–å…¶ä»–èµ„æºæ³„æ¼çš„é—®é¢˜ã€‚
```

#### **çº¿ç¨‹å–æ¶ˆ**

```c
#include <pthread.h>

int pthread_cancel(pthread_t thread);
æŒ‡å®šçš„çº¿ç¨‹id
 // pthread_cancel() å‡½æ•°ç”¨äºå‘æŒ‡å®šçº¿ç¨‹å‘é€å–æ¶ˆè¯·æ±‚ï¼Œè¯·æ±‚å–æ¶ˆæŒ‡å®šçº¿ç¨‹ã€‚å–æ¶ˆçš„å…·ä½“å®ç°æ–¹å¼å–å†³äºç›®æ ‡çº¿ç¨‹æ˜¯å¦å¯¹å–æ¶ˆè¿›è¡Œäº†å¤„ç†ã€‚å¦‚æœç›®æ ‡çº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶å˜é‡ç­‰ä¸€äº›å…¶ä»–é˜»å¡æ“ä½œæ—¶ï¼Œå°†ä¼šè¢«å”¤é†’ä»¥å“åº”å–æ¶ˆè¯·æ±‚ã€‚å¦‚æœç›®æ ‡çº¿ç¨‹æ²¡æœ‰å¯¹å–æ¶ˆè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆè°ƒç”¨ pthread_cancel() å¹¶ä¸ä¼šç«‹å³ç»“æŸçº¿ç¨‹ï¼Œéœ€è¦åœ¨ç›®æ ‡çº¿ç¨‹ä¸­æ˜¾å¼åœ°æ£€æµ‹å–æ¶ˆè¯·æ±‚å¹¶ä½œå‡ºå“åº”ã€‚
```

#### **ç­‰å¾…çº¿ç¨‹**

```c
#include <pthread.h>
int pthread_join(pthread_t thread, void **retval);
å…¶ä¸­ï¼Œthread å‚æ•°æ˜¯è¦ç­‰å¾…çš„çº¿ç¨‹çš„ IDï¼›retval å‚æ•°æ˜¯æŒ‡å‘çº¿ç¨‹é€€å‡ºçŠ¶æ€çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥æ˜¯ç©ºæŒ‡é’ˆã€‚


//å½“ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ƒä¼šè°ƒç”¨ pthread_exit() å‡½æ•°æ¥é€€å‡ºã€‚å¦‚æœçº¿ç¨‹çš„ä¸»å‡½æ•°ä¸­æœ‰ä¸€ä¸ªè¿”å›è¯­å¥ï¼Œé‚£ä¹ˆå®ƒç›¸å½“äºè°ƒç”¨äº† pthread_exit() å‡½æ•°ï¼ŒåŒæ—¶å°†è¿”å›å€¼ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº† pthread_exit() å‡½æ•°ã€‚ pthread_join() å‡½æ•°å¯ä»¥ç”¨æ¥è·å–çº¿ç¨‹é€€å‡ºæ—¶çš„è¿”å›å€¼ã€‚å¦‚æœä¸å…³å¿ƒçº¿ç¨‹çš„è¿”å›å€¼ï¼Œå¯ä»¥å°† retval å‚æ•°è®¾ç½®ä¸º NULLã€‚

//éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…æœŸé—´è¢«å–æ¶ˆï¼Œé‚£ä¹ˆ pthread_join() å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ç  EINTRã€‚æ­¤æ—¶ï¼Œå¯ä»¥é‡æ–°è°ƒç”¨ pthread_join() å‡½æ•°ï¼Œæˆ–è€…åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­é‡æ–°è®¾ç½®ä¿¡å·çš„å¤„ç†æ–¹å¼æ¥é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚
```





### çº¿ç¨‹åŒæ­¥

****

#### å¯é‡å…¥å‡½æ•°

å‡½æ•°å€¼è®¿é—®è‡ªå·±æ ˆå¸§é‡Œé¢çš„æ•°æ®å°±å«**å¯é‡å…¥å‡½æ•°**ï¼Œå¦‚æœè®¿é—®äº†çº¿ç¨‹çš„é™æ€å˜é‡ï¼Œæ•°æ®æ®µçš„æ•°æ®å’Œå †ç©ºé—´é‡Œçš„æ•°æ®å°±å«åš**ä¸å¯é‡å…¥å‡½æ•°** çº¿ç¨‹å‡½æ•°è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ï¼Œæ˜¯å¼‚æ­¥çš„ï¼Œå¯¹å…±äº«èµ„æºçš„è®¿é—®æˆ–è€…ä¿®æ”¹æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™æ ·é€ æˆç¨‹åºçš„è¿è¡Œç»“æœä¹Ÿä¸ä¸€æ · æ‰€ä»¥è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µï¼Œçº¿ç¨‹1è®¿é—®èµ„æºçš„æ—¶å€™ï¼Œçº¿ç¨‹2ä¸èƒ½è®¿é—®ï¼Œç­‰çº¿ç¨‹1è®¿é—®å®Œï¼Œçº¿ç¨‹2å†è®¿é—®

#### çº¿ç¨‹åŒæ­¥
**ä¸‰ç§æ–¹å¼mutexé” æ¡ä»¶å˜é‡ ä¿¡å·é‡**



#### mutexé”

ä»»æ„æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæ—¶åˆ»è®¿é—®è¯¥å¯¹è±¡

![](allPic/Macdo2023-05-09 13.29.37.jpg)

![](allPic/Macdo2023-05-09 13.44.24.jpg)

![Macdo2023-05-09 13.45.02](allPic/Macdo2023-05-09 13.45.02.jpg)

![](allPic/Macdo2023-05-09 13.54.28.jpg)

![]()



```c
typedef union
{
  struct __pthread_mutex_s __data;
  char __size[48];
  long int __align;
} pthread_mutex_t;

pthread_mutex_t MyLock=PTHREAD_MUTEX_INITIALIZER;//é™æ€åˆå§‹åŒ–ä¸€æŠŠé”ï¼›

int pthread_mutex_init (pthread_mutex_t *__mutex,
          const pthread_mutexattr_t *__mutexattr);//ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¸ºnull
     
int pthread_mutex_destroy (pthread_mutex_t *__mutex)//å‚æ•°ä¸ºé”åœ°å€
     
  int pthread_mutex_trylock (pthread_mutex_t *__mutex)//å°è¯•ä¸Šé”ï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸ è¯¥å¹²å˜›å¹²å˜›
    
int pthread_mutex_lock (pthread_mutex_t *__mutex)
   
int pthread_mutex_timedlock (pthread_mutex_t *__restrict __mutex,
        const struct timespec *__restrict);
       
int pthread_mutex_unlock (pthread_mutex_t *__mutex);//é‡Šæ”¾é”ç©ºé—´ï¼Œæ”¾å‡½æ•°çš„æœ€å
    

```

**ç¤ºèŒƒä»£ç **

```c
#include <stdio.h>
#include <pthread.h>

//å®šä¹‰ä¸€ä¸ªmutex é”ç±»å‹çš„å˜é‡
pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER; //åˆå§‹åŒ–çš„å®

int val=0;	//è¦ä¿®æ”¹çš„å…¨å±€å˜é‡

void * handle(void *arg){ //çº¿ç¨‹è®¿é—®å‡½æ•°
	int temp;
	
	for(int i=0;i<50000;i++){
		pthread_mutex_lock(&mutex); //	ä¸Šé”çš„åŒºåŸŸåœ¨ä¸´ç•ŒåŒºåŸŸ,è®¿é—®è¦ä¿®æ”¹å…¨å±€å˜é‡çš„æ—¶å€™ï¼Œæ‰åŠ é”
		temp=val;
		temp++;
		printf("tid:%lu woring,temp=%d\n",pthread_self(),temp);
		val=temp;
		pthread_mutex_unlock(&mutex);//	ä¸Šé”çš„åŒºåŸŸåœ¨ä¸´ç•ŒåŒºåŸŸ,
	}
	
	return NULL;

}

int main(){
	//åˆå§‹åŒ–é”
	pthread_mutex_init(&mutex,NULL);
	pthread_t tid1,tid2;

	pthread_create(&tid1,NULL,handle,"tid1");
	pthread_create(&tid2,NULL,handle,"tid2");
	pthread_join(tid1,NULL);
	pthread_join(tid2,NULL);
	
	//é‡Šæ”¾é”ç©ºé—´
	pthread_mutex_destroy(&mutex);

	return 0;
}

```



#### æ¡ä»¶å˜é‡

****

![](allPic/Macdo2023-05-11 09.50.10.jpg)



![Macdo2023-05-11 09.51.51](allPic/Macdo2023-05-11 09.51.51.jpg)

![Macdo2023-05-11 10.16.43](allPic/Macdo2023-05-11 10.16.43.jpg)

![Macdo2023-05-11 10.17.47](allPic/Macdo2023-05-11 10.17.47.jpg)

![Macdo2023-05-11 10.18.38](allPic/Macdo2023-05-11 10.18.38.jpg)

![Macdo2023-05-11 10.19.08](allPic/Macdo2023-05-11 10.19.08.jpg)

![Macdo2023-05-11 10.21.53](allPic/Macdo2023-05-11 10.21.53.jpg)

##### æ¡ä»¶å˜é‡ ç¤ºèŒƒä»£ç 

```c
#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>
#include <unistd.h>

pthread_cond_t cond=PTHREAD_COND_INITIALIZER;
pthread_mutex_t mutex=PTHREAD_MUTEX_INITIALIZER;


//èŠ‚ç‚¹
typedef struct node{
    int data;
    struct node * next;
}node_t;

//èŠ‚ç‚¹æŒ‡é’ˆ
typedef node_t * node_p;  //

//èŠ‚ç‚¹å¤´éƒ¨
node_p list=NULL;

void *production(void *arg){
    node_p tmp;
    while(1){
        tmp=(node_t *)malloc(sizeof(node_t));
        tmp->data=rand() % 1000 +1;// Make New Node;
        printf("p:%d make a data\n",tmp->data);

        pthread_mutex_lock(&mutex);
        printf("p:LOCKED.....\n");
    //ä¸´ç•Œèµ„æºstart
        tmp->next=list;  // Make New Node;
        list=tmp;
        printf("p:%d add to list\n",list->data);
    //ä¸´ç•Œèµ„æºend

    

        pthread_mutex_unlock(&mutex);
        printf("p:UNLOCKED.....\n");
        pthread_cond_signal(&cond);
        printf("boardcast to anther pthread......\n");
        //sleep(rand()%3+1);

    }
    return NULL;
}
void *consume(void *arg){
    
    while(1){
        pthread_mutex_lock(&mutex);
        while(list==NULL){
            printf("c:Data be Locked .......C: for wait\n");
            
            //è§£é”å¹¶ä¸”ç­‰å¾…
            //å¦‚æœå…¶ä»–çº¿ç¨‹å‘é€äº† pthread_cond_signal(&cond); ä¿¡å·ï¼Œè¿™ä¸ªæ—¶å€™æ¡ä»¶ä¸ºçœŸäº†ï¼Œå¹¶ä¸”ä¼šåŠ é”æ‰§è¡Œä¸‹é¢çš„æ“ä½œ
            
            pthread_cond_wait(&cond,&mutex); //å¦‚æœæ²¡æœ‰æ”¶åˆ°ä¿¡å·é‚£å•¥è§£é”ç­‰å¾…å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œä¼šåŠ é”æ‰§è¡Œä¸‹ä¸€æ­¥
            printf("c:unlocking....\n");
        }
        //TODO: 
        
        node_p tmp=list;
        list=list->next;
        
        printf("c:%d freeing \n",tmp->data);
        sleep(1);

        free(tmp);
        tmp=NULL;
        pthread_mutex_unlock(&mutex);
        //sleep(rand()%3+1);

        



    }
    return NULL;
}




int main(){
    srand(time(NULL));
    printf("hello,kitty\n");
    pthread_t tid1,tid2;
    pthread_create(&tid1,NULL,production,NULL);
    pthread_create(&tid2,NULL,consume,NULL);

    pthread_join(tid1,NULL);
    pthread_join(tid2,NULL);

    return 0;
}



#if 0
int main(){
    pthread_cond_init();
    pthread_cond_signal(&cond);//å‘é€ä¿¡å·å‘ŠçŸ¥ç­‰å¾…çš„çº¿ç¨‹/ï¼Œæ¡ä»¶ä¸ºçœŸäº†
    pthread_cond_wait(&cond,&mute);//é˜»å¡ è§£é”ç­‰å¾…,å½“æœ‰ä¿¡å·äº†ï¼Œå†é‡æ–°è·å–é”ï¼Œå¹¶ä¸”åŠ é”

}


#endif 
```

##### æ¡ä»¶å˜é‡ GPT

```c
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>

pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;   // å®šä¹‰äº’æ–¥é”
pthread_cond_t cond = PTHREAD_COND_INITIALIZER;     // å®šä¹‰æ¡ä»¶å˜é‡
int num = 0;

void *thread1(void *arg)
{
    printf("thread1: lock the mutex\n");
    pthread_mutex_lock(&mutex);  //ä¸Šé”
    while (num == 0)
    {
        printf("thread1: wait for the condition\n");
        pthread_cond_wait(&cond, &mutex);  // è§£é”å¹¶ä¸”ç­‰å¾…æ¡ä»¶å˜é‡ï¼Œå¦‚æœæ”¶åˆ°æ¡ä»¶å˜é‡ï¼Œçº¿ç¨‹ä¼šåŠ é”æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œ
    }
    printf("thread1: the condition has been changed\n");
    printf("thread1: num = %d\n", num);
    pthread_mutex_unlock(&mutex);
    printf("thread1: unlock the mutex\n");
    pthread_exit(NULL);
}

void *thread2(void *arg)
{
    printf("thread2: lock the mutex\n");
    pthread_mutex_lock(&mutex);
    printf("thread2: change the condition\n");
    num = 1;
    pthread_cond_signal(&cond);             // å‘é€æ¡ä»¶å˜é‡  å…ˆå‘é€æ¡ä»¶å˜é‡ï¼Œå†è§£é”
    printf("thread2: unlock the mutex\n");
    pthread_mutex_unlock(&mutex);
    pthread_exit(NULL);
}

int main()
{
    pthread_t tid1, tid2;
    if (pthread_create(&tid1, NULL, thread1, NULL) != 0)
    {
        printf("create thread1 error\n");
        return 1;
    }
    
    if (pthread_create(&tid2, NULL, thread2, NULL) != 0)
    {
        printf("create thread2 error\n");
        return 2;
    }

    pthread_join(tid1, NULL);
    pthread_join(tid2, NULL);
    return 0;
}

```



#### ä¿¡å·é‡

****

æ¬¡çº¿ç¨‹æ²¡æœ‰æ¥æ”¶åˆ°ä¿¡å·çš„æ—¶å€™ï¼Œå°±é˜»å¡ç­‰å¾…ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å‘é€äº†ä¿¡å·ï¼Œå°±å¼€å§‹æ‰§è¡Œçº¿ç¨‹é‡Œé¢çš„å†…å®¹



```c
#include <semaphore.h>  //å¤´æ–‡ä»¶ ç¼–è¯‘çš„æ—¶å€™é“¾æ¥ä¸€ä¸‹çº¿ç¨‹ -lpthread
sem_t pï¼›	//å®šä¹‰ä¸€ä¸ªä¿¡å·é‡
sem_init(&p,0,7);   //å¯ä»¥æ¶ˆè´¹çš„æ•°é‡ä¸º7,åˆå§‹åŒ–å°±å¯ä»¥æ¶ˆè´¹7ä¸ª  
sem_wait(&p); å¯ä»¥æ‰§è¡Œ7æ¬¡ï¼Œå› ä¸ºåˆå§‹åŒ–å€¼ä¸º7ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡ï¼Œä¿¡å·é‡å‰ªæ‰1ï¼Œå¦‚æœä¿¡å·é‡ä¸º0 ä¼šé˜»å¡ç­‰å¾…ä¿¡å·
sem_post(&p);	pçš„ä¿¡å·é‡åŠ 1 sem_wait(&p)å¯ä»¥æ‰§è¡Œäº†
```

![](allPic/Macdo2023-05-16 13.07.08.jpg)

![Macdo2023-05-16 13.10.48](allPic/Macdo2023-05-16 13.10.48.jpg)

![Macdo2023-05-16 13.12.10](allPic/Macdo2023-05-16 13.12.10.jpg)

![Macdo2023-05-16 13.12.52](allPic/Macdo2023-05-16 13.12.52.jpg)

![Macdo2023-05-16 13.13.54](allPic/Macdo2023-05-16 13.13.54.jpg)

![Macdo2023-05-16 13.15.23](allPic/Macdo2023-05-16 13.15.23.jpg)

#### å‡½æ•°ä»¬

**sem_init**

~~~c
`sem_init` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ï¼ˆsemaphoreï¼‰å¯¹è±¡ã€‚å®ƒçš„åŸå‹å¦‚ä¸‹ï¼š

```c
int sem_init(sem_t *sem, int pshared, unsigned int value);
```

å‡½æ•°å‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š

- `sem`ï¼šæŒ‡å‘è¦åˆå§‹åŒ–çš„ä¿¡å·é‡å¯¹è±¡çš„æŒ‡é’ˆã€‚
- `pshared`ï¼šæŒ‡å®šä¿¡å·é‡çš„å…±äº«æ–¹å¼ï¼Œå¯é€‰å€¼ä¸º0æˆ–é0ã€‚
  - è‹¥ä¸º0ï¼Œè¡¨ç¤ºä¿¡å·é‡åœ¨è¿›ç¨‹å†…çš„çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚
  - è‹¥é0ï¼Œè¡¨ç¤ºä¿¡å·é‡åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«ï¼Œæ­¤æ—¶éœ€è¦ä½¿ç”¨å…·åä¿¡å·é‡ï¼ˆnamed semaphoreï¼‰ã€‚
- `value`ï¼šæŒ‡å®šä¿¡å·é‡çš„åˆå§‹å€¼ã€‚

æˆåŠŸåˆå§‹åŒ–ä¿¡å·é‡åï¼Œ`sem` å°±å¯ä»¥ç”¨äºåç»­çš„ä¿¡å·é‡æ“ä½œï¼Œæ¯”å¦‚ç­‰å¾…ä¿¡å·é‡å’Œå‘é€ä¿¡å·é‡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`sem_init` å‡½æ•°åœ¨ä½¿ç”¨å‰éœ€è¦ä¿è¯ `sem` æŒ‡å‘çš„å†…å­˜ç©ºé—´å·²ç»åˆ†é…ï¼Œå¹¶ä¸”éœ€è¦é€‚å½“çš„æƒé™ä»¥æ‰§è¡Œè¯¥å‡½æ•°ã€‚åˆå§‹åŒ–çš„ä¿¡å·é‡åœ¨ä½¿ç”¨å®Œååº”è¯¥ä½¿ç”¨ `sem_destroy` å‡½æ•°è¿›è¡Œæ¸…ç†ã€‚

å¦‚æœåˆå§‹å€¼ä¸ºæ­£æ•°ï¼Œè¡¨ç¤ºå¯ç”¨èµ„æºçš„æ•°é‡ã€‚åœ¨æ¯æ¬¡æˆåŠŸæ‰§è¡Œ sem_wait æ“ä½œæ—¶ï¼Œä¿¡å·é‡çš„å€¼ä¼šé€’å‡ï¼Œè¡¨ç¤ºä½¿ç”¨äº†ä¸€ä¸ªèµ„æºã€‚è€Œåœ¨æ‰§è¡Œ sem_post æ“ä½œæ—¶ï¼Œä¿¡å·é‡çš„å€¼ä¼šé€’å¢ï¼Œè¡¨ç¤ºé‡Šæ”¾äº†ä¸€ä¸ªèµ„æºã€‚åˆå§‹å€¼ä¸ºæ­£æ•°æ—¶ï¼Œè¡¨ç¤ºåˆå§‹å¯ç”¨çš„èµ„æºæ•°é‡ã€‚
å¦‚æœåˆå§‹å€¼ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰å¯ç”¨çš„èµ„æºã€‚åœ¨æ‰§è¡Œ sem_wait æ“ä½œæ—¶ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼ä¸º0ï¼Œåˆ™çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œ sem_post æ“ä½œé‡Šæ”¾èµ„æºå¹¶ä½¿ä¿¡å·é‡çš„å€¼å¤§äº0ã€‚
å¦‚æœåˆå§‹å€¼ä¸ºè´Ÿæ•°ï¼Œè¡¨ç¤ºä¿¡å·é‡çš„å€¼ä¸ç­‰å¾…çº¿ç¨‹çš„æ•°é‡æœ‰å…³ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šå°†åˆå§‹å€¼è®¾ç½®ä¸ºè´Ÿæ•°ã€‚
~~~



##### ç¤ºèŒƒä»£ç 

```c
/**
 * ä¿¡å·é‡
 */
#include<pthread.h>
#include <t_stdio.h>
#include <unistd.h>
#include <time.h>
#include <semaphore.h>
#include <stdlib.h>



#define SIZE 7

//å®šä¹‰ä¸€ä¸ªæŒ‡é’ˆç±»å‹ ç›¸å½“äºæŠŠ int[size] è¿™ç§ç±»å‹é‡æ–°å‘½åä¸º que_t
typedef int que_t[SIZE]; 

que_t que; //å®šä¹‰é˜Ÿåˆ— ç›¸å½“äº int que[size];

sem_t p,c; //å®šä¹‰ä¿¡å·é‡ï¼Œç±»å‹çš„å˜é‡ï¼Œåˆ†åˆ«ç”¨äºç”Ÿäº§è€…(å¯ä»¥)å’Œæ¶ˆè´¹è€…ï¼Œ

void show(const char *who){
    printf("%s:[ ",who);
    for(int i=0;i<SIZE;i++)
        printf("%d\t",que[i]);
    //printf(" [p: %lld ],[c: %lld ]",p.__align,c.__align);
    printf("]\n");
}


void *product(void * arg){
    int index=0; int value;
    while(1){
        sleep(rand()%3+1);
        sem_wait(&p);               //å¦‚æœpçš„å€¼ç­‰äº0é˜»å¡ï¼Œå¦‚æœä¸ç­‰äº0;å‡å»1
        
        value=rand()%500;      //å‡è£…ç”Ÿäº§èµ‹å€¼
        que[index]=value;      //å‡è£…ç”Ÿäº§èµ‹å€¼
        show("p");
        printf("P:index =%d,value=%d\n",index,value);
        index= (index+1) % SIZE;    //æ›´æ–°ç´¢å¼•
        sem_post(&c);               //ç»™å¯ä»¥æ¶ˆè´¹çš„æ•°é‡åŠ 1
    }
    return NULL;
}

void *consume(void * arg){
    int index=0;
    int tmp;  //æ¶ˆè´¹çš„tmp
    while(1){
        show("c");
        sem_wait(&c);           //å¦‚æœcçš„å€¼ç­‰äº0ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¦‚æœä¸ç­‰äº0,å‡å»1 
        show("c2");
        tmp=que[index]; //å¾—åˆ°å€¼
        que[index]=-1;  //æŠŠæ¶ˆè´¹è¿‡çš„å€¼ç½®ä¸º-1; è¯´æ˜æ¶ˆè´¹è¿‡
        index=(index+1) %7;
       
        printf("c:index =%d,value=%d\n",index,tmp);
        sem_post(&p);  //å¯ä»¥ç”Ÿäº§çš„æ•°é‡+1  
        //sleep(rand() %3 +1);    
    }
    return NULL;
}

int main(){

    //åˆå§‹åŒ–ä¿¡å·é‡
    sem_init(&p,0,7);   //å¯ä»¥æ¶ˆè´¹çš„æ•°é‡ä¸º7,åˆå§‹åŒ–å°±å¯ä»¥æ¶ˆè´¹7ä¸ª
    sem_init(&c,0,0); //æ¶ˆè´¹çš„æ•°é‡é»˜è®¤è®¾ç½®ä¸º0 å¦‚æœæ²¡æœ‰post C è¯´æ˜sem_wait ä¸€ç›´é˜»å¡ç­‰å¾…

    srand(time(NULL));
    pthread_t pid,cid;

    pthread_create(&pid,NULL,product,NULL);
    pthread_create(&cid,NULL,consume,NULL);
    

    pthread_join(pid,NULL);
    pthread_join(cid,NULL);
    
    sem_destroy(&p);
    sem_destroy(&c);
    return 0;
}
```





##### ç¤ºèŒƒä»£ç gpt

****

ç¼–è¯‘åŠ ä¸Š -lpthread

```c
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <semaphore.h>

#define ARRAY_SIZE 10
#define NUM_THREADS 3

int global_array[ARRAY_SIZE];
sem_t semaphore;

void* thread_function(void* arg) {
    int thread_id = *(int*)arg;
    int i;

    for (i = 0; i < ARRAY_SIZE; i++) {
        // ç­‰å¾…ä¿¡å·é‡
        sem_wait(&semaphore);

        // ä¿®æ”¹å…¨å±€æ•°ç»„
        global_array[i] = thread_id;

        // å‘é€ä¿¡å·é‡
        sem_post(&semaphore);
    }

    pthread_exit(NULL);
}

int main() {
    pthread_t threads[NUM_THREADS];
    int thread_ids[NUM_THREADS];
    int i;

    // åˆå§‹åŒ–ä¿¡å·é‡
    sem_init(&semaphore, 0, 1);

    // åˆ›å»ºå¤šä¸ªçº¿ç¨‹
    for (i = 0; i < NUM_THREADS; i++) {
        thread_ids[i] = i;
        pthread_create(&threads[i], NULL, thread_function, &thread_ids[i]);
    }

    // ç­‰å¾…çº¿ç¨‹ç»“æŸ
    for (i = 0; i < NUM_THREADS; i++) {
        pthread_join(threads[i], NULL);
    }

    // æ‰“å°å…¨å±€æ•°ç»„çš„å€¼
    for (i = 0; i < ARRAY_SIZE; i++) {
        printf("%d ", global_array[i]);
    }
    printf("\n");

    // é”€æ¯ä¿¡å·é‡
    sem_destroy(&semaphore);

    return 0;
}

```


